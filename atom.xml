<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Rayâ€˜s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://pjpjsocute.github.io/"/>
  <updated>2025-08-19T22:00:00.000Z</updated>
  <id>http://pjpjsocute.github.io/</id>
  
  <author>
    <name>Ray zhou</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java Backend Interview Guide</title>
    <link href="http://pjpjsocute.github.io/2025/08/18/java_guide/java_guide/"/>
    <id>http://pjpjsocute.github.io/2025/08/18/java_guide/java_guide/</id>
    <published>2025-08-17T22:00:00.000Z</published>
    <updated>2025-08-19T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Java-Interview-Guide"><a href="#Java-Interview-Guide" class="headerlink" title="Java Interview Guide"></a>Java Interview Guide</h1><blockquote><p>è‡ªå·±åœ¨å‡†å¤‡æ¬§æ´²çš„é¢è¯•è¿‡ç¨‹å‘ç°ï¼Œå°½ç®¡æ¬§æ´²çš„é¢è¯•ç›¸å¯¹æ›´ç®€å•ï¼Œä½†æ˜¯ä»ç„¶ä¼šè¯¢é—®ä¸€äº›åŸºç¡€çš„å…«è‚¡æ–‡ï¼Œè€Œå›½å†…çš„é¢ç»è™½ç„¶æ›´å…¨é¢ï¼Œå¹¶ä¸”å¾€å¾€æ›´æ·±å±‚ï¼Œä½†æ˜¯å› ä¸ºæ˜¯ä¸­æ–‡çš„ï¼Œæ‰€ä»¥åœ¨è‡ªå·±å‡†å¤‡çš„æ—¶å€™è¿˜æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œå¹¶ä¸”2è¾¹çš„é—®é¢˜ä¾§é‡ç‚¹è¿˜æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘å°è¯•å¯¹è‡ªå·±è¿‡å»å­¦ä¹ åˆ°çš„ä»¥åŠé¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜è¿›è¡Œæ•´ç†å’Œå½’çº³ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°å„ä½åœ¨å‡†å¤‡è¿›è¡Œè‹±æ–‡é¢è¯•çš„æœ‹å‹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶åœ¨é˜…è¯»è¿‡ç¨‹ä¸­ç»™å‡ºè‡ªå·±çš„é—®é¢˜æˆ–è€…ä¹Ÿæä¾›ä¸€äº›è‡ªå·±æ›¾ç»é‡åˆ°çš„é—®é¢˜ï¼Œç¥å¤§å®¶é¢è¯•å¥½è¿ã€‚</p></blockquote><hr><h2 id="ğŸ“š-Table-of-Contents"><a href="#ğŸ“š-Table-of-Contents" class="headerlink" title="ğŸ“š Table of Contents"></a>ğŸ“š Table of Contents</h2><ul><li><strong>Java (Basic, Collection, Multi-thread, JVM)</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/java.html">Read Â»</a></li><li><strong>Spring &amp; Spring Cloud</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE//spring.html">Read Â»</a></li><li><strong>Databases</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/database.html">Read Â»</a></li><li><strong>Computer Networks</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/etwork.html">Read Â»</a></li><li><strong>Operating System</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/os.html">Read Â»</a></li><li><strong>Redis</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/redis.html">Read Â»</a></li><li><strong>Message Queue</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/mq.html">Read Â»</a></li><li><strong>Distributed System</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/ds.html">Read Â»</a></li></ul><hr><h2 id="ğŸŒ-Online-Reading"><a href="#ğŸŒ-Online-Reading" class="headerlink" title="ğŸŒ Online Reading"></a>ğŸŒ Online Reading</h2><p>This repository is published as a GitHub Pages site:<br><strong><a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/">ğŸ“– Open Online Version</a></strong></p><ul><li>Best for mobile/tablet reading</li></ul><hr><h2 id="ğŸ“…-Future-Plans"><a href="#ğŸ“…-Future-Plans" class="headerlink" title="ğŸ“… Future Plans"></a>ğŸ“… Future Plans</h2><ul><li>Add <strong>Design Patterns</strong> section</li><li>Add <strong>Elasticsearch</strong> and related tools</li><li>Continuous content updates  </li><li>Feedback and suggestions are welcome! ğŸ™Œ</li></ul><hr><h2 id="ğŸ“„-License"><a href="#ğŸ“„-License" class="headerlink" title="ğŸ“„ License"></a>ğŸ“„ License</h2><p><a href="LICENSE">Apache-2.0 License</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Java-Interview-Guide&quot;&gt;&lt;a href=&quot;#Java-Interview-Guide&quot; class=&quot;headerlink&quot; title=&quot;Java Interview Guide&quot;&gt;&lt;/a&gt;Java Interview Guide&lt;/h1&gt;&lt;
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="é¡¹ç›®" scheme="http://pjpjsocute.github.io/tags/%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="é¢è¯•" scheme="http://pjpjsocute.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)</title>
    <link href="http://pjpjsocute.github.io/2023/05/30/rpc/spring_rpc_III/"/>
    <id>http://pjpjsocute.github.io/2023/05/30/rpc/spring_rpc_III/</id>
    <published>2023-05-29T22:00:00.000Z</published>
    <updated>2023-05-29T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)</h1><p><img src="/2023/05/30/rpc/spring_rpc_III/image-20230522163034434.png" alt="image-20230522163034434"></p><p>ç»§ç»­ä¸Šä¸€ç« ï¼Œåœ¨å®ç°äº†æœåŠ¡ç«¯æ³¨å†Œå’Œè°ƒç”¨ä¹‹åï¼Œéœ€è¦æ¥å®ç°å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬è´Ÿè½½å‡è¡¡ï¼Œé™æµï¼Œè¯·æ±‚å‘é€å’ŒæœåŠ¡å‘ç°ä¸Šã€‚æ¥ä¸‹æ¥å°†ä»ä¸€ä¸ªRPCè°ƒç”¨æµç¨‹çš„é¡ºåºæ¥å®ç°æ¥ä¸‹æ¥çš„åŠŸèƒ½</p><h3 id="ä¸€æ¬¡è¯·æ±‚ï¼š"><a href="#ä¸€æ¬¡è¯·æ±‚ï¼š" class="headerlink" title="ä¸€æ¬¡è¯·æ±‚ï¼š"></a>ä¸€æ¬¡è¯·æ±‚ï¼š</h3><p>â€‹            å®ç°å®¢æˆ·ç«¯ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æƒ³æ¸…æ¥šä¸€æ¬¡è¯·æ±‚éœ€è¦å‘é€äº›ä»€ä¹ˆã€‚</p><p>â€‹             é¦–å…ˆï¼Œéœ€è¦å½“å‰çš„æœåŠ¡åæ–¹æ³•åï¼Œä»¥åŠå¯¹åº”çš„å‚æ•°å’Œå‚æ•°ç±»å‹ï¼Œå¦åˆ™æœåŠ¡ç«¯æ— æ³•æ ¹æ®è¯·æ±‚æ¥è¿›è¡Œå¯¹åº”çš„åå°„è°ƒç”¨ã€‚</p><p>â€‹            å…¶æ¬¡ï¼Œè¯·æ±‚ä¸­åº”è¯¥è¦å¸¦ä¸Š@RpcConsumerå†…çš„å‚æ•°ï¼Œè®©æœåŠ¡ç«¯èƒ½å¤Ÿæ‰¾åˆ°æ­£ç¡®çš„æœåŠ¡ã€‚</p><p>â€‹            æœ€åï¼Œè¯·æ±‚ä¸­åº”è¯¥å¸¦ä¸Šæœ¬æ¬¡è¯·æ±‚çš„ä¸€ä¸ªå”¯ä¸€å€¼ï¼Œä»¥æ–¹ä¾¿é“¾è·¯è¿½è¸ªã€‚</p><p>â€‹            è‡³æ­¤ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦çš„åŸºæœ¬å‚æ•°å·²ç»å®Œæˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8509587559718339795L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * traceId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            traceId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * interface name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            serviceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            methodName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[]          parameters;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameter types</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[]        paramTypes;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            project;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String            group;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be</span></span><br><span class="line"><span class="comment">     * split to get the service name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getGroup() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getServiceName() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡ä»£ç†"><a href="#æœåŠ¡ä»£ç†" class="headerlink" title="æœåŠ¡ä»£ç†"></a>æœåŠ¡ä»£ç†</h3><p>â€‹        ç¬¬ä¸€æ­¥ï¼Œåœ¨springå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œæ‰«ææ‰€æœ‰å¸¦æœ‰@RpcConsumer ä¸ºå…¶ç”Ÿæˆä»£ç†ï¼Œåç»­è°ƒç”¨åˆ°è¯¥ç±»æ–¹æ³•çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ä»£ç†çš„æ–¹æ³•ï¼Œå‘èµ·è¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter  sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = ExtensionLoader.getExtensionLoader(RpcSendingServiceAdapter.class)</span><br><span class="line">            .getExtension(RpcRequestSendingEnum.NETTY.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start process register service: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">        <span class="comment">// register service</span></span><br><span class="line">        <span class="keyword">if</span> (bean.getClass().isAnnotationPresent(RpcProvider.class)) &#123;</span><br><span class="line">            <span class="type">RpcProvider</span> <span class="variable">annotation</span> <span class="operator">=</span> bean.getClass().getAnnotation(RpcProvider.class);</span><br><span class="line">            <span class="comment">// build rpc service config</span></span><br><span class="line">            <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                .service(bean)</span><br><span class="line">                .project(annotation.project())</span><br><span class="line">                .version(annotation.version())</span><br><span class="line">                .group(annotation.group())</span><br><span class="line">                .build();</span><br><span class="line">            LogUtil.info(<span class="string">&quot;register service: &#123;&#125;&quot;</span>, serviceConfig);</span><br><span class="line">            adapter.registryService(serviceConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * proxy and injection of consumers</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        Class&lt;?&gt; toBeProcessedBean = bean.getClass();</span><br><span class="line">        Field[] declaredFields = toBeProcessedBean.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field declaredField : declaredFields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredField.isAnnotationPresent(RpcConsumer.class)) &#123;</span><br><span class="line">                <span class="type">RpcConsumer</span> <span class="variable">annotation</span> <span class="operator">=</span> declaredField.getAnnotation(RpcConsumer.class);</span><br><span class="line">                <span class="comment">// build rpc service config</span></span><br><span class="line">                <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                    .project(annotation.project())</span><br><span class="line">                    .version(annotation.version())</span><br><span class="line">                    .group(annotation.group())</span><br><span class="line">                    .build();</span><br><span class="line">                <span class="comment">// create the proxy bean Factory and the proxy bean</span></span><br><span class="line">                <span class="type">RpcServiceProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcServiceProxy</span>(sendingServiceAdapter, serviceConfig);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">rpcProxy</span> <span class="operator">=</span> proxy.getProxy(declaredField.getType());</span><br><span class="line">                declaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LogUtil.info(<span class="string">&quot;create service proxy: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">                    declaredField.set(bean, rpcProxy);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯åœ¨ä»£ç†ç±»çš„invokeæ–¹æ³•ä¸­å®ç°å¯¹requestçš„æ‹¼è£…å’Œè°ƒç”¨ã€‚åŒæ—¶è·å–Futureä¸­çš„å“åº”å€¼è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceConfig         config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcServiceProxy</span><span class="params">(RpcSendingServiceAdapter sendingServiceAdapter, RpcServiceConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = sendingServiceAdapter;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;invoked method: [&#123;&#125;]&quot;</span>, method.getName());</span><br><span class="line">        <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> buildRequest(method,args);</span><br><span class="line"></span><br><span class="line">        RpcResponse&lt;Object&gt; rpcResponse = <span class="literal">null</span>;</span><br><span class="line">        CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; completableFuture =</span><br><span class="line">            (CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt;)sendingServiceAdapter.sendRpcRequest(rpcRequest);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rpcResponse = completableFuture.get();</span><br><span class="line">            <span class="keyword">return</span> rpcResponse.getData();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the proxy object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T)Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123;clazz&#125;, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> RpcRequest <span class="title function_">buildRequest</span><span class="params">(Method method,Object[] args)</span>&#123;</span><br><span class="line">         <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> RpcRequest.builder()</span><br><span class="line">                 .methodName(method.getName())</span><br><span class="line">                 .parameters(args)</span><br><span class="line">                 .serviceName(method.getDeclaringClass().getName())</span><br><span class="line">                 .paramTypes(method.getParameterTypes())</span><br><span class="line">                 .traceId(UUID.randomUUID().toString())</span><br><span class="line">                 .project(config.getProject())</span><br><span class="line">                 .version(config.getVersion())</span><br><span class="line">                 .group(config.getGroup())</span><br><span class="line">                 .build();</span><br><span class="line">        <span class="keyword">return</span> rpcRequest;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘é€è¯·æ±‚ï¼š"><a href="#å‘é€è¯·æ±‚ï¼š" class="headerlink" title="å‘é€è¯·æ±‚ï¼š"></a>å‘é€è¯·æ±‚ï¼š</h3><p>â€‹        å®¢æˆ·ç«¯çš„æ ¸å¿ƒæ–¹æ³•ä¸ºå‘é€è¯·æ±‚ï¼Œè¯·æ±‚çš„å‘é€æœ‰å¤šç§æ–¹æ³•ï¼Œè¿™é‡Œä»…åŸºäºnettyçš„Nioè¿›è¡Œäº†å®ç°ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ—¶åºã€‚</p><p><img src="/2023/05/30/rpc/spring_rpc_III/WX20230530-145829@2x.png" alt="WX20230530-145829@2x"></p><p>â€‹        é¦–å…ˆå®ç°å‘é€æ–¹æ³•ï¼Œé‡Œé¢åº”è¯¥åŒ…å«å¯»æ‰¾åœ°å€ï¼Œå‘é€è¯·æ±‚çš„åŠŸèƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcSendingServiceAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcSendingServiceAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EventLoopGroup is a multithreaded event loop that handles I/O operation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup             eventLoopGroup;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bootstrap helt setting and start netty client</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bootstrap                  bootstrap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service discovery</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceFindingAdapter   findingAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Channel manager,mapping channel and address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AddressChannelManager      addressChannelManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Waiting process request queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitingProcessRequestQueue waitingProcessRequestQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcSendingServiceAdapterImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.findingAdapter = ExtensionLoader.getExtensionLoader(RpcServiceFindingAdapter.class)</span><br><span class="line">            .getExtension(ServiceDiscoveryEnum.ZK.getName());</span><br><span class="line">        <span class="built_in">this</span>.addressChannelManager = SingletonFactory.getInstance(AddressChannelManager.class);</span><br><span class="line">        <span class="built_in">this</span>.waitingProcessRequestQueue = SingletonFactory.getInstance(WaitingProcessRequestQueue.class);</span><br><span class="line">        <span class="comment">// initialize</span></span><br><span class="line">        eventLoopGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        bootstrap = <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.group(eventLoopGroup)</span><br><span class="line">            .channel(NioSocketChannel.class)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">            <span class="comment">// The timeout period for the connection.</span></span><br><span class="line">            <span class="comment">// If this time is exceeded or if the connection cannot be</span></span><br><span class="line">            <span class="comment">// established, the connection fails.</span></span><br><span class="line">            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">5000</span>)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                    <span class="comment">// If no data is sent to the server within 15 seconds, a</span></span><br><span class="line">                    <span class="comment">// heartbeat request is sent</span></span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, TimeUnit.SECONDS));</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageEncoder</span>());</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageDecoder</span>());</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">NettyRpcClientHandler</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">sendRpcRequest</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> findServiceAddress(rpcRequest);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> fetchAndConnectChannel(address);</span><br><span class="line">        <span class="keyword">if</span> (channel.isActive()) &#123;</span><br><span class="line">            addToProcessQueue(rpcRequest.getTraceId(), result);</span><br><span class="line">            <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> prepareRpcData(rpcRequest);</span><br><span class="line">            sendRpcData(channel, rpcData, result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Send request[&#123;&#125;] failed&quot;</span>, rpcRequest);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> InetSocketAddress <span class="title function_">findServiceAddress</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> findingAdapter.findServiceAddress(rpcRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToProcessQueue</span><span class="params">(String traceId, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">        waitingProcessRequestQueue.put(traceId, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">prepareRpcData</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">                .data(rpcRequest)</span><br><span class="line">                .serializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode())</span><br><span class="line">                .compressType(CompressTypeEnum.GZIP.getCode())</span><br><span class="line">                .messageType(RpcConstants.REQUEST_TYPE)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRpcData</span><span class="params">(Channel channel, RpcData rpcData, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">        channel.writeAndFlush(rpcData).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;client send message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                future.channel().close();</span><br><span class="line">                result.completeExceptionally(future.cause());</span><br><span class="line">                LogUtil.error(<span class="string">&quot;Send failed:&quot;</span>, future.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel <span class="title function_">fetchAndConnectChannel</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(address);</span><br><span class="line">        <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// connect to service to get new address and rebuild the channel</span></span><br><span class="line">            channel = connect(address);</span><br><span class="line">            addressChannelManager.set(address, channel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel <span class="title function_">connect</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;Channel&gt; completableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        bootstrap.connect(address).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                <span class="comment">// set channel to future</span></span><br><span class="line">                LogUtil.info(<span class="string">&quot;The client has connected [&#123;&#125;] successful!&quot;</span>, address.toString());</span><br><span class="line">                completableFuture.complete(future.channel());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LogUtil.error(<span class="string">&quot;The client failed to connect to the server [&#123;&#125;],future&quot;</span>, address.toString(), future);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = completableFuture.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when connect to server:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Channel <span class="title function_">getChannel</span><span class="params">(InetSocketAddress inetSocketAddress)</span> &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(inetSocketAddress);</span><br><span class="line">        <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">            channel = connect(inetSocketAddress);</span><br><span class="line">            addressChannelManager.set(inetSocketAddress, channel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ ¸å¿ƒçš„æ–¹æ³•æ˜¯sendRpcRequest,ä»–è´Ÿè´£è·å–æœåŠ¡ï¼Œåˆ›å»ºé“¾æ¥ï¼Œåˆ›å»ºä¸€ä¸ªFutureä»»åŠ¡ï¼Œå¹¶ä¸”å‘é€è¯·æ±‚ã€‚</p><h4 id="å‘ç°æœåŠ¡"><a href="#å‘ç°æœåŠ¡" class="headerlink" title="å‘ç°æœåŠ¡"></a>å‘ç°æœåŠ¡</h4><p>å‘ç°æœåŠ¡çš„æµç¨‹å¯ä»¥åŒ…æ‹¬ï¼š</p><p>1.ä»æ³¨å†Œä¸­å¿ƒä¸­æ‹‰å–æœåŠ¡åœ°å€åˆ—è¡¨</p><p>2.é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•è·å–æœåŠ¡å…·ä½“ç±»å‹ã€‚</p><h5 id="è·å–åœ°å€"><a href="#è·å–åœ°å€" class="headerlink" title="è·å–åœ°å€"></a>è·å–åœ°å€</h5><p>ä¸‹é¢å…ˆå®ç°ç¬¬ä¸€æ­¥ï¼ˆæ­¤å¤„å¯ä»¥ä½¿ç”¨ç¼“å­˜è¿›è¡Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œæœ¬é¡¹ç›®ä¸­çš„zkä½¿ç”¨äº†ä¸€ä¸ªConcurrentHashMapæ¥ä»£æ›¿ç¼“å­˜ï¼Œè¯¦ç»†ä»£ç å¯ä»¥è§CuratorClientï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceFindingAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcServiceFindingAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalanceService loadBalanceService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcServiceFindingAdapterImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loadBalanceService = ExtensionLoader.getExtensionLoader(LoadBalanceService.class).getExtension(LOAD_BALANCE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InetSocketAddress <span class="title function_">findServiceAddress</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> rpcRequest.fetchRpcServiceName();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">zkClient</span> <span class="operator">=</span> CuratorClient.getZkClient();</span><br><span class="line">        List&lt;String&gt; serviceAddresseList = CuratorClient.getChildrenNodes(zkClient, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(serviceAddresseList)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;no service available, serviceName: &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> loadBalanceService.selectServiceAddress(serviceAddresseList, rpcRequest);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(service)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;no service available, serviceName: &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] socketAddressArray = service.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> socketAddressArray[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(socketAddressArray[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h5><h6 id="å®šä¹‰ï¼š"><a href="#å®šä¹‰ï¼š" class="headerlink" title="å®šä¹‰ï¼š"></a>å®šä¹‰ï¼š</h6><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯ä¸€ç§ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡çš„ç®—æ³•ã€‚å®ƒé€šè¿‡å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹å’Œå“ˆå¸Œç¯çš„æ¦‚å¿µï¼Œå®ç°äº†èŠ‚ç‚¹çš„åŠ¨æ€æ‰©ç¼©å®¹æ—¶æœ€å°åŒ–æ•°æ®è¿ç§»çš„éœ€æ±‚ï¼Œæé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚å®ƒåœ¨åˆ†å¸ƒå¼ç¼“å­˜ã€è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ä¸­è¢«å¹¿æ³›åº”ç”¨ã€‚</p><h6 id="å®ç°ï¼š"><a href="#å®ç°ï¼š" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h6><p>å“ˆå¸Œå€¼è®¡ç®—</p><p>é¦–å…ˆï¼Œæ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æˆ‘ä»¬éœ€è¦æœ‰æ ¹æ®å¯¹åº”çš„æœåŠ¡ç”Ÿæˆå“ˆå¸Œå€¼ã€‚åœ¨ä»¥ä¸‹å®ç°ä¸­ï¼Œé¦–å…ˆå°†è¾“å…¥é€šè¿‡SHA-256ç®—æ³•äº§ç”Ÿä¸€ä¸ª32å­—èŠ‚ï¼ˆ256ä½ï¼‰çš„å“ˆå¸Œå€¼</p><p>ä½†æ˜¯è¿™æ ·çš„å“ˆå¸Œå€¼è¿‡é•¿ï¼Œå¹¶ä¸æ–¹ä¾¿å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»–è¿›è¡Œç¼©çŸ­ã€‚åŒæ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ˜ å°„å¤šä¸ªå“ˆå¸Œå¯ä»¥æé«˜ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„åˆ†å¸ƒå‡åŒ€æ€§ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šåœ¨å“ˆå¸Œç©ºé—´ä¸­æ‹¥æœ‰å¤šä¸ªå“ˆå¸Œå€¼ï¼Œè¿™å¯ä»¥å¸®åŠ©å‡å°‘å› èŠ‚ç‚¹å¢åŠ æˆ–å‡å°‘è€Œå¯¼è‡´çš„å“ˆå¸Œç©ºé—´é‡åˆ†å¸ƒçš„å½±å“ã€‚</p><p>calculateHash ä¼šå¯¹å·²ç»å¾—åˆ°çš„256ä¸ºå“ˆå¸Œå€¼ä»èµ·ç‚¹jå¼€å§‹å‘åå–8å­—èŠ‚ç”Ÿæˆä¸€ä¸ªæ–°çš„Longç±»å‹çš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">byte</span>[] md5Hash(String input) &#123;</span><br><span class="line">    <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        messageDigest = MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] hashBytes = messageDigest.digest(input.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        messageDigest.update(hashBytes);</span><br><span class="line">        <span class="keyword">return</span> messageDigest.digest();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;No such algorithm exception: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Long <span class="title function_">calculateHash</span><span class="params">(<span class="type">byte</span>[] digest, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (digest.length &lt; (idx + <span class="number">1</span>) * <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Insufficient length of digest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 8 bytes digest,a byte is 8 bits like :1321 2432</span></span><br><span class="line">    <span class="comment">// each loop choose a byte to calculate hash,and shift i*8 bits</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        hash |= (<span class="number">255L</span> &amp; (<span class="type">long</span>)digest[i + idx * <span class="number">8</span>]) &lt;&lt; (<span class="number">8</span> * i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹é€‰æ‹©å™¨ã€‚</p><p>æ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„å®šä¹‰ï¼Œä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹é€‰æ‹©å™¨éœ€è¦å°†æœåŠ¡ç”Ÿæˆå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†æ¯ä¸ªèŠ‚ç‚¹æ˜ å°„ä¸ºå¤šä¸ªå“ˆå¸Œå€¼ï¼Œæœ€åæ ¹æ®ä¼ å…¥çš„å“ˆå¸Œå€¼è·å–æœ€è¿‘çš„èŠ‚ç‚¹è¿”å›ç»™è°ƒç”¨è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span> &#123;</span><br><span class="line">        <span class="comment">// hash to virtual node list</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, String&gt; virtualInvokers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ConsistentHashLoadBalanceSelector</span><span class="params">(List&lt;String&gt; serviceUrlList, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.virtualInvokers = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// generate service address virtual node]</span></span><br><span class="line">            <span class="comment">// one address may map to multiple virtual nodes</span></span><br><span class="line">            <span class="comment">// use the md5 hash algorithm to generate the hash value of the</span></span><br><span class="line">            <span class="comment">// virtual node</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;init add serviceUrlList:&#123;&#125;&quot;</span>, serviceUrlList);</span><br><span class="line">            <span class="keyword">for</span> (String serviceNode : serviceUrlList) &#123;</span><br><span class="line">                addVirtualNode(serviceNode, virtualNodeNumber);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addVirtualNode</span><span class="params">(String serviceNode, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodeNumber / <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> serviceNode + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">byte</span>[] md5Hash = md5Hash(virtualNodeName);</span><br><span class="line">                <span class="comment">// md5Hash have 32 bytes</span></span><br><span class="line">                <span class="comment">// use 8 byte for each virtual node</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">hash</span> <span class="operator">=</span> calculateHash(md5Hash, j);</span><br><span class="line">                    virtualInvokers.put(hash, serviceNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">select</span><span class="params">(String rpcServiceKey)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] digest = md5Hash(rpcServiceKey);</span><br><span class="line">            <span class="comment">// use first 8 byte to get hash</span></span><br><span class="line">            <span class="keyword">return</span> selectForKey(calculateHash(digest, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">selectForKey</span><span class="params">(<span class="type">long</span> hashCode)</span> &#123;</span><br><span class="line">            Map.Entry&lt;Long, String&gt; entry = virtualInvokers.tailMap(hashCode, <span class="literal">true</span>).firstEntry();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">                entry = virtualInvokers.firstEntry();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®ç°å®Œæ•´è´Ÿè½½å‡è¡¡æ–¹æ³•</p><p>å°†æ¥å£åå’Œå¯ç”¨æœåŠ¡åˆ—è¡¨çš„å“ˆå¸Œä½œä¸ºkeyï¼Œç¼“å­˜å¯¹åº”çš„ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©å™¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥ä»å·²æœ‰çš„å“ˆå¸Œé€‰æ‹©å™¨ä¸­è·å¾—ä¸€ä¸ªè´Ÿè½½èŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceService</span> <span class="keyword">implements</span> <span class="title class_">LoadBalanceService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ConsistentHashLoadBalanceSelector&gt; serviceToSelectorMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span> &#123;</span><br><span class="line">        <span class="comment">// hash to virtual node list</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, String&gt; virtualInvokers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ConsistentHashLoadBalanceSelector</span><span class="params">(List&lt;String&gt; serviceUrlList, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.virtualInvokers = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// generate service address virtual node]</span></span><br><span class="line">            <span class="comment">// one address may map to multiple virtual nodes</span></span><br><span class="line">            <span class="comment">// use the md5 hash algorithm to generate the hash value of the</span></span><br><span class="line">            <span class="comment">// virtual node</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;init add serviceUrlList:&#123;&#125;&quot;</span>, serviceUrlList);</span><br><span class="line">            <span class="keyword">for</span> (String serviceNode : serviceUrlList) &#123;</span><br><span class="line">                addVirtualNode(serviceNode, virtualNodeNumber);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addVirtualNode</span><span class="params">(String serviceNode, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodeNumber / <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> serviceNode + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">byte</span>[] md5Hash = md5Hash(virtualNodeName);</span><br><span class="line">                <span class="comment">// md5Hash have 32 bytes</span></span><br><span class="line">                <span class="comment">// use 8 byte for each virtual node</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">hash</span> <span class="operator">=</span> calculateHash(md5Hash, j);</span><br><span class="line">                    virtualInvokers.put(hash, serviceNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">select</span><span class="params">(String rpcServiceKey)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] digest = md5Hash(rpcServiceKey);</span><br><span class="line">            <span class="comment">// use first 8 byte to get hash</span></span><br><span class="line">            <span class="keyword">return</span> selectForKey(calculateHash(digest, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">selectForKey</span><span class="params">(<span class="type">long</span> hashCode)</span> &#123;</span><br><span class="line">            Map.Entry&lt;Long, String&gt; entry = virtualInvokers.tailMap(hashCode, <span class="literal">true</span>).firstEntry();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">                entry = virtualInvokers.firstEntry();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">byte</span>[] md5Hash(String input) &#123;</span><br><span class="line">        <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            messageDigest = MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] hashBytes = messageDigest.digest(input.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            messageDigest.update(hashBytes);</span><br><span class="line">            <span class="keyword">return</span> messageDigest.digest();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;No such algorithm exception: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Long <span class="title function_">calculateHash</span><span class="params">(<span class="type">byte</span>[] digest, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (digest.length &lt; (idx + <span class="number">1</span>) * <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Insufficient length of digest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 8 bytes digest,a byte is 8 bits like :1321 2432</span></span><br><span class="line">        <span class="comment">// each loop choose a byte to calculate hash,and shift i*8 bits</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            hash |= (<span class="number">255L</span> &amp; (<span class="type">long</span>)digest[i + idx * <span class="number">8</span>]) &lt;&lt; (<span class="number">8</span> * i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Choose one from the list of existing service addresses list</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceUrlList Service address list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectServiceAddress</span><span class="params">(List&lt;String&gt; serviceUrlList, RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">serviceListHash</span> <span class="operator">=</span> System.identityHashCode(serviceUrlList);</span><br><span class="line">        <span class="type">String</span> <span class="variable">interfaceName</span> <span class="operator">=</span> rpcRequest.getServiceName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">selectorKey</span> <span class="operator">=</span> interfaceName + serviceListHash;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConsistentHashLoadBalanceSelector</span> <span class="variable">consistentHashLoadBalanceSelector</span> <span class="operator">=</span> serviceToSelectorMap</span><br><span class="line">            .computeIfAbsent(selectorKey, key -&gt; <span class="keyword">new</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span>(serviceUrlList, VIRTUAL_NODES));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> consistentHashLoadBalanceSelector.select(interfaceName + Arrays.stream(rpcRequest.getParameters()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‘é€è¯·æ±‚"><a href="#å‘é€è¯·æ±‚" class="headerlink" title="å‘é€è¯·æ±‚"></a>å‘é€è¯·æ±‚</h4><h5 id="å‘é€è¯·æ±‚-1"><a href="#å‘é€è¯·æ±‚-1" class="headerlink" title="å‘é€è¯·æ±‚"></a>å‘é€è¯·æ±‚</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">sendRpcRequest</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">      CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">      <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> findServiceAddress(rpcRequest);</span><br><span class="line">      <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> fetchAndConnectChannel(address);</span><br><span class="line">      <span class="keyword">if</span> (channel.isActive()) &#123;</span><br><span class="line">          addToProcessQueue(rpcRequest.getTraceId(), result);</span><br><span class="line">          <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> prepareRpcData(rpcRequest);</span><br><span class="line">          sendRpcData(channel, rpcData, result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.error(<span class="string">&quot;Send request[&#123;&#125;] failed&quot;</span>, rpcRequest);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToProcessQueue</span><span class="params">(String traceId, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">          waitingProcessRequestQueue.put(traceId, result);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RpcData <span class="title function_">prepareRpcData</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">              .data(rpcRequest)</span><br><span class="line">              .serializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode())</span><br><span class="line">              .compressType(CompressTypeEnum.GZIP.getCode())</span><br><span class="line">              .messageType(RpcConstants.REQUEST_TYPE)</span><br><span class="line">              .build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRpcData</span><span class="params">(Channel channel, RpcData rpcData, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">      channel.writeAndFlush(rpcData).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">              LogUtil.info(<span class="string">&quot;client send message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              future.channel().close();</span><br><span class="line">              result.completeExceptionally(future.cause());</span><br><span class="line">              LogUtil.error(<span class="string">&quot;Send failed:&quot;</span>, future.cause());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨"><a href="#ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨"></a>ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Channel <span class="title function_">fetchAndConnectChannel</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(address);</span><br><span class="line">    <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// connect to service to get new address and rebuild the channel</span></span><br><span class="line">        channel = connect(address);</span><br><span class="line">        addressChannelManager.set(address, channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Channel <span class="title function_">connect</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;Channel&gt; completableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    bootstrap.connect(address).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">            <span class="comment">// set channel to future</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;The client has connected [&#123;&#125;] successful!&quot;</span>, address.toString());</span><br><span class="line">            completableFuture.complete(future.channel());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;The client failed to connect to the server [&#123;&#125;],future&quot;</span>, address.toString(), future);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel = completableFuture.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;occur exception when connect to server:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†"><a href="#Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†" class="headerlink" title="Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†"></a>Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapterImpl adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitingProcessRequestQueue   waitingProcessRequestQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyRpcClientHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcSendingServiceAdapterImpl.class);</span><br><span class="line">        <span class="built_in">this</span>.waitingProcessRequestQueue = SingletonFactory.getInstance(WaitingProcessRequestQueue.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * heart beat handle</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// if the channel is freeï¼Œclose it</span></span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="type">IdleState</span> <span class="variable">state</span> <span class="operator">=</span> ((IdleStateEvent)evt).state();</span><br><span class="line">            <span class="keyword">if</span> (state == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;write idle happen [&#123;&#125;]&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">                <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> adapter.getChannel((InetSocketAddress)ctx.channel().remoteAddress());</span><br><span class="line">                <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">                rpcData.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">                rpcData.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">                rpcData.setMessageType(RpcConstants.HEARTBEAT_REQUEST_TYPE);</span><br><span class="line">                rpcData.setData(RpcConstants.PING);</span><br><span class="line">                channel.writeAndFlush(rpcData).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when an exception occurs in processing a client message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;server exceptionCaught&quot;</span>);</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Client receive message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">        setupRpcMessage(rpcMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcData.isHeartBeatResponse()) &#123;</span><br><span class="line">            LogUtil.info(<span class="string">&quot;heart [&#123;&#125;]&quot;</span>, rpcMessage.getData());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rpcData.isResponse()) &#123;</span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = (RpcResponse&lt;Object&gt;)rpcData.getData();</span><br><span class="line">            waitingProcessRequestQueue.complete(rpcResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupRpcMessage</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">        rpcMessage.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰&quot;&gt;&lt;a href=&quot;#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰&quot; class=&quot;headerlink&quot; title=&quot;åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)&quot;&gt;&lt;/a&gt;åŸºäºsp
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="é¡¹ç›®" scheme="http://pjpjsocute.github.io/tags/%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="spi" scheme="http://pjpjsocute.github.io/tags/spi/"/>
    
      <category term="rpc" scheme="http://pjpjsocute.github.io/tags/rpc/"/>
    
  </entry>
  
  <entry>
    <title>java spi åº”ç”¨</title>
    <link href="http://pjpjsocute.github.io/2023/05/22/rpc/spi/"/>
    <id>http://pjpjsocute.github.io/2023/05/22/rpc/spi/</id>
    <published>2023-05-21T22:00:00.000Z</published>
    <updated>2023-07-09T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="java-spi-åº”ç”¨"><a href="#java-spi-åº”ç”¨" class="headerlink" title="java spi åº”ç”¨"></a>java spi åº”ç”¨</h1><h2 id="Spi-å®šä¹‰"><a href="#Spi-å®šä¹‰" class="headerlink" title="Spi å®šä¹‰"></a>Spi å®šä¹‰</h2><p>åœ¨Javaä¸­ï¼ŒSPIä»£è¡¨Service Provider Interfaceï¼ˆæœåŠ¡æä¾›è€…æ¥å£ï¼‰ã€‚SPIæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå…è®¸åº”ç”¨ç¨‹åºé€šè¿‡åœ¨ç±»è·¯å¾„ä¸­å‘ç°å’ŒåŠ è½½å¯æ’æ‹”çš„ç»„ä»¶æˆ–æœåŠ¡æä¾›è€…æ¥æ‰©å±•å…¶åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€ç§æ¾è€¦åˆçš„æ–¹å¼ï¼Œå…è®¸å¼€å‘äººå‘˜ç¼–å†™å¯ä»¥ä¸å¤šä¸ªå®ç°è¿›è¡Œäº¤äº’çš„ä»£ç ï¼Œè€Œæ— éœ€æ˜¾å¼åœ°å¼•ç”¨ç‰¹å®šçš„å®ç°ç±»ã€‚</p><h2 id="Apiä¸SpiåŒºåˆ«"><a href="#Apiä¸SpiåŒºåˆ«" class="headerlink" title="Apiä¸SpiåŒºåˆ«"></a>Apiä¸SpiåŒºåˆ«</h2><p>APIæ˜¯ç”¨äºå®šä¹‰è½¯ä»¶ç»„ä»¶ä¹‹é—´çš„äº¤äº’è§„åˆ™å’Œçº¦å®šï¼Œè€ŒSPIæ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå®ç°å¯æ’æ‹”çš„ç»„ä»¶æˆ–æœåŠ¡çš„æ‰©å±•æ€§ã€‚</p><p>APIç”¨äºæš´éœ²åŠŸèƒ½å’ŒåŠŸèƒ½ï¼Œä¾›å…¶ä»–å¼€å‘äººå‘˜ä½¿ç”¨å’Œé›†æˆï¼Œè€ŒSPIç”¨äºåŠ¨æ€åŠ è½½å’Œä½¿ç”¨å¯æ›¿æ¢çš„ç»„ä»¶å®ç°ã€‚</p><p>APIæ˜¯é¢å‘å¼€å‘äººå‘˜çš„ï¼Œæä¾›äº†ç¼–ç¨‹æ¥å£å’Œæ–‡æ¡£ï¼Œä»¥ä¾¿æ­£ç¡®ä½¿ç”¨å’Œé›†æˆè½¯ä»¶ç»„ä»¶ã€‚SPIæ˜¯é¢å‘å¼€å‘äººå‘˜å’Œæ¡†æ¶/åº”ç”¨ç¨‹åºçš„ï¼Œç”¨äºæ‰©å±•æ¡†æ¶æˆ–åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚</p><p>APIæ˜¯è¢«è°ƒç”¨æ–¹å®šä¹‰çš„ï¼Œå®ƒè§„å®šäº†è°ƒç”¨æ–¹å¼å’Œå‚æ•°ã€‚SPIæ˜¯è°ƒç”¨æ–¹å®šä¹‰çš„ï¼Œå®ƒå…è®¸è¢«è°ƒç”¨æ–¹æä¾›å®ç°ã€‚</p><h2 id="Spiæœºåˆ¶"><a href="#Spiæœºåˆ¶" class="headerlink" title="Spiæœºåˆ¶"></a>Spiæœºåˆ¶</h2><p><img src="/2023/05/22/rpc/spi/WX20230605-150555@2x.png" alt="WX20230605-150555@2x"></p><h2 id="å®ç°è¿‡ç¨‹"><a href="#å®ç°è¿‡ç¨‹" class="headerlink" title="å®ç°è¿‡ç¨‹"></a>å®ç°è¿‡ç¨‹</h2><p><img src="/2023/05/22/rpc/spi/WX20230605-151041@2x.png" alt="WX20230605-151041@2x"></p><h2 id="åœ¨Rpcä¸­çš„å®ç°"><a href="#åœ¨Rpcä¸­çš„å®ç°" class="headerlink" title="åœ¨Rpcä¸­çš„å®ç°"></a>åœ¨Rpcä¸­çš„å®ç°</h2><p>â€‹    åœ¨<a href="https://github.com/pjpjsocute/rpc-service">ç®€å•çš„RPCæ¡†æ¶å®ç°</a>ä¸­åŸºäºDubboå®ç°äº†ä¸€ä¸ªåŸºäºæ³¨è§£çš„SPIæœºåˆ¶ï¼Œè¿™é‡Œå°†ç®€å•ä»‹ç»ä¸‹åŸç†ã€‚</p><h3 id="å®ç°ï¼š"><a href="#å®ç°ï¼š" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>å®šä¹‰ä¸€ä¸ªSPIæ³¨è§£ï¼Œç”¨äºæ ‡æ³¨æ‰€æœ‰éœ€è¦è¿›è¡ŒSPIæ³¨å†Œçš„æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡ï¼Œç”±äºä¸ºäº†é˜²æ­¢å¹¶å‘å†²çªé—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨åŒ…è£…ç±»å¯¹å®ä¾‹æ¥å£è¿›è¡ŒåŒ…è£…ï¼Œç”¨äºä¿è¯å¤šçº¿ç¨‹è¿‡ç¨‹ä¸­çš„æ•°æ®å®‰å…¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Holder</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>holderå¯ä»¥ä½œä¸ºä¸€ä¸ªé”å¯¹è±¡ä¿è¯å®‰å…¨ã€‚</p><p>å‚è€ƒspring spi ,extensionçš„é…ç½®æ–‡ä»¶å®šä¹‰ä¸ºä»¥ä¸‹æ ¼å¼key = â€˜full pathâ€™,å¦‚zk=org.example.ray.infrastructure.adapter.impl.RpcServiceFindingAdapterImpl</p><p>è¿™æ ·å¯ä»¥æ–¹ä¾¿åœ¨ç³»ç»Ÿå†…é€šè¿‡keyåˆ›å»ºè·å–å’Œè°ƒç”¨</p><h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>ä¸ºäº†èƒ½å¤Ÿé¿å…é‡å¤åŠ è½½åˆ›å»ºçš„é—®é¢˜ï¼Œä½¿ç”¨mapä½œä¸ºç¼“å­˜ã€‚åŒæ—¶ä¸ºäº†æé«˜è·å–çš„æ•ˆç‡ï¼Œé’ˆå¯¹ä¸åŒæœåŠ¡çš„æœåŠ¡ï¼Œä¼šæœ‰ä¸åŒçš„æ‹“å±•å®ä¾‹ï¼Œç¼“å­˜ä¸åŒæœåŠ¡ä¸‹çš„å®ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExtensionLoader</span>&lt;T&gt; &#123;</span><br><span class="line"><span class="comment">//extention path</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span>                            <span class="variable">SERVICE_DIRECTORY</span>   <span class="operator">=</span> <span class="string">&quot;META-INF/extension/&quot;</span>;</span><br><span class="line">  <span class="comment">//save extentionloader for load different class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS   = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="comment">//save all instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt;             EXTENSION_INSTANCES = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt;                                 type;</span><br><span class="line">  <span class="comment">//save different service hold instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Holder&lt;Object&gt;&gt;              cachedInstances     = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  <span class="comment">//save different instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;            cachedClasses       = <span class="keyword">new</span> <span class="title class_">Holder</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p>å®ç°è·å–classloaderå’ŒgetExtensionæ–¹æ³•</p><p><img src="/2023/05/22/rpc/spi/WX20230605-170936@2x.png" alt="WX20230605-170936@2x"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;java-spi-åº”ç”¨&quot;&gt;&lt;a href=&quot;#java-spi-åº”ç”¨&quot; class=&quot;headerlink&quot; title=&quot;java spi åº”ç”¨&quot;&gt;&lt;/a&gt;java spi åº”ç”¨&lt;/h1&gt;&lt;h2 id=&quot;Spi-å®šä¹‰&quot;&gt;&lt;a href=&quot;#Spi-å®šä¹‰&quot; cla
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="spi" scheme="http://pjpjsocute.github.io/tags/spi/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)</title>
    <link href="http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_II/"/>
    <id>http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_II/</id>
    <published>2023-05-21T22:00:00.000Z</published>
    <updated>2023-05-29T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)</h1><p><img src="/2023/05/22/rpc/spring_rpc_II/image-20230522163034434.png" alt="image-20230522163034434"></p><p>ç»§ç»­ä¸Šä¸€ç« ï¼Œå®ç°äº†æœåŠ¡æ³¨å†Œåéœ€è¦å®ç°æœåŠ¡è°ƒç”¨ã€‚</p><h3 id="æœåŠ¡æ‰§è¡Œ"><a href="#æœåŠ¡æ‰§è¡Œ" class="headerlink" title="æœåŠ¡æ‰§è¡Œ"></a>æœåŠ¡æ‰§è¡Œ</h3><p>ä¸€ä¸ªRPCçš„æœåŠ¡è°ƒç”¨åº”è¯¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><p>è¯·æ±‚ç›‘å¬ï¼›</p><p>è§£ç è¯·æ±‚ï¼›</p><p>æ–¹æ³•è°ƒç”¨ï¼›</p><p>è¿”å›ç»“æœï¼›</p><p>æ¥ä¸‹æ¥å°†ä¾æ¬¡å®ç°ä»¥ä¸ŠåŠŸèƒ½ï¼›</p><h4 id="è¯·æ±‚ç›‘å¬"><a href="#è¯·æ±‚ç›‘å¬" class="headerlink" title="è¯·æ±‚ç›‘å¬"></a>è¯·æ±‚ç›‘å¬</h4><p>éœ€è¦å®šä¹‰ä¸€ä¸ªRpcRequestè¯·æ±‚ç±»ï¼Œç”±äºåç»­å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8509587559718339795L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * traceId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String traceId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * interface name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[] parameters;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameter types</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[] paramTypes;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String project;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be split to get the service name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() +<span class="string">&quot;*&quot;</span>+<span class="built_in">this</span>.getGroup()+<span class="string">&quot;*&quot;</span>+ <span class="built_in">this</span>.getServiceName() +<span class="string">&quot;*&quot;</span>+ <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›‘å¬è¯·æ±‚éœ€è¦å¯åŠ¨ä¸€ä¸ªnetty serverï¼Œç”¨äºç›‘å¬è¯·æ±‚serviceçš„æœåŠ¡ã€‚</p><p>å¯åŠ¨æ—¶é¦–å…ˆéœ€è¦å…³é—­ä¹‹å‰æ³¨å†Œçš„æœåŠ¡ç­‰èµ„æºã€‚</p><p>éšåå¯¹nettyéœ€è¦çš„èµ„æºè¿›è¡Œä¾æ¬¡åˆå§‹åŒ–ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€æ®µnettyçš„å¯åŠ¨ä»£ç ï¼Œå…¶ä¸­éœ€è¦åŠ å…¥ç¼–ç å’Œè§£ç å™¨ç”¨äºåè®®è§£æï¼Œæ¢æ´»ã€‚</p><p>åŒæ—¶ï¼Œéœ€è¦åŠ å…¥é™æµå’Œè§£ç åçš„è¯·æ±‚å¤„ç†hanlder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyServer</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server init&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ServerShutdownHook.getInstance().registerShutdownHook();</span><br><span class="line"></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">listenerGroup</span> <span class="operator">=</span> initListenerGroup();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> initWorkerGroup();</span><br><span class="line">        <span class="type">DefaultEventExecutorGroup</span> <span class="variable">businessGroup</span> <span class="operator">=</span> initBusinessGroup();</span><br><span class="line"></span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server start&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> configureServerBootstrap(listenerGroup, workerGroup, businessGroup);</span><br><span class="line">            bindAndListen(serverBootstrap);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when start server:&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            shutdown(listenerGroup, workerGroup, businessGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup <span class="title function_">initListenerGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup <span class="title function_">initWorkerGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultEventExecutorGroup <span class="title function_">initBusinessGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultEventExecutorGroup</span>(</span><br><span class="line">                Runtime.getRuntime().availableProcessors() * <span class="number">2</span>,</span><br><span class="line">                ThreadPoolFactoryUtil.createThreadFactory(<span class="string">&quot;netty-server-business-group&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerBootstrap <span class="title function_">configureServerBootstrap</span><span class="params">(EventLoopGroup listenerGroup, EventLoopGroup workerGroup, DefaultEventExecutorGroup businessGroup)</span> &#123;</span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        serverBootstrap.group(listenerGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, TimeUnit.SECONDS));</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageEncoder</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageDecoder</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">DefaultTrafficBlockHandler</span>());</span><br><span class="line">                        pipeline.addLast(businessGroup, <span class="keyword">new</span> <span class="title class_">NettyRpcServerHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> serverBootstrap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAndListen</span><span class="params">(ServerBootstrap serverBootstrap)</span> <span class="keyword">throws</span> UnknownHostException, InterruptedException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server bind port:&#123;&#125; &quot;</span> , PropertiesFileUtil.readPortFromProperties());</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(host, PropertiesFileUtil.readPortFromProperties()).sync();</span><br><span class="line">        f.channel().closeFuture().sync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">(EventLoopGroup listenerGroup, EventLoopGroup workerGroup, DefaultEventExecutorGroup businessGroup)</span> &#123;</span><br><span class="line">        listenerGroup.shutdownGracefully();</span><br><span class="line">        workerGroup.shutdownGracefully();</span><br><span class="line">        businessGroup.shutdownGracefully();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerShutdownHook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ServerShutdownHook</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerShutdownHook</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServerShutdownHook <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register shut down hook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerShutdownHook</span><span class="params">()</span> &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ¸…ç†æ“ä½œ</span></span><br><span class="line">            clearAll();</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ¸…ç†æ³¨å†Œè¡¨</span></span><br><span class="line">            <span class="type">InetSocketAddress</span> <span class="variable">inetSocketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(InetAddress.getLocalHost().getHostAddress(), PropertiesFileUtil.readPortFromProperties());</span><br><span class="line">            CuratorClient.clearRegistry(CuratorClient.getZkClient(), inetSocketAddress);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        ThreadPoolFactoryUtil.shutDownAllThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“åˆApplicationRunnerï¼Œå®ç°serverçš„è‡ªåŠ¨å¯åŠ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServerRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NettyServer nettyServer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyServerRunner</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        nettyServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h4><p>æœ¬é¡¹ç›®é»˜è®¤åªæ˜¯å®ç°äº†hessençš„åºåˆ—åŒ–å’ŒgzipåŠ è§£å‹ï¼Œè¿™éƒ¨åˆ†æœ‰è®¸å¤šçš„æ•™ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä»‹ç»ã€‚å…·ä½“çš„ä»£ç å¯ä»¥åœ¨æºç çš„org.example.ray.infrastructure.serializeåŒ…å’Œorg.example.ray.infrastructure.compressåŒ…ä¸­æ‰¾åˆ°</p><h4 id="ç¼–ç ä¸åè®®"><a href="#ç¼–ç ä¸åè®®" class="headerlink" title="ç¼–ç ä¸åè®®"></a>ç¼–ç ä¸åè®®</h4><p>å®ç°äº†æœåŠ¡åï¼Œæˆ‘ä»¬éœ€è¦ä¾æ¬¡ä¸ºä»–è¡¥å……ç¼–ç å’Œå¤„ç†ç±»ã€‚</p><p>åœ¨å®ç°ç¼–ç çš„æœåŠ¡ä¹‹å‰ï¼Œé¦–å…ˆåº”è¯¥ç¡®å®šåº•å±‚çš„ç¼–ç åè®®ã€‚</p><h5 id="åè®®"><a href="#åè®®" class="headerlink" title="åè®®"></a>åè®®</h5><p>æœ¬é¡¹ç›®å‚è€ƒä¸€äº›å·²æœ‰çš„åè®®è®¾è®¡ï¼Œé€‰æ‹©äº†ä¸€ç§æ¯”è¾ƒç®€å•çš„åè®®è®¾è®¡æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p><p><img src="/2023/05/22/rpc/spring_rpc_II/image-20230522174913202.png" alt="image-20230522174913202"></p><p>åè®®ç”±ä¸€ä¸ª16byteçš„headerå’Œbodyç»„æˆã€‚</p><p>å…¶ä¸­0-4æ˜¯magic codeï¼Œç”¨äºæ ¡éªŒ</p><p>4-5ä¸ºè‡ªå®šä¹‰çš„åè®®ç‰ˆæœ¬</p><p>5-8æ˜¯æ•´ä¸ªmessageçš„é•¿åº¦ï¼Œç”¨äºè§£ç </p><p>8-9å®šä¹‰äº†æ¶ˆæ¯ç±»å‹ï¼ŒåŒ…æ‹¬è¯·æ±‚ï¼Œå“åº”ï¼Œå¿ƒè·³è¯·æ±‚ï¼Œå¿ƒè·³å“åº”ã€‚</p><p>10ä¸ºç¼–ç æ–¹å¼</p><p>11ä¸ºå‹ç¼©æ–¹å¼</p><p>12-16ä¸ºä¸€ä¸ªæ•´å‹ï¼Œä¸ºè¯·æ±‚çš„ç¼–å·</p><p>Java pojoå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcData</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rpc message type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   messageType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * serialization type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   serializeMethodCodec;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * compress type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   compressType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>    requestId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHeatBeatRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.HEARTBEAT_REQUEST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canSendRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType != RpcConstants.HEARTBEAT_REQUEST_TYPE</span><br><span class="line">            &amp;&amp; messageType != RpcConstants.HEARTBEAT_RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHeartBeatResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.HEARTBEAT_RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨äº†è§£äº†åè®®ä¹‹åï¼Œå®ç°è§£ç </p><h5 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h5><p>LengthFieldBasedFrameDecoderè§£ç å™¨å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« </p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zhuanlan.zhihu.com/p/95621344&quot;</span><br></pre></td></tr></table></figure><p>åœ¨äº†è§£LengthFieldBasedFrameDecoderè§£ç å™¨çš„åŸºç¡€ä¸Šï¼Œè§£ç çš„è¿‡ç¨‹å…¶å®å¹¶ä¸å¤æ‚ã€‚ä¸»è¦æ˜¯è§£ç headerï¼Œæ ¡éªŒï¼Œå’Œè§£ç body3éƒ¨åˆ†ï¼Œå…·ä½“å®ç°å¯ä»¥å‚è€ƒä»£ç å’Œæ³¨é‡Šã€‚</p><p>è§£ç éƒ¨åˆ†ä½¿ç”¨java spiï¼Œå¯ä»¥å®šåˆ¶é€‰æ‹©ååºåˆ—åŒ–å’Œè§£å‹æ–¹æ³•ï¼Œæ­¤éƒ¨åˆ†å¯ä»¥å‚è€ƒgithubä¸­çš„ä»£ç ï¼Œæˆ–è€…å¯ä»¥åªä½¿ç”¨å›ºå®šåºåˆ—åŒ–å’Œè§£å‹æ–¹æ³•æ›¿ä»£spiéƒ¨åˆ†ã€‚</p><p>æœ¬é¡¹ç›®é»˜è®¤åªæ˜¯å®ç°äº†hessençš„åºåˆ—åŒ–å’ŒgzipåŠ è§£å‹ï¼Œè¿™éƒ¨åˆ†æœ‰è®¸å¤šçš„æ•™ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä»‹ç»ã€‚å…·ä½“çš„ä»£ç å¯ä»¥åœ¨æºç çš„org.example.ray.infrastructure.serializeåŒ…å’Œorg.example.ray.infrastructure.compressåŒ…ä¸­æ‰¾åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcMessageDecoder</span> <span class="keyword">extends</span> <span class="title class_">LengthFieldBasedFrameDecoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcMessageDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// lengthFieldOffset: magic code is 4B, and version is 1B, and then full</span></span><br><span class="line">        <span class="comment">// length. so value is 5</span></span><br><span class="line">        <span class="comment">// lengthFieldLength: full length is 4B. so value is 4</span></span><br><span class="line">        <span class="comment">// lengthAdjustment: full length include all data and read 9 bytes</span></span><br><span class="line">        <span class="comment">// before, so the left length is (fullLength-9). so values is -9</span></span><br><span class="line">        <span class="comment">// initialBytesToStrip: we will check magic code and version manually,</span></span><br><span class="line">        <span class="comment">// so do not strip any bytes. so values is 0</span></span><br><span class="line">        <span class="built_in">this</span>(<span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">5</span>, <span class="number">4</span>, -<span class="number">9</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcMessageDecoder</span><span class="params">(<span class="type">int</span> maxFrameLength, <span class="type">int</span> lengthFieldOffset, <span class="type">int</span> lengthFieldLength, <span class="type">int</span> lengthAdjustment,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> initialBytesToStrip)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(maxFrameLength, lengthFieldOffset, lengthFieldLength, lengthAdjustment, initialBytesToStrip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// get the bytebuf which contains the frame</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">decode</span> <span class="operator">=</span> <span class="built_in">super</span>.decode(ctx, in);</span><br><span class="line">        <span class="keyword">if</span> (decode <span class="keyword">instanceof</span> ByteBuf) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> (ByteBuf)decode;</span><br><span class="line">            <span class="comment">// if data not empty, decode it</span></span><br><span class="line">            <span class="keyword">if</span> (byteBuf.readableBytes() &gt;= RpcConstants.HEAD_LENGTH) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> decode(byteBuf);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LogUtil.error(<span class="string">&quot;Decode error:&#123;&#125; ,input:&#123;&#125;&quot;</span>, e, byteBuf);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    byteBuf.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * read byte array from byteBuf</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteBuf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">decode</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode&quot;</span>);</span><br><span class="line">        checkMagicCode(byteBuf);</span><br><span class="line">        checkVersion(byteBuf);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> byteBuf.readInt();</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> decodeRpcMessage(byteBuf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.isHeatBeatRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleHeatBeatRequest(rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.isHeartBeatResponse()) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleHeartBeatResponse(rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handleNormalRequest(rpcMessage, byteBuf, fullLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">decodeRpcMessage</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode RpcMessage data&quot;</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">codec</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">compress</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">traceId</span> <span class="operator">=</span> byteBuf.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">                .serializeMethodCodec(codec)</span><br><span class="line">                .traceId(traceId)</span><br><span class="line">                .compressType(compress)</span><br><span class="line">                .messageType(messageType)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">handleHeatBeatRequest</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setData(RpcConstants.PING);</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">handleHeartBeatResponse</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setData(RpcConstants.PONG);</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">handleNormalRequest</span><span class="params">(RpcData rpcMessage, ByteBuf byteBuf, <span class="type">int</span> fullLength)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bodyLength</span> <span class="operator">=</span> fullLength - RpcConstants.HEAD_LENGTH;</span><br><span class="line">        <span class="keyword">if</span> (bodyLength &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rpcMessage;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decodeBody(rpcMessage, byteBuf, bodyLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">decodeBody</span><span class="params">(RpcData rpcMessage, ByteBuf byteBuf, Integer bodyLength)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode body&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bodyBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[bodyLength];</span><br><span class="line">        byteBuf.readBytes(bodyBytes);</span><br><span class="line">        <span class="comment">// decompose</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">compressName</span> <span class="operator">=</span> CompressTypeEnum.getName(rpcMessage.getCompressType());</span><br><span class="line">        <span class="type">CompressService</span> <span class="variable">extension</span> <span class="operator">=</span></span><br><span class="line">            ExtensionLoader.getExtensionLoader(CompressService.class).getExtension(compressName);</span><br><span class="line">        bodyBytes = extension.decompress(bodyBytes);</span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.getMessageType() == RpcConstants.REQUEST_TYPE) &#123;</span><br><span class="line">            <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                .getExtension(SerializationTypeEnum.getName(rpcMessage.getSerializeMethodCodec()))</span><br><span class="line">                .deserialize(bodyBytes, RpcRequest.class);</span><br><span class="line">            rpcMessage.setData(rpcRequest);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                .getExtension(SerializationTypeEnum.getName(rpcMessage.getSerializeMethodCodec()))</span><br><span class="line">                .deserialize(bodyBytes, RpcResponse.class);</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkVersion</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="keyword">if</span> (version != RpcConstants.VERSION) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;version is not compatible: &quot;</span> + version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkMagicCode</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> RpcConstants.MAGIC_NUMBER.length;</span><br><span class="line">        <span class="type">byte</span>[] magicNumber = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        byteBuf.readBytes(magicNumber);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (magicNumber[i] != RpcConstants.MAGIC_NUMBER[i]) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown magic code: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(magicNumber));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h5><p>ç¼–ç çš„è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯æ ¹æ®åè®®ï¼Œä¾æ¬¡å°†å¯¹åº”ä½çš„æ•°æ®å†™å…¥å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcMessageEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;RpcData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ATOMIC_INTEGER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, RpcData rpcData, ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//encode head,marked full length index</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">fullLengthIndex</span> <span class="operator">=</span> encodeHead(rpcData,byteBuf);</span><br><span class="line">            <span class="comment">// encode body</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> encodeBody(rpcData, byteBuf);</span><br><span class="line">            <span class="comment">// back fill full length</span></span><br><span class="line">            encodeLength(fullLengthIndex,fullLength,byteBuf);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;Encode request error:&#123;&#125;,data:&#123;&#125;&quot;</span>, e, rpcData);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.REQUEST_ENCODE_FAIL.getCode(),</span><br><span class="line">                RpcErrorMessageEnum.REQUEST_ENCODE_FAIL.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">encodeHead</span><span class="params">(RpcData rpcData,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="comment">// write magic code and version 0-5</span></span><br><span class="line">        byteBuf.writeBytes(RpcConstants.MAGIC_NUMBER);</span><br><span class="line">        byteBuf.writeByte(RpcConstants.VERSION);</span><br><span class="line">        <span class="comment">// marked full length index.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLengthIndex</span> <span class="operator">=</span> byteBuf.writerIndex();</span><br><span class="line">        <span class="comment">// write placeholder for full length 9+</span></span><br><span class="line">        byteBuf.writerIndex(byteBuf.writerIndex() + <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// write message type</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getMessageType());</span><br><span class="line">        <span class="comment">// write codec</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getSerializeMethodCodec());</span><br><span class="line">        <span class="comment">// write compress</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getCompressType());</span><br><span class="line">        <span class="comment">// write requestId</span></span><br><span class="line">        byteBuf.writeInt(ATOMIC_INTEGER.getAndIncrement());</span><br><span class="line">        <span class="keyword">return</span> fullLengthIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">encodeBody</span><span class="params">(RpcData rpcData,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] bodyBytes = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> RpcConstants.HEAD_LENGTH;</span><br><span class="line">        <span class="keyword">if</span> (rpcData.canSendRequest()) &#123;</span><br><span class="line">            LogUtil.info(<span class="string">&quot;serialize request start&quot;</span>);</span><br><span class="line">            bodyBytes = ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                    .getExtension(SerializationTypeEnum.getName(rpcData.getSerializeMethodCodec()))</span><br><span class="line">                    .serialize(rpcData.getData());</span><br><span class="line">            LogUtil.info(<span class="string">&quot;serialize request end&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">compressName</span> <span class="operator">=</span> CompressTypeEnum.getName(rpcData.getCompressType());</span><br><span class="line">            <span class="type">CompressService</span> <span class="variable">extension</span> <span class="operator">=</span></span><br><span class="line">                    ExtensionLoader.getExtensionLoader(CompressService.class).getExtension(compressName);</span><br><span class="line">            bodyBytes = extension.compress(bodyBytes);</span><br><span class="line">            fullLength += bodyBytes.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bodyBytes != <span class="literal">null</span>) &#123;</span><br><span class="line">            byteBuf.writeBytes(bodyBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fullLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">encodeLength</span><span class="params">(<span class="type">int</span> fullLengthIndex,<span class="type">int</span> fullLength,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">writeIndex</span> <span class="operator">=</span> byteBuf.writerIndex();</span><br><span class="line">        byteBuf.writerIndex(fullLengthIndex);</span><br><span class="line">        byteBuf.writeInt(fullLength);</span><br><span class="line">        byteBuf.writerIndex(writeIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¯·æ±‚å¤„ç†å’Œè°ƒç”¨"><a href="#è¯·æ±‚å¤„ç†å’Œè°ƒç”¨" class="headerlink" title="è¯·æ±‚å¤„ç†å’Œè°ƒç”¨"></a>è¯·æ±‚å¤„ç†å’Œè°ƒç”¨</h4><p>è¿™é‡Œå®ç”¨nettyçš„SimpleChannelInboundHandlerï¼Œå¯ä»¥é¿å…èµ„æºé‡Šæ”¾çš„é—®é¢˜</p><p>ç”±äºå‰é¢å·²ç»å®ç°äº†è§£ç ï¼Œæ‰€ä»¥åªéœ€è¦é’ˆå¯¹ä¸åŒçš„è¯·æ±‚ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†å³å¯ã€‚</p><p>å¦‚æœæ˜¯å¿ƒè·³è¯·æ±‚ï¼Œåˆ™è¿”å›å¿ƒè·³å“åº”</p><p>å¦‚æœæ˜¯æœåŠ¡è¯·æ±‚ï¼Œåˆ™é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨æœåŠ¡ï¼Œå¹¶å†™å…¥ç»“æœè¿”å›ç»™æ¶ˆè´¹è€…ã€‚</p><p>å®šä¹‰ä¸€ä¸ªå“åº”ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponse</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">347966260947189201L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            requestId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer           code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            message;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response body</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T                 data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * success</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RpcResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T data, String requestId)</span> &#123;</span><br><span class="line">        RpcResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RpcResponse</span>&lt;&gt;();</span><br><span class="line">        response.setCode(RpcResponseCodeEnum.SUCCESS.getCode());</span><br><span class="line">        response.setMessage(RpcResponseCodeEnum.SUCCESS.getMessage());</span><br><span class="line">        response.setRequestId(requestId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != data) &#123;</span><br><span class="line">            response.setData(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fail</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RpcResponse&lt;T&gt; <span class="title function_">fail</span><span class="params">()</span> &#123;</span><br><span class="line">        RpcResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RpcResponse</span>&lt;&gt;();</span><br><span class="line">        response.setCode(RpcResponseCodeEnum.FAIL.getCode());</span><br><span class="line">        response.setMessage(RpcResponseCodeEnum.FAIL.getMessage());</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serverhandlerçš„æ ¸å¿ƒæ–¹æ³•ä¸ºchannelRead0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcData&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read the message transmitted by the server</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcRequestHandler rpcRequestHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyRpcServerHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rpcRequestHandler = SingletonFactory.getInstance(RpcRequestHandler.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * heart beat handle</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// if the channel is freeï¼Œclose it</span></span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="type">IdleState</span> <span class="variable">state</span> <span class="operator">=</span> ((IdleStateEvent)evt).state();</span><br><span class="line">            <span class="keyword">if</span> (state == IdleState.READER_IDLE) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;idle check happen, so close the connection&quot;</span>);</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when an exception occurs in processing a client message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;server exceptionCaught&quot;</span>);</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Server receive message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">        setupRpcMessage(rpcMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcData.isHeatBeatRequest()) &#123;</span><br><span class="line">            handleHeartbeat(rpcMessage);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleRpcRequest(ctx, rpcData, rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.writeAndFlush(rpcMessage).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupRpcMessage</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">        rpcMessage.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleHeartbeat</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setMessageType(RpcConstants.HEARTBEAT_RESPONSE_TYPE);</span><br><span class="line">        rpcMessage.setData(RpcConstants.PONG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRpcRequest</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData, RpcData rpcMessage)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> (RpcRequest)rpcData.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invoke target method</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> rpcRequestHandler.handle(rpcRequest);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Server get result: &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        rpcMessage.setMessageType(RpcConstants.RESPONSE_TYPE);</span><br><span class="line">        buildAndSetRpcResponse(ctx, rpcRequest, rpcMessage, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line">        <span class="title function_">buildAndSetRpcResponse</span><span class="params">(ChannelHandlerContext ctx, RpcRequest rpcRequest, RpcData rpcMessage, Object result)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (canBuildResponse(ctx)) &#123;</span><br><span class="line">            <span class="comment">// If the channel is active and writable, a successful RPC response is constructed</span></span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = RpcResponse.success(result, rpcRequest.getTraceId());</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Construct a failed RPC response if the channel is not writable</span></span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = RpcResponse.fail();</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">            LogUtil.error(<span class="string">&quot;Not writable now, message dropped,message:&#123;&#125;&quot;</span>, rpcRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canBuildResponse</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.channel().isActive() &amp;&amp; ctx.channel().isWritable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tipp:  æ³¨å†Œåˆ°zkåç¼“å­˜çš„æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥åŸºäºåŠ¨æ€ä»£ç†è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequestHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcRequestHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Processing rpcRequest: call the corresponding method, and then return the</span></span><br><span class="line"><span class="comment">     * method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">handle</span><span class="params">(RpcRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">service</span> <span class="operator">=</span> adapter.getService(request.fetchRpcServiceName());</span><br><span class="line">        <span class="keyword">return</span> invoke(request, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get method execution results</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcRequest client request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service service object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of the target method execution</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">invoke</span><span class="params">(RpcRequest rpcRequest, Object service)</span> &#123;</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> service.getClass().getMethod(rpcRequest.getMethodName(), rpcRequest.getParamTypes());</span><br><span class="line">            result = method.invoke(service, rpcRequest.getParameters());</span><br><span class="line">            LogUtil.info(<span class="string">&quot;service:[&#123;&#125;] successful invoke method:[&#123;&#125;]&quot;</span>, rpcRequest.getServiceName(),</span><br><span class="line">                rpcRequest.getMethodName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalArgumentException | InvocationTargetException</span><br><span class="line">            | IllegalAccessException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when invoke target method,error:&#123;&#125;,RpcRequest:&#123;&#125;&quot;</span>, e, rpcRequest);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.SERVICE_INVOCATION_FAILURE.getCode(), RpcErrorMessageEnum.SERVICE_INVOCATION_FAILURE.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œä¸€ä¸ªæœåŠ¡ç«¯çš„ä»£ç å°±å®Œæˆäº†</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ&quot;&gt;&lt;a href=&quot;#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ&quot; class=&quot;headerlink&quot; title=&quot;åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)&quot;&gt;&lt;/a&gt;åŸºäºsp
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="é¡¹ç›®" scheme="http://pjpjsocute.github.io/tags/%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="spi" scheme="http://pjpjsocute.github.io/tags/spi/"/>
    
      <category term="rpc" scheme="http://pjpjsocute.github.io/tags/rpc/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)</title>
    <link href="http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_I/"/>
    <id>http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_I/</id>
    <published>2023-05-21T22:00:00.000Z</published>
    <updated>2023-05-21T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)</h1><hr><p> Code:pjpjsocute/rpc-service: personal rcp attempt (github.com)<br> æŠ€æœ¯æ ˆä½¿ç”¨åŒ…æ‹¬ï¼šspringboot,Zookeeper,netty,java spi</p><hr><h2 id="RPCå®šä¹‰"><a href="#RPCå®šä¹‰" class="headerlink" title="RPCå®šä¹‰"></a>RPCå®šä¹‰</h2><p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼‰æ˜¯ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œå…è®¸ä¸åŒçš„æœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡å’Œäº¤äº’ã€‚</p><p>é€šè¿‡RPCï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥å‘å¦ä¸€ä¸ªæœåŠ¡å‘èµ·è¯·æ±‚å¹¶è·å–å“åº”ï¼Œå°±åƒæœ¬åœ°è°ƒç”¨ä¸€æ ·ï¼Œè€Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨å¤„ç†åº•å±‚çš„ç½‘ç»œé€šä¿¡ç»†èŠ‚ã€‚RPCæ¡†æ¶ä¼šå°è£…åº•å±‚çš„ç½‘ç»œä¼ è¾“ï¼Œå¹¶æä¾›äº†è¿œç¨‹æœåŠ¡æ¥å£çš„å®šä¹‰ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç­‰åŠŸèƒ½ã€‚</p><h3 id="rpcä¸httpè¾¨æï¼š"><a href="#rpcä¸httpè¾¨æï¼š" class="headerlink" title="rpcä¸httpè¾¨æï¼š"></a>rpcä¸httpè¾¨æï¼š</h3><p>â€‹    HTTPæ˜¯ä¸€ç§ç”¨äºä¼ è¾“è¶…æ–‡æœ¬çš„åº”ç”¨å±‚åè®®ï¼Œå®ƒåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚å®ƒåŸºäºè¯·æ±‚-å“åº”æ¨¡å‹ï¼Œå®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›ç›¸åº”çš„HTTPå“åº”ã€‚RPCæ›´ç±»ä¼¼ä¸€ç§æ¶æ„æ€æƒ³ï¼ŒRPCå¯ä»¥ç”¨HTTPå®ç°ï¼ŒTCPå®ç°ã€‚</p><h2 id="RPCæµç¨‹"><a href="#RPCæµç¨‹" class="headerlink" title="RPCæµç¨‹"></a>RPCæµç¨‹</h2><p>ä¸€ä¸ªç®€å•çš„RPCæ¶æ„å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="/2023/05/22/rpc/spring_rpc_I/image-20230522161808172.png" alt="image-20230522161808172"></p><h2 id="å¦‚ä½•å®ç°ï¼š"><a href="#å¦‚ä½•å®ç°ï¼š" class="headerlink" title="å¦‚ä½•å®ç°ï¼š"></a>å¦‚ä½•å®ç°ï¼š</h2><h3 id="ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š"><a href="#ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š" class="headerlink" title="ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š"></a>ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š</h3><p><img src="/2023/05/22/rpc/spring_rpc_I/image-20230522163034434.png" alt="image-20230522163034434"></p><h2 id="åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°"><a href="#åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°" class="headerlink" title="åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°"></a>åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°</h2><p>æ ¹æ®ä¸Šå›¾ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡æ³¨å†Œã€‚</p><h3 id="æœåŠ¡æ³¨å†Œï¼š"><a href="#æœåŠ¡æ³¨å†Œï¼š" class="headerlink" title="æœåŠ¡æ³¨å†Œï¼š"></a>æœåŠ¡æ³¨å†Œï¼š</h3><p>ç›®å‰RPCæ¡†æ¶å¤§éƒ½æ”¯æŒæ³¨è§£çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œè¿™é‡Œä¹Ÿä½¿ç”¨ç›¸åŒçš„æ–¹å¼ã€‚</p><h4 id="å®šä¹‰æ³¨å†Œæ³¨è§£"><a href="#å®šä¹‰æ³¨å†Œæ³¨è§£" class="headerlink" title="å®šä¹‰æ³¨å†Œæ³¨è§£"></a>å®šä¹‰æ³¨å†Œæ³¨è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RpcProvider &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">project</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service version, default value is 1.0</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">version</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">group</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RpcConsumer &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service project, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">project</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service version, default value is 1.0</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">version</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">group</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomBeanScannerRegistrar.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SimpleRpcApplication &#123;</span><br><span class="line"></span><br><span class="line">    String[] basePackage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        è¯¥æ³¨è§£å°†å®šä¹‰æœåŠ¡ç‰ˆæœ¬ï¼Œgroup(åŒºåˆ†åŒååŒé¡¹ç›®çš„ä¸åŒæ¥å£)ï¼Œé¡¹ç›®åï¼Œç”¨äºæœåŠ¡æš´éœ²ã€‚</p><p>â€‹        åŒç†ï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ³¨è§£ç”¨äºæ¶ˆè´¹;ä¸€ä¸ªæ³¨è§£å®šä¹‰éœ€è¦æ‰«æçš„åŒ…</p><h4 id="åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡"><a href="#åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡" class="headerlink" title="åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡"></a>åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡</h4><h5 id="é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰-providerçš„æ³¨è§£æ³¨å†Œ"><a href="#é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰-providerçš„æ³¨è§£æ³¨å†Œ" class="headerlink" title="é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰@providerçš„æ³¨è§£æ³¨å†Œ"></a>é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰@providerçš„æ³¨è§£æ³¨å†Œ</h5><p>è·å–éœ€è¦æ‰«æçš„åŒ…ï¼Œéšåå¸¦æœ‰æ³¨è§£çš„beanè¿›è¡Œæ³¨å†Œè¿›å…¥springå³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomBeanScannerRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_SCAN_PARAM</span> <span class="operator">=</span> <span class="string">&quot;basePackage&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_BEAN_BASE_PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;org.example.ray&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//get the scan annotation and the bean package to be scanned</span></span><br><span class="line">        String[] scanBasePackages = fetchScanBasePackage(importingClassMetadata);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;scanning packages: [&#123;&#125;]&quot;</span>, (Object) scanBasePackages);</span><br><span class="line">        </span><br><span class="line"><span class="comment">//        //scan the package and register the bean</span></span><br><span class="line"><span class="comment">//        RpcBeanScanner rpcConsumerBeanScanner = new RpcBeanScanner(registry, RpcConsumer.class);</span></span><br><span class="line">        <span class="type">RpcBeanScanner</span> <span class="variable">rpcProviderBeanScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcBeanScanner</span>(registry, RpcProvider.class);</span><br><span class="line">        <span class="type">RpcBeanScanner</span> <span class="variable">springBeanScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcBeanScanner</span>(registry, Component.class);</span><br><span class="line">        <span class="keyword">if</span> (resourceLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            springBeanScanner.setResourceLoader(resourceLoader);</span><br><span class="line">            rpcProviderBeanScanner.setResourceLoader(resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rpcServiceCount</span> <span class="operator">=</span> rpcProviderBeanScanner.scan(scanBasePackages);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;rpcServiceScanneræ‰«æçš„æ•°é‡ [&#123;&#125;]&quot;</span>, rpcServiceCount);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;scanning RpcConsumer annotated beans end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String[] fetchScanBasePackage(AnnotationMetadata importingClassMetadata)&#123;</span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">annotationAttributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(SimpleRpcApplication.class.getName()));</span><br><span class="line">        String[] scanBasePackages = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (annotationAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">            scanBasePackages = annotationAttributes.getStringArray(API_SCAN_PARAM);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//user doesn&#x27;t specify the package to scan,use the Application base package</span></span><br><span class="line">        <span class="keyword">if</span> (scanBasePackages.length == <span class="number">0</span>) &#123;</span><br><span class="line">            scanBasePackages = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;((org.springframework.core.type.StandardAnnotationMetadata) importingClassMetadata).getIntrospectedClass().getPackage().getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scanBasePackages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ"><a href="#åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ" class="headerlink" title="åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ"></a>åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter  sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = ExtensionLoader.getExtensionLoader(RpcSendingServiceAdapter.class)</span><br><span class="line">            .getExtension(RpcRequestSendingEnum.NETTY.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start process register service: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">        <span class="comment">// register service</span></span><br><span class="line">        <span class="keyword">if</span> (bean.getClass().isAnnotationPresent(RpcProvider.class)) &#123;</span><br><span class="line">            <span class="type">RpcProvider</span> <span class="variable">annotation</span> <span class="operator">=</span> bean.getClass().getAnnotation(RpcProvider.class);</span><br><span class="line">            <span class="comment">// build rpc service config</span></span><br><span class="line">            <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                .service(bean)</span><br><span class="line">                .project(annotation.project())</span><br><span class="line">                .version(annotation.version())</span><br><span class="line">                .group(annotation.group())</span><br><span class="line">                .build();</span><br><span class="line">            LogUtil.info(<span class="string">&quot;register service: &#123;&#125;&quot;</span>, serviceConfig);</span><br><span class="line">            adapter.registryService(serviceConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•"><a href="#å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•" class="headerlink" title="å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•"></a>å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•</h5><p>æ³¨å†Œä¸€ä¸ªæœåŠ¡ï¼Œè‡³å°‘åº”è¯¥å§åŒ…æ‹¬:æœåŠ¡æä¾›è€…(ip)ï¼ŒæœåŠ¡åï¼Œä»¥åŠ@RpcProvider ä¸­çš„å˜é‡ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªRpcServiceConfig.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * service version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * target service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * belong to which project</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">project</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span>   <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be split to get the service name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getGroup() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getServiceName() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the interface name</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.service.getClass().getInterfaces()[<span class="number">0</span>].getCanonicalName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æä¾›2ä¸ªæ–¹æ³•ï¼Œæ³¨å†ŒæœåŠ¡ä¸æ ¹æ®æœåŠ¡åå¾—åˆ°å¯¹åº”çš„bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RpcServiceRegistryAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcServiceConfig rpc service related attributes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">registryService</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcClassName rpc class name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> service object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getService</span><span class="params">(String rpcClassName)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å†Œæµç¨‹å¯ä»¥åˆ†ä¸º3æ­¥ï¼Œç”Ÿæˆåœ°å€-&gt;æœåŠ¡æ³¨å†Œè¿›å…¥Zookeeper-&gt;æ³¨å†Œè¿›å…¥ç¼“å­˜ã€‚è¿™é‡Œä½¿ç”¨ä¸€ä¸ªConcurrentHashMapæ¥è¿›è¡Œç¼“å­˜æœåŠ¡(æ–¹æ³•ä¸­æœ€åè°ƒç”¨äº†zookeeperçš„apiè¿›è¡Œæ³¨å†Œï¼Œå› ä¸ºä¸RPCå…³è”ä¸å¤§ï¼Œæ‰€ä»¥ç•¥è¿‡ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒæºç )ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceRegistryAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcServiceRegistryAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cache map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; serviceMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registryService</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// first get address and service</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">hostAddress</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">            <span class="comment">// add service to zk</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;add service to zk,service name&#123;&#125;,host:&#123;&#125;&quot;</span>, rpcServiceConfig.fetchRpcServiceName(),hostAddress);</span><br><span class="line">            registerServiceToZk(rpcServiceConfig.fetchRpcServiceName(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(hostAddress, PropertiesFileUtil.readPortFromProperties()));</span><br><span class="line">            <span class="comment">// add service to map cache</span></span><br><span class="line">            registerServiceToMap(rpcServiceConfig);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when getHostAddress&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getService</span><span class="params">(String rpcServiceName)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">service</span> <span class="operator">=</span> serviceMap.get(rpcServiceName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == service) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.SERVICE_CAN_NOT_BE_FOUND.getCode(),<span class="string">&quot;service not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServiceToZk</span><span class="params">(String rpcServiceName, InetSocketAddress inetSocketAddress)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">servicePath</span> <span class="operator">=</span> CuratorClient.ZK_REGISTER_ROOT_PATH + <span class="string">&quot;/&quot;</span> + rpcServiceName + inetSocketAddress.toString();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">zkClient</span> <span class="operator">=</span> CuratorClient.getZkClient();</span><br><span class="line">        CuratorClient.createPersistentNode(zkClient, servicePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServiceToMap</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rpcServiceName</span> <span class="operator">=</span> rpcServiceConfig.fetchRpcServiceName();</span><br><span class="line">        <span class="keyword">if</span> (serviceMap.containsKey(rpcServiceName)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serviceMap.put(rpcServiceName, rpcServiceConfig.getService());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹    åˆ°è¿™é‡Œï¼Œä¸€ä¸ªæœåŠ¡çš„æ³¨å†Œæµç¨‹å·²ç»å®Œæˆã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€&quot;&gt;&lt;a href=&quot;#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€&quot; class=&quot;headerlink&quot; title=&quot;åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)&quot;&gt;&lt;/a&gt;åŸºäºsp
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="é¡¹ç›®" scheme="http://pjpjsocute.github.io/tags/%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="spi" scheme="http://pjpjsocute.github.io/tags/spi/"/>
    
      <category term="rpc" scheme="http://pjpjsocute.github.io/tags/rpc/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-005,å¦‚ä½•ä¸€æ­¥æ­¥æ€è€ƒåˆ°åŠ¨æ€è§„åˆ’</title>
    <link href="http://pjpjsocute.github.io/2023/05/21/LeetCode/LeetCode-005/"/>
    <id>http://pjpjsocute.github.io/2023/05/21/LeetCode/LeetCode-005/</id>
    <published>2023-05-20T22:00:00.000Z</published>
    <updated>2023-05-21T22:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² <code>s</code>ï¼Œæ‰¾åˆ° <code>s</code> ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚</p><p>å¦‚æœå­—ç¬¦ä¸²çš„ååºä¸åŸå§‹å­—ç¬¦ä¸²ç›¸åŒï¼Œåˆ™è¯¥å­—ç¬¦ä¸²ç§°ä¸ºå›æ–‡å­—ç¬¦ä¸²ã€‚</p><h3 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šs = &quot;babad&quot;</span><br><span class="line">è¾“å‡ºï¼š&quot;bab&quot;</span><br><span class="line">è§£é‡Šï¼š&quot;aba&quot; åŒæ ·æ˜¯ç¬¦åˆé¢˜æ„çš„ç­”æ¡ˆã€‚</span><br></pre></td></tr></table></figure><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution:</h3><p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åšç±»ä¼¼çš„é¢˜ç›®ï¼Œå…¶å®ä¸€ä¸‹å­æ˜¯å¹¶ä¸å®¹æ˜“æƒ³åˆ°å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’ã€‚</p><p>ä½†æ˜¯ï¼Œé€šè¿‡ä¸€æ­¥æ­¥çš„æ€è€ƒå’Œä¼˜åŒ–ï¼Œä½¿ç”¨åŠ¨æ€è§„åˆ’å…¶å®æ˜¯ä¸€ç§æ¯”è¾ƒè‡ªç„¶çš„æƒ³æ³•ã€‚</p><h5 id="é¦–å…ˆï¼š"><a href="#é¦–å…ˆï¼š" class="headerlink" title="é¦–å…ˆï¼š"></a>é¦–å…ˆï¼š</h5><h5 id="æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š"><a href="#æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š" class="headerlink" title="æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š"></a>æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š</h5><ol><li><p>è®¾è®¡ä¸€ä¸ªæ–¹æ³• <code>judgeIsPalindrome</code> ï¼ŒåŸºäºåŒæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ª O(n) çš„åˆ¤æ–­ <code>String(i,j)</code> æ˜¯å¦æ˜¯å›æ–‡ä¸²çš„æ–¹æ³•ã€‚</p></li><li><p>æšä¸¾æ‰€æœ‰çš„é•¿åº¦ <code>k</code>ï¼Œä»å¤§åˆ°å°åˆ¤æ–­æ‰€æœ‰çš„ <code>String(i, i+k-1)</code>ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å›æ–‡ä¸²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¾—åˆ°é¢˜ç›®è¦æ±‚ã€‚</p></li></ol><p>è¿™ä¸ªåšæ³•å¾ˆç®€å•ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œéœ€è¦æšä¸¾æ‰€æœ‰çš„ <code>k</code>ï¼Œæœ€åçš„æƒ…å†µéœ€è¦æšä¸¾ <code>N</code> ç§ï¼Œè€Œå¯¹æ¯ç§é•¿åº¦ï¼Œæœ€åéœ€è¦è®¡ç®— <code>N</code> æ¬¡æ‰èƒ½å¾—åˆ°ç»“æœã€‚æ‰€ä»¥æ•´ä½“å¤æ‚åº¦å¾ˆé«˜ï¼Œæ— æ³•é€šè¿‡ã€‚éœ€è¦å¯»æ‰¾ä¸€ç§æ›´ä¼˜çš„åšæ³•ã€‚</p><h5 id="æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª-kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„-kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º-log-Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚"><a href="#æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª-kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„-kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º-log-Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚" class="headerlink" title="æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„ kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º log Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚"></a>æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª <code>k</code>ï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„ <code>k</code>ï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º <code>log N</code>ã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚</h5><h5 id="ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚"><a href="#ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚" class="headerlink" title="ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚"></a>ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚</h5><p>å‡è®¾æˆ‘ä»¬å¯¹ä¸€ä¸ªç‰¹å®šçš„é•¿åº¦ <code>k_i</code>ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† String ä¸­æ‰€æœ‰é•¿åº¦ä¸º <code>k_i</code> çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ä¸²ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬çŸ¥é“ <code>String(i, i+k_i-1)</code> æ˜¯å¦æ˜¯å›æ–‡çš„æ—¶å€™ï¼Œå¯¹äº <code>String(i-1, i+k_i)</code> å…¶å®è¿™ä¸ªç»“æœä¹Ÿæ˜¯å¯ä»¥åœ¨ <code>O(1)</code> çš„æ—¶é—´å†…å¾—åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i][j] = dp[i+1][j-1] ^ String[i] == String[j]</span><br></pre></td></tr></table></figure><p>å³åªæœ‰ <code>String(i, i+k_i-1)</code> æ˜¯å›æ–‡å¹¶ä¸” <code>String[i] == String[j]</code>ï¼Œé‚£ä¹ˆ <code>String(i-1, i+k_i)</code> æ‰èƒ½æ˜¯å›æ–‡ä¸²ã€‚</p><p>ä¸‹é¢å¯ä»¥å†™å‡º DP ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">longestPalindrome</span><span class="params">(String s)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span>[][] dp = <span class="keyword">new</span> <span class="title class_">boolean</span>[len][len];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        dp[i][i] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLen</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> j - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j - i &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                    dp[i][j] = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dp[i][j] = dp[i + <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dp[i][j]) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">curLen</span> <span class="operator">=</span> j - i + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (curLen &gt; maxLen) &#123;</span><br><span class="line">                    maxLen = curLen;</span><br><span class="line">                    start = i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.substring(start, start + maxLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Q&quot;&gt;&lt;a href=&quot;#Q&quot; class=&quot;headerlink&quot; title=&quot;Q:&quot;&gt;&lt;/a&gt;Q:&lt;/h3&gt;&lt;p&gt;ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² &lt;code&gt;s&lt;/code&gt;ï¼Œæ‰¾åˆ° &lt;code&gt;s&lt;/code&gt; ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœå­—ç¬¦ä¸²çš„ååºä¸åŸå§‹å­—ç¬¦ä¸²
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>æ ‘çŠ¶æ•°ç»„</title>
    <link href="http://pjpjsocute.github.io/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/"/>
    <id>http://pjpjsocute.github.io/2023/05/15/æ•°æ®ç»“æ„/bit/</id>
    <published>2023-05-15T09:30:14.000Z</published>
    <updated>2023-05-15T15:42:56.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨"><a href="#æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨" class="headerlink" title="æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨"></a>æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨</h2><h3 id="ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„"><a href="#ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„"></a>ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„</h3><h4 id="æ€è€ƒä»¥ä¸‹é—®é¢˜"><a href="#æ€è€ƒä»¥ä¸‹é—®é¢˜" class="headerlink" title="æ€è€ƒä»¥ä¸‹é—®é¢˜"></a>æ€è€ƒä»¥ä¸‹é—®é¢˜</h4><p><strong>QA</strong>:<br>å‡è®¾å­˜åœ¨ä¸€ä¸ªæ•´æ•°åºåˆ— inputï¼Œä¾‹å¦‚ <code>intput = [1,2,7,4,3]</code>ï¼Œè¦æ±‚å‰ K ä¸ªæ•°çš„å’Œã€‚</p><p><strong>Solution</strong>:<br>ä¸€èˆ¬æˆ‘ä»¬ä¼šæ±‚ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ <code>preSumArray</code>ï¼Œå…¶ä¸­ <code>preSumArray[i]</code> ä»£è¡¨å‰ <code>i</code> ä¸ªæ•°çš„å’Œã€‚<br>è¿™æ ·æˆ‘ä»¬æ±‚å‰ N ä¸ªæ•°çš„å’Œåªéœ€è¦è¿”å› <code>preSumArray[N]</code>ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚å¦‚æœéœ€è¦æŸ¥è¯¢ K æ¬¡ï¼Œåˆ™å¤æ‚åº¦ä¸º O(K)ã€‚</p><h4 id="å‡çº§è¿™ä¸ªé—®é¢˜"><a href="#å‡çº§è¿™ä¸ªé—®é¢˜" class="headerlink" title="å‡çº§è¿™ä¸ªé—®é¢˜"></a>å‡çº§è¿™ä¸ªé—®é¢˜</h4><p><strong>QA</strong>:<br>å‡è®¾å­˜åœ¨ä¸€ä¸ªæ•´æ•°åºåˆ— inputï¼Œä¾‹å¦‚ <code>intput = [1,2,7,4,3]</code>ï¼Œç°åœ¨åœ¨æˆ‘ä»¬è·å–å‰ N ä¸ªæ•°çš„å’Œæ—¶ï¼Œå¯èƒ½ä¼šå…ˆå°† <code>i</code> ä½ç½®çš„æ•°å¢åŠ /å‡å°‘ <code>value</code>ã€‚</p><p><strong>Solution</strong>:<br>ä¸€èˆ¬æˆ‘ä»¬ä¼šæ±‚ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ <code>preSumArray</code>ï¼Œå…¶ä¸­ <code>preSumArray[i]</code> ä»£è¡¨å‰ <code>i</code> ä¸ªæ•°çš„å’Œã€‚<br>ä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ <code>i</code> ä½ç½®æ’å…¥ä¸€ä¸ªæ•° <code>x</code>ï¼Œåœ¨è¿›è¡Œæ›´æ–°æ—¶éœ€è¦æ›´æ–° <code>i</code> ä¹‹åçš„æ‰€æœ‰ <code>preSumArray</code>ã€‚<br>æ­¤æ—¶å•æ¬¡çš„æ›´æ–°æ—¶é—´ä¸º O(N)ï¼ŒK æ¬¡æŸ¥è¯¢çš„å¤æ‚åº¦ä¸º O(KN)ã€‚<br>å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ <code>preSumArray</code>ï¼Œé‚£ä¹ˆæ›´æ–°å¤æ‚åº¦ä¸º O(1)ï¼ŒæŸ¥è¯¢å¤æ‚åº¦ä¼šå˜ä¸º O(N)ã€‚</p><p><strong>è¿™æ—¶æ ‘çŠ¶æ•°ç»„å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè§£å†³è¿™ä¸ªé—®é¢˜</strong></p><hr><h4 id="å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨"><a href="#å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨" class="headerlink" title="å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨"></a>å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨</h4><p>äºŒè¿›åˆ¶æœ‰å¾ˆå¤šæœ‰è¶£çš„åº”ç”¨ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸ªç”¨æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lowbit(x) = x &amp; (-x)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¼å­çš„ç›®çš„æ˜¯ <strong>æ±‚å‡ºèƒ½æ•´é™¤ x çš„æœ€å¤§ 2 æ¬¡å¹‚ï¼Œä¹Ÿå°±æ˜¯ x æœ€å³è¾¹çš„ 1</strong>ã€‚</p><p>ä¾‹å­ï¼š</p><ul><li><code>5 &amp; -5 = 1</code></li><li><code>10 &amp; -10 = 2</code></li><li><code>12 &amp; -12 = 4</code></li></ul><hr><h4 id="æ ‘çŠ¶æ•°ç»„ï¼ˆBinary-Indexed-Tree-BITï¼‰"><a href="#æ ‘çŠ¶æ•°ç»„ï¼ˆBinary-Indexed-Tree-BITï¼‰" class="headerlink" title="æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, BITï¼‰"></a>æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, BITï¼‰</h4><h5 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h5><p>æœ¬è´¨ä¸Šå®ƒä»æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸ <code>preSumArray</code> ç›¸ä¼¼ï¼Œå­˜çš„ä¾æ—§æ˜¯å’Œæ•°ç»„ï¼Œä½†æ˜¯å®ƒå­˜æ”¾çš„æ˜¯ <strong>i ä½ä¹‹å‰ (åŒ…æ‹¬ i)ï¼Œlowbit(i) ä¸ªæ•´æ•°çš„å’Œ</strong>ã€‚</p><p><img src="/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/WX20230515-152510@2x.png" alt="WX20230515-152510@2x"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">B(1) = A(1);</span><br><span class="line">B(2) = A(1)+A(2);</span><br><span class="line">B(3) = A(3);</span><br><span class="line">B(4) = A(1)+A(2)+A(3)+A(4);</span><br><span class="line">B(5) = A(5);</span><br><span class="line">B(6) = A(5)+A(6);</span><br><span class="line">B(7) = A(7);</span><br><span class="line">B(8) = A(1)+A(2)+A(3)+A(4)+A(5)+A(6)+A(7)+A(8);</span><br></pre></td></tr></table></figure><blockquote><p>tip: æ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡å¿…é¡»ä» 1 å¼€å§‹</p></blockquote><hr><h5 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h5><p>æ ‘çŠ¶æ•°ç»„ä¸»è¦è§£å†³ä¸¤ä¸ªæ“ä½œï¼š<strong>æ±‚å’Œ</strong> ä¸ <strong>æ›´æ–°</strong>ã€‚</p><h6 id="æ±‚å’Œ"><a href="#æ±‚å’Œ" class="headerlink" title="æ±‚å’Œ"></a>æ±‚å’Œ</h6><p>ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getSum(7) = A(1)+...+A(7) = B(4)+B(6)+B(7)</span><br><span class="line">getSum(6) = B(4)+B(6)</span><br></pre></td></tr></table></figure><p>å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &gt; <span class="number">0</span>; i -= lowbit(i)) &#123;</span><br><span class="line">        res += bit[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€’å½’å½¢å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bit[x] + getSum(x - lowbit(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤æ‚åº¦ï¼šO(logN)  </p><p>å¦‚æœè¦æ±‚ <code>sum(i,j)</code>ï¼Œåªéœ€è¦ <code>getSum(j) - getSum(i-1)</code>ã€‚</p><hr><h6 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h6><p>ä¾‹å­ï¼š<code>update(6,7)</code>ï¼Œå³åœ¨ä½ç½® 6 åŠ ä¸Š 7ï¼Œéœ€è¦æ›´æ–° <code>B(6)</code> å’Œ <code>B(8)</code>ã€‚</p><p>å®ç°ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &lt; bit.length; i += lowbit(i)) &#123;</span><br><span class="line">        bit[i] += value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="åŠ›æ‰£ä¸­çš„åº”ç”¨"><a href="#åŠ›æ‰£ä¸­çš„åº”ç”¨" class="headerlink" title="åŠ›æ‰£ä¸­çš„åº”ç”¨"></a>åŠ›æ‰£ä¸­çš„åº”ç”¨</h3><h4 id="LeetCode-493"><a href="#LeetCode-493" class="headerlink" title="LeetCode-493"></a>LeetCode-493</h4><p><strong>QA</strong>:<br>ç»™å®šä¸€ä¸ªæ•°ç»„ <code>nums</code> ï¼Œå¦‚æœ <code>i &lt; j</code> ä¸” <code>nums[i] &gt; 2*nums[j]</code> æˆ‘ä»¬å°±å°† <code>(i, j)</code> ç§°ä½œä¸€ä¸ª <strong>é‡è¦ç¿»è½¬å¯¹</strong>ã€‚<br>è¿”å›ç»™å®šæ•°ç»„ä¸­çš„é‡è¦ç¿»è½¬å¯¹çš„æ•°é‡ã€‚</p><p><strong>Input:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: [1,3,2,3,1]</span><br><span class="line">è¾“å‡º: 2</span><br></pre></td></tr></table></figure><p><strong>Solution</strong>:</p><p>é¢˜ç›®å¯ä»¥è½¬æ¢ä¸ºæ±‚ <strong>åœ¨ j å…ƒç´ å·¦è¾¹æ¯”å®ƒ 2 å€å¤§çš„å…ƒç´ æœ‰å‡ ä¸ª</strong>ï¼Œå¹¶æ±‚å’Œã€‚</p><ol><li>å°†æ•°ç»„æ’åºå¹¶ç¦»æ•£åŒ–æ˜ å°„ä¸º 1-n çš„æœ‰åºåºåˆ—ã€‚</li><li>ç»Ÿè®¡æ¯ä¸ªæ•°çš„å‡ºç°æ¬¡æ•°ã€‚</li><li>æ±‚å‰ç¼€å’Œï¼Œå¾—åˆ°æ˜ å°„åçš„ä¸ªæ•°ã€‚</li></ol><p><strong>Code</strong>:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TrieArr</span> &#123;</span><br><span class="line">        <span class="type">long</span>[] arr;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TrieArr</span><span class="params">(<span class="type">int</span> n)</span> &#123; arr = <span class="keyword">new</span> <span class="title class_">long</span>[n]; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lowbit</span><span class="params">(<span class="type">int</span> x)</span> &#123; <span class="keyword">return</span> x &amp; -x; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(x &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">int</span>)(arr[x] + getSum(x - lowbit(x)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> c)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &lt; arr.length; i += lowbit(i)) arr[i] += c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">reversePairs</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        Map&lt;Long,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        TreeSet&lt;Long&gt; set = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i: nums) &#123;</span><br><span class="line">            set.add((<span class="type">long</span>)i);</span><br><span class="line">            set.add((<span class="type">long</span>)i * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(!set.isEmpty()) &#123;</span><br><span class="line">            map.put(set.pollFirst(), index++);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TrieArr</span> <span class="variable">bit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrieArr</span>(map.size()+<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">target</span> <span class="operator">=</span> (<span class="type">long</span>)nums[i] * <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> map.get(target);</span><br><span class="line">            ans += bit.getSum(map.size()) - bit.getSum(l);</span><br><span class="line">            bit.update(map.get((<span class="type">long</span>)nums[i]), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="ç±»ä¼¼é—®é¢˜"><a href="#ç±»ä¼¼é—®é¢˜" class="headerlink" title="ç±»ä¼¼é—®é¢˜"></a>ç±»ä¼¼é—®é¢˜</h4><ul><li>LeetCode-307 ç­‰</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨&quot;&gt;&lt;a href=&quot;#æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨&quot; class=&quot;headerlink&quot; title=&quot;æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨&quot;&gt;&lt;/a&gt;æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨&lt;/h2&gt;&lt;h3 id=&quot;ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘
      
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="æ ‘çŠ¶æ•°ç»„" scheme="http://pjpjsocute.github.io/tags/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/"/>
    
  </entry>
  
  <entry>
    <title>ä»¥LeetCode_813ä¸ºä¾‹,ä»é€’å½’åˆ°è®°å¿†åŒ–é€’å½’åˆ°DP</title>
    <link href="http://pjpjsocute.github.io/2023/05/13/LeetCode/LeetCode-813/"/>
    <id>http://pjpjsocute.github.io/2023/05/13/LeetCode/LeetCode-813/</id>
    <published>2023-05-13T08:14:10.000Z</published>
    <updated>2023-05-12T16:34:45.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™å®šæ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ã€‚æˆ‘ä»¬å°†ç»™å®šçš„æ•°ç»„ <code>nums</code> åˆ†æˆ <strong>æœ€å¤š</strong> <code>k</code> ä¸ªç›¸é‚»çš„éç©ºå­æ•°ç»„ ã€‚ <strong>åˆ†æ•°</strong> ç”±æ¯ä¸ªå­æ•°ç»„å†…çš„å¹³å‡å€¼çš„æ€»å’Œæ„æˆã€‚</p><p>æ³¨æ„æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>nums</code> æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”åˆ†æ•°ä¸ä¸€å®šéœ€è¦æ˜¯æ•´æ•°ã€‚</p><p>è¿”å›æˆ‘ä»¬æ‰€èƒ½å¾—åˆ°çš„æœ€å¤§ <strong>åˆ†æ•°</strong> æ˜¯å¤šå°‘ã€‚ç­”æ¡ˆè¯¯å·®åœ¨ <code>10-6</code> å†…è¢«è§†ä¸ºæ˜¯æ­£ç¡®çš„ã€‚</p><span id="more"></span><h3 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: nums = [9,1,2,3,9], k = 3</span><br><span class="line">è¾“å‡º: 20.00000</span><br><span class="line">è§£é‡Š: </span><br><span class="line">nums çš„æœ€ä¼˜åˆ†ç»„æ˜¯[9], [1, 2, 3], [9]. å¾—åˆ°çš„åˆ†æ•°æ˜¯ 9 + (1 + 2 + 3) / 3 + 9 = 20. </span><br><span class="line">æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ nums åˆ†æˆ[9, 1], [2], [3, 9]. </span><br><span class="line">è¿™æ ·çš„åˆ†ç»„å¾—åˆ°çš„åˆ†æ•°ä¸º 5 + 2 + 6 = 13, ä½†ä¸æ˜¯æœ€å¤§å€¼.</span><br></pre></td></tr></table></figure><h3 id="S"><a href="#S" class="headerlink" title="S:"></a>S:</h3><h4 id="ä¸€"><a href="#ä¸€" class="headerlink" title="ä¸€"></a>ä¸€</h4><p>è§£å†³è¿™ä¸ªé—®é¢˜æœ€ç›´è§‚çš„æƒ³æ³•æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—ä¸¾æ¯ä¸ªæ¡ˆä¾‹ï¼Œæœ€åå¾—åˆ°æœ€ä¼˜ç­”æ¡ˆã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é€’å½’æšä¸¾æ¥è§£å†³é—®é¢˜ï¼Œé€šè¿‡æšä¸¾æ¯ä¸ªåˆ†åŒºçš„æƒ…å†µï¼Œå¾—åˆ°æœ€ç»ˆçš„æœ€å¤§å€¼<br>é€’å½’ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">largestSumOfAverages</span><span class="params">(<span class="type">int</span>[] A, <span class="type">int</span> K)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dfs(A, <span class="number">0</span>, K);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> A[] ,<span class="type">int</span> index,<span class="type">int</span> K)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(K==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(K==<span class="number">1</span>)&#123;<span class="comment">// k=1æ—¶ç›´æ¥è¿”å›æ•´ä¸ªæ•°ç»„çš„å‡å€¼</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=index;i&lt;A.length;i++)&#123;</span><br><span class="line">                sum+=A[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">double</span>)sum/(A.length-index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=index;i&lt;=A.length-K;i++)&#123;</span><br><span class="line">            sum+=A[i];<span class="comment">//æšä¸¾æ¯ä¸ªåˆ†ç¦»ç‚¹</span></span><br><span class="line">            <span class="type">double</span> <span class="variable">avage</span> <span class="operator">=</span> sum/(i-index+<span class="number">1</span>);</span><br><span class="line">            <span class="type">double</span> <span class="variable">temp</span> <span class="operator">=</span> dfs(A,i+<span class="number">1</span>,K-<span class="number">1</span>);<span class="comment">//ä¸‹ä¸€ä¸ªç»„çš„å‡å€¼</span></span><br><span class="line">            res = Math.max(res, avage+temp);<span class="comment">//å–æœ€å¤§</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>)res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="äºŒ"><a href="#äºŒ" class="headerlink" title="äºŒ"></a>äºŒ</h4><p>â€‹        åœ¨æœ¬é¢˜ä¸­ï¼Œé€’å½’ä¼šè¶…æ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé€’å½’éƒ½ä¸æ˜¯æœ€ä¼˜è§£ï¼Œå› ä¸ºä»–ä¼šè¿›è¡Œè®¸å¤šé‡å¤è¿ç®—ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®°å¿†åŒ–é€’å½’ï¼Œæ‰€è°“è®°å¿†åŒ–å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªæ•°ç»„è®°å½•è¿‡å·²ç»å¾—åˆ°çš„é€’å½’å€¼ï¼Œå½“å†æ¬¡è¿›å…¥è¯¥åˆ†æ”¯åå¯ä»¥å¿«é€Ÿå¾—åˆ°è§£ã€‚ åœ¨ç†è§£äº†ä¸Šé¢çš„é€’å½’ä»£ç åç¨å¾®ä¿®æ”¹ä¸€ä¸‹å¯ä»¥å¾ˆå®¹æ˜“å¾—åˆ°è®°å¿†åŒ–é€’å½’ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="type">double</span> [][] memo ;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">largestSumOfAverages</span><span class="params">(<span class="type">int</span>[] A, <span class="type">int</span> K)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.memo = <span class="keyword">new</span> <span class="title class_">double</span> [A.length+<span class="number">1</span>][K+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">return</span> dfs(A, <span class="number">0</span>, K);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> A[] ,<span class="type">int</span> index,<span class="type">int</span> K)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(K==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(memo[index][K]!=<span class="number">0.0</span>)   <span class="keyword">return</span> memo[index][K];</span><br><span class="line">        <span class="keyword">if</span>(K==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=index;i&lt;A.length;i++)&#123;</span><br><span class="line">                sum+=A[i];</span><br><span class="line">            &#125;</span><br><span class="line">            memo[index][K] = (<span class="type">double</span>)sum/(A.length-index);</span><br><span class="line">            <span class="keyword">return</span> memo[index][K];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="type">double</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=index;i&lt;=A.length-K;i++)&#123;</span><br><span class="line">            sum+=A[i];</span><br><span class="line">            <span class="type">double</span> <span class="variable">avage</span> <span class="operator">=</span> sum/(i-index+<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// double temp = dfs(A,i+1,K-1);</span></span><br><span class="line">            <span class="comment">// memo[i+1][K-1] = temp;</span></span><br><span class="line">            memo[i+<span class="number">1</span>][K-<span class="number">1</span>] = dfs(A,i+<span class="number">1</span>,K-<span class="number">1</span>);</span><br><span class="line">            res = Math.max(res, avage+memo[i+<span class="number">1</span>][K-<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        memo[index][K] =res;</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">double</span>)res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¸‰"><a href="#ä¸‰" class="headerlink" title="ä¸‰"></a>ä¸‰</h4><p>â€‹        è®°å¿†é€’å½’å®é™…ä¸Šä¸åŠ¨æ€è§„åˆ’éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯è‡ªä¸Šè€Œä¸‹çš„è¡¨æ³•ï¼Œå¦ä¸€ä¸ªæ˜¯è‡ªä¸‹è€Œä¸Šçš„è¡¨æ³•ã€‚åŸºäºè®°å¿†é€’å½’çš„æ€æƒ³ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®°å¿†é€’å½’æ”¹å†™ä¸ºDP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">double</span> <span class="title function_">largestSumOfAverages</span><span class="params">(<span class="type">int</span>[] A, <span class="type">int</span> K)</span> &#123;</span><br><span class="line">        <span class="type">double</span>[][] dp = <span class="keyword">new</span> <span class="title class_">double</span>[A.length+<span class="number">1</span>][K+<span class="number">1</span>];</span><br><span class="line">        <span class="type">double</span> [] preSum = <span class="keyword">new</span> <span class="title class_">double</span>[A.length+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;A.length;i++)&#123;</span><br><span class="line">            preSum[i+<span class="number">1</span>]= preSum[i]+A[i];</span><br><span class="line">            dp[i+<span class="number">1</span>][<span class="number">1</span>] = preSum[i+<span class="number">1</span>]/(i+<span class="number">1</span>);<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=A.length;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">2</span>;j&lt;=Math.min(K, i);j++)&#123;</span><br><span class="line">                <span class="comment">//dp[i][j]çš„æœ€å¤§å‡å€¼ åº”è¯¥æ˜¯ dp[i&#x27;][j-1]çš„å‡å€¼+i&#x27;-içš„å‡å€¼å’Œ  ä¸­æ‰€æœ‰çš„å¯èƒ½ä¸­çš„æœ€å¤§å€¼</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> <span class="number">0</span>;t&lt;i;t++)&#123;</span><br><span class="line">                    dp[i][j] = Math.max(dp[i][j], dp[t][j-<span class="number">1</span>]+(preSum[i]-preSum[t])/(i-t));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[A.length][K];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Q&quot;&gt;&lt;a href=&quot;#Q&quot; class=&quot;headerlink&quot; title=&quot;Q:&quot;&gt;&lt;/a&gt;Q:&lt;/h3&gt;&lt;p&gt;ç»™å®šæ•°ç»„ &lt;code&gt;nums&lt;/code&gt; å’Œä¸€ä¸ªæ•´æ•° &lt;code&gt;k&lt;/code&gt; ã€‚æˆ‘ä»¬å°†ç»™å®šçš„æ•°ç»„ &lt;code&gt;nums&lt;/code&gt; åˆ†æˆ &lt;strong&gt;æœ€å¤š&lt;/strong&gt; &lt;code&gt;k&lt;/code&gt; ä¸ªç›¸é‚»çš„éç©ºå­æ•°ç»„ ã€‚ &lt;strong&gt;åˆ†æ•°&lt;/strong&gt; ç”±æ¯ä¸ªå­æ•°ç»„å†…çš„å¹³å‡å€¼çš„æ€»å’Œæ„æˆã€‚&lt;/p&gt;
&lt;p&gt;æ³¨æ„æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ &lt;code&gt;nums&lt;/code&gt; æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”åˆ†æ•°ä¸ä¸€å®šéœ€è¦æ˜¯æ•´æ•°ã€‚&lt;/p&gt;
&lt;p&gt;è¿”å›æˆ‘ä»¬æ‰€èƒ½å¾—åˆ°çš„æœ€å¤§ &lt;strong&gt;åˆ†æ•°&lt;/strong&gt; æ˜¯å¤šå°‘ã€‚ç­”æ¡ˆè¯¯å·®åœ¨ &lt;code&gt;10-6&lt;/code&gt; å†…è¢«è§†ä¸ºæ˜¯æ­£ç¡®çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="Dp" scheme="http://pjpjsocute.github.io/tags/Dp/"/>
    
      <category term="é€’å½’" scheme="http://pjpjsocute.github.io/tags/%E9%80%92%E5%BD%92/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-862</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-381/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-381/</id>
    <published>2023-05-12T09:14:10.000Z</published>
    <updated>2023-05-12T16:30:33.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p><code>RandomizedCollection</code> æ˜¯ä¸€ç§åŒ…å«æ•°å­—é›†åˆ(å¯èƒ½æ˜¯é‡å¤çš„)çš„æ•°æ®ç»“æ„ã€‚å®ƒåº”è¯¥æ”¯æŒæ’å…¥å’Œåˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä»¥åŠåˆ é™¤éšæœºå…ƒç´ ã€‚</p><p>å®ç° <code>RandomizedCollection</code> ç±»:</p><ul><li><code>RandomizedCollection()</code>åˆå§‹åŒ–ç©ºçš„ <code>RandomizedCollection</code> å¯¹è±¡ã€‚</li><li><code>bool insert(int val)</code> å°†ä¸€ä¸ª <code>val</code> é¡¹æ’å…¥åˆ°é›†åˆä¸­ï¼Œå³ä½¿è¯¥é¡¹å·²ç»å­˜åœ¨ã€‚å¦‚æœè¯¥é¡¹ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>true</code> ï¼Œå¦åˆ™è¿”å› <code>false</code> ã€‚</li><li><code>bool remove(int val)</code> å¦‚æœå­˜åœ¨ï¼Œä»é›†åˆä¸­ç§»é™¤ä¸€ä¸ª <code>val</code> é¡¹ã€‚å¦‚æœè¯¥é¡¹å­˜åœ¨ï¼Œåˆ™è¿”å› <code>true</code> ï¼Œå¦åˆ™è¿”å› <code>false</code> ã€‚æ³¨æ„ï¼Œå¦‚æœ <code>val</code> åœ¨é›†åˆä¸­å‡ºç°å¤šæ¬¡ï¼Œæˆ‘ä»¬åªåˆ é™¤å…¶ä¸­ä¸€ä¸ªã€‚</li><li><code>int getRandom()</code> ä»å½“å‰çš„å¤šä¸ªå…ƒç´ é›†åˆä¸­è¿”å›ä¸€ä¸ªéšæœºå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´ è¢«è¿”å›çš„æ¦‚ç‡ä¸é›†åˆä¸­åŒ…å«çš„ç›¸åŒå€¼çš„æ•°é‡ <strong>çº¿æ€§ç›¸å…³</strong> ã€‚</li></ul><p>æ‚¨å¿…é¡»å®ç°ç±»çš„å‡½æ•°ï¼Œä½¿æ¯ä¸ªå‡½æ•°çš„ <strong>å¹³å‡</strong> æ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code> ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œåªæœ‰åœ¨ <code>RandomizedCollection</code> ä¸­ <strong>è‡³å°‘æœ‰ä¸€é¡¹</strong> æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ <code>getRandom</code> ã€‚</p><span id="more"></span><h3 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥</span><br><span class="line">[&quot;RandomizedCollection&quot;, &quot;insert&quot;, &quot;insert&quot;, &quot;insert&quot;, &quot;getRandom&quot;, &quot;remove&quot;, &quot;getRandom&quot;]</span><br><span class="line">[[], [1], [1], [2], [], [1], []]</span><br><span class="line">è¾“å‡º</span><br><span class="line">[null, true, false, true, 2, true, 1]</span><br><span class="line"></span><br><span class="line">è§£é‡Š</span><br><span class="line">RandomizedCollection collection = new RandomizedCollection();// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„é›†åˆã€‚</span><br><span class="line">collection.insert(1);   // è¿”å› trueï¼Œå› ä¸ºé›†åˆä¸åŒ…å« 1ã€‚</span><br><span class="line">                        // å°† 1 æ’å…¥åˆ°é›†åˆä¸­ã€‚</span><br><span class="line">collection.insert(1);   // è¿”å› falseï¼Œå› ä¸ºé›†åˆåŒ…å« 1ã€‚</span><br><span class="line">                        // å°†å¦ä¸€ä¸ª 1 æ’å…¥åˆ°é›†åˆä¸­ã€‚é›†åˆç°åœ¨åŒ…å« [1,1]ã€‚</span><br><span class="line">collection.insert(2);   // è¿”å› trueï¼Œå› ä¸ºé›†åˆä¸åŒ…å« 2ã€‚</span><br><span class="line">                        // å°† 2 æ’å…¥åˆ°é›†åˆä¸­ã€‚é›†åˆç°åœ¨åŒ…å« [1,1,2]ã€‚</span><br><span class="line">collection.getRandom(); // getRandom åº”å½“:</span><br><span class="line">                        // æœ‰ 2/3 çš„æ¦‚ç‡è¿”å› 1,</span><br><span class="line">                        // 1/3 çš„æ¦‚ç‡è¿”å› 2ã€‚</span><br><span class="line">collection.remove(1);   // è¿”å› trueï¼Œå› ä¸ºé›†åˆåŒ…å« 1ã€‚</span><br><span class="line">                        // ä»é›†åˆä¸­ç§»é™¤ 1ã€‚é›†åˆç°åœ¨åŒ…å« [1,2]ã€‚</span><br><span class="line">collection.getRandom(); // getRandom åº”è¯¥è¿”å› 1 æˆ– 2ï¼Œä¸¤è€…çš„å¯èƒ½æ€§ç›¸åŒã€‚</span><br></pre></td></tr></table></figure><h3 id="S"><a href="#S" class="headerlink" title="S:"></a>S:</h3><p>å› ä¸ºé¢˜ç›®æ’å…¥æ—¶éœ€è¦æŸ¥æ‰¾å€¼æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°æŸ¥æ‰¾ä¸ºO1ï¼Œé‚£ä¹ˆæœ‰listå’Œhashmapï¼ˆlisté€šè¿‡ç´¢å¼•ï¼‰å¯ä»¥å®Œæˆã€‚</p><p>ä½†æ˜¯ç”±äºlistæ— æ³•ç›´æ¥O1æŸ¥æ‰¾å…ƒç´ å€¼ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘listå’Œhashmapè”åˆä½¿ç”¨ã€‚</p><p>mapå­˜ï¼ˆå€¼ï¼Œç´¢å¼•ï¼‰ï¼Œlistå­˜å€¼ã€‚ </p><p>ç”±äºliståªæœ‰åœ¨åˆ é™¤å°¾å…ƒç´ æ—¶èƒ½å¤Ÿå®ç°O1ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å¾…åˆ é™¤å…ƒç´ ä¸é˜Ÿå°¾å…ƒç´ äº’æ¢ï¼Œç„¶ååˆ é™¤ mapä¸­å­˜çš„æ˜¯å€¼ä¸ç´¢å¼•é”®å€¼å¯¹ã€‚</p><p>å› ä¸ºä¸€ä¸ªå€¼å¯èƒ½å­˜åœ¨å¤šä¸ªç´¢å¼•ï¼Œæ‰€ä»¥ç´¢å¼•ä¹Ÿéœ€è¦ç”¨ä¸€ä¸ªé›†åˆå°è£…ã€‚</p><p> è€ƒè™‘åˆ°ä¸€ä¸ªå€¼ä¸ä¼šæœ‰2ä¸ªç›¸åŒç´¢å¼•ï¼Œå¹¶ä¸”åœ¨åˆ é™¤äº¤æ¢ç­‰æ“ä½œæ—¶éœ€è¦å¯¹å€¼å¾—ç´¢å¼•ä¹Ÿè¿›è¡Œåˆ é™¤ç­‰æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨setæ¥ä¿å­˜ç´¢å¼•åºåˆ—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RandomizedCollection</span> &#123;</span><br><span class="line">    <span class="type">int</span> n ;<span class="comment">//å½“å‰é›†åˆå¤§å°</span></span><br><span class="line">    HashMap&lt;Integer,Set&lt;Integer&gt;&gt;map;</span><br><span class="line">    ArrayList&lt;Integer&gt;list;</span><br><span class="line">    Random random;</span><br><span class="line">    <span class="comment">/** Initialize your data structure here. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RandomizedCollection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.random = <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="built_in">this</span>.n = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Inserts a value to the collection. Returns true if the collection did not already contain the specified element. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="type">Set</span> <span class="variable">set</span> <span class="operator">=</span> map.get(val);</span><br><span class="line">        <span class="keyword">if</span>(set==<span class="literal">null</span>)   set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        set.add(n);<span class="comment">//æ·»åŠ ç´¢å¼•</span></span><br><span class="line">        list.add(val);</span><br><span class="line">        map.put(val, set);</span><br><span class="line">        n++;</span><br><span class="line">        <span class="keyword">return</span> set.size()==<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Removes a value from the collection. Returns true if the collection contained the specified element. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(map.containsKey(val))&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastIndex</span> <span class="operator">=</span> n-<span class="number">1</span>;<span class="comment">//å¾—åˆ°æœ€å2ä¸ªå€¼ç´¢å¼•</span></span><br><span class="line">            <span class="type">Set</span> <span class="variable">lastset</span> <span class="operator">=</span> map.get(list.get(lastIndex));</span><br><span class="line">            <span class="type">Set</span> <span class="variable">set</span> <span class="operator">=</span> map.get(val);</span><br><span class="line">            <span class="type">int</span> <span class="variable">currIndex</span> <span class="operator">=</span> (<span class="type">int</span>)set.iterator().next();<span class="comment">//å¾—åˆ°å½“å‰å€¼ç´¢å¼•</span></span><br><span class="line">            <span class="comment">//è¿›è¡Œåˆ é™¤æ“ä½œ</span></span><br><span class="line">            swap(list, currIndex, lastIndex);</span><br><span class="line">            list.remove(n-<span class="number">1</span>);<span class="comment">//å°†å…¶åœ¨åˆ—è¡¨ä¸­åˆ é™¤</span></span><br><span class="line">            set.remove(currIndex);<span class="comment">//åˆ é™¤åŸå€¼</span></span><br><span class="line">            <span class="keyword">if</span>(set.size()==<span class="number">0</span>)   map.remove(val);<span class="comment">//åœ¨å›¾ä¸­åˆ é™¤</span></span><br><span class="line">            <span class="comment">//ä¿®æ”¹æœ€åä¸€ä¸ªå€¼çš„ç´¢å¼•</span></span><br><span class="line">            lastset.remove(n-<span class="number">1</span>);</span><br><span class="line">            lastset.add(currIndex);</span><br><span class="line">            n--;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** Get a random element from the collection. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRandom</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list.get(random.nextInt(n));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(List&lt;Integer&gt; list ,<span class="type">int</span> i,<span class="type">int</span> j)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">        list.set(i, list.get(j));</span><br><span class="line">        list.set(j, temp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Q&quot;&gt;&lt;a href=&quot;#Q&quot; class=&quot;headerlink&quot; title=&quot;Q:&quot;&gt;&lt;/a&gt;Q:&lt;/h3&gt;&lt;p&gt;&lt;code&gt;RandomizedCollection&lt;/code&gt; æ˜¯ä¸€ç§åŒ…å«æ•°å­—é›†åˆ(å¯èƒ½æ˜¯é‡å¤çš„)çš„æ•°æ®ç»“æ„ã€‚å®ƒåº”è¯¥æ”¯æŒæ’å…¥å’Œåˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä»¥åŠåˆ é™¤éšæœºå…ƒç´ ã€‚&lt;/p&gt;
&lt;p&gt;å®ç° &lt;code&gt;RandomizedCollection&lt;/code&gt; ç±»:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;RandomizedCollection()&lt;/code&gt;åˆå§‹åŒ–ç©ºçš„ &lt;code&gt;RandomizedCollection&lt;/code&gt; å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bool insert(int val)&lt;/code&gt; å°†ä¸€ä¸ª &lt;code&gt;val&lt;/code&gt; é¡¹æ’å…¥åˆ°é›†åˆä¸­ï¼Œå³ä½¿è¯¥é¡¹å·²ç»å­˜åœ¨ã€‚å¦‚æœè¯¥é¡¹ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› &lt;code&gt;true&lt;/code&gt; ï¼Œå¦åˆ™è¿”å› &lt;code&gt;false&lt;/code&gt; ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bool remove(int val)&lt;/code&gt; å¦‚æœå­˜åœ¨ï¼Œä»é›†åˆä¸­ç§»é™¤ä¸€ä¸ª &lt;code&gt;val&lt;/code&gt; é¡¹ã€‚å¦‚æœè¯¥é¡¹å­˜åœ¨ï¼Œåˆ™è¿”å› &lt;code&gt;true&lt;/code&gt; ï¼Œå¦åˆ™è¿”å› &lt;code&gt;false&lt;/code&gt; ã€‚æ³¨æ„ï¼Œå¦‚æœ &lt;code&gt;val&lt;/code&gt; åœ¨é›†åˆä¸­å‡ºç°å¤šæ¬¡ï¼Œæˆ‘ä»¬åªåˆ é™¤å…¶ä¸­ä¸€ä¸ªã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;int getRandom()&lt;/code&gt; ä»å½“å‰çš„å¤šä¸ªå…ƒç´ é›†åˆä¸­è¿”å›ä¸€ä¸ªéšæœºå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´ è¢«è¿”å›çš„æ¦‚ç‡ä¸é›†åˆä¸­åŒ…å«çš„ç›¸åŒå€¼çš„æ•°é‡ &lt;strong&gt;çº¿æ€§ç›¸å…³&lt;/strong&gt; ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ‚¨å¿…é¡»å®ç°ç±»çš„å‡½æ•°ï¼Œä½¿æ¯ä¸ªå‡½æ•°çš„ &lt;strong&gt;å¹³å‡&lt;/strong&gt; æ—¶é—´å¤æ‚åº¦ä¸º &lt;code&gt;O(1)&lt;/code&gt; ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ³¨æ„ï¼š&lt;/strong&gt;ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œåªæœ‰åœ¨ &lt;code&gt;RandomizedCollection&lt;/code&gt; ä¸­ &lt;strong&gt;è‡³å°‘æœ‰ä¸€é¡¹&lt;/strong&gt; æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ &lt;code&gt;getRandom&lt;/code&gt; ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-862</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-862/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-862/</id>
    <published>2023-05-12T08:14:10.000Z</published>
    <updated>2023-05-12T08:26:38.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ï¼Œæ‰¾å‡º <code>nums</code> ä¸­å’Œè‡³å°‘ä¸º <code>k</code> çš„ <strong>æœ€çŸ­éç©ºå­æ•°ç»„</strong> ï¼Œå¹¶è¿”å›è¯¥å­æ•°ç»„çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„ <strong>å­æ•°ç»„</strong> ï¼Œè¿”å› <code>-1</code> ã€‚</p><p><strong>å­æ•°ç»„</strong> æ˜¯æ•°ç»„ä¸­ <strong>è¿ç»­</strong> çš„ä¸€éƒ¨åˆ†ã€‚</p><span id="more"></span><h3 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [2,-1,2], k = 3</span><br><span class="line">è¾“å‡ºï¼š3</span><br></pre></td></tr></table></figure><h3 id="S"><a href="#S" class="headerlink" title="S:"></a>S:</h3><p>â€‹    æ±‚è¿ç»­å­åºåˆ—çš„å’Œï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨å‰ç¼€å’Œã€‚</p><p>â€‹    å› ä¸ºæ•°ç»„æ˜¯å­˜åœ¨æ­£è´Ÿçš„ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨äºŒåˆ†ï¼Œè€Œæš´åŠ›ç ´è§£ä¼šè¶…æ—¶ã€‚</p><h4 id="ä¼˜åŒ–ï¼š"><a href="#ä¼˜åŒ–ï¼š" class="headerlink" title="ä¼˜åŒ–ï¼š"></a><strong>ä¼˜åŒ–ï¼š</strong></h4><p>â€‹    å› ä¸ºæ˜¯æ±‚åŒºé—´æœ€çŸ­ï¼Œå¯ä»¥å¾ˆæ˜¾ç„¶å¯ä»¥æƒ³åˆ°æ»‘åŠ¨çª—ï¼Œä½†æ˜¯è¿™ä¸ªæ•°ç»„å¹¶ä¸æ»¡è¶³å•è°ƒæ€§ï¼š</p><p>â€‹        æ•°ç»„ä¸­å­˜åœ¨<strong>è´Ÿæ•°</strong>ï¼Œå¯¼è‡´çª—å£å€¼<strong>ä¸å•è°ƒ</strong>ï¼Œä½†æ˜¯å› ä¸ºæœ‰è´Ÿæ•°æ‰€ä»¥æ‰ä¼šå¯¼è‡´å½“æˆ‘ä»¬æ‰¾åˆ°æŸä¸ªçª—å£å’Œä¸ºKï¼Œçª—å†…ä¾ç„¶å¯èƒ½å­˜åœ¨å¯è¡Œè§£ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><p>â€‹    <strong>å¯¹äºç´¢å¼•$i_j$å‰é¢æ»¡è¶³â‰¥Kçš„æ‰€æœ‰ç´¢å¼•${i_{0-j}}$ï¼Œ</strong></p><p>â€‹    <strong>å¦‚æœ$i_1$&lt;$i_2$ï¼Œarr[$i_1$]&gt;arr[$i_2$],</strong></p><p>â€‹    <strong>é‚£ä¹ˆå¯è¡Œè§£ä¸€å®šæ˜¯$i_2$ï¼Œ</strong></p><p>â€‹    <strong>å› ä¸º$i_2$æ›´å¤§ä¸”arr[$i_2$]æ›´å°</strong></p><p>æ‰€ä»¥<strong>æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªå•è°ƒé˜Ÿåˆ—ä¿è¯çª—å£å†…å€¼çš„å•è°ƒæ€§ï¼š</strong></p><h4 id="æ€è·¯ï¼š"><a href="#æ€è·¯ï¼š" class="headerlink" title="æ€è·¯ï¼š"></a>æ€è·¯ï¼š</h4><p>â€‹    åŸºäºæˆ‘ä»¬æ€»æ˜¯å¸Œæœ›å¯¹äºæ¯ä¸ªå³æŒ‡é’ˆjï¼Œå·¦æŒ‡é’ˆèƒ½å¤Ÿå°½å¯èƒ½çš„é è¿‘ï¼Œå¹¶ä¸”å€¼å°½å¯èƒ½åœ°å¤§ã€‚</p><p>â€‹    å¦‚æœæœ‰ä¸€ä¸ªi-1çš„å€¼ &gt;i å¤„çš„å€¼ï¼Œé‚£ä¹ˆi-1å¤„çš„å€¼å°±ä¸€å®šä¸æ˜¯æ­£ç¡®è§£ï¼Œå› ä¸ºiå¤„çš„å€¼æ›´è¿‘å¹¶ä¸”èƒ½å¤Ÿå¾—åˆ°çš„æ•°ç»„å’Œæ›´å¤§ï¼Œå¦‚æœi-1æ»¡è¶³iä¸€å®šæ»¡è¶³ï¼Œä»¥æ­¤æ¥å‡å°‘æˆ‘ä»¬çš„åˆ¤æ–­é‡</p><p>â€‹    å¦‚æœé˜Ÿé¦–çš„å€¼æ»¡è¶³å½“å‰å€¼-é˜Ÿé¦–å€¼&gt;=K,è®°å½•é•¿åº¦å¹¶å¼¹å‡ºé˜Ÿé¦–</p><p>â€‹    å¦‚æœå½“å‰å€¼&lt;é˜Ÿåˆ—å°¾ï¼Œé‚£ä¹ˆå¼¹å‡ºé˜Ÿå°¾ä¿æŒé˜Ÿåˆ—å•è°ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">shortestSubarray</span><span class="params">(<span class="type">int</span>[] A, <span class="type">int</span> K)</span> &#123;</span><br><span class="line">        <span class="type">long</span> [] arr = <span class="keyword">new</span> <span class="title class_">long</span> [A.length+<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;A.length;i++)&#123;</span><br><span class="line">            arr[i+<span class="number">1</span>] = arr[i]+A[i];</span><br><span class="line">            <span class="keyword">if</span>(A[i]&gt;=K) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="comment">//å¾—åˆ°å‰ç¼€å’Œæ•°ç»„/ get pre sum</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">        <span class="comment">// for(int i=0;i&lt;=A.length-1;i++)&#123;  //æš´åŠ›ç ´è§£ N^2 è¶…æ—¶/O(N^2) out time</span></span><br><span class="line">        <span class="comment">//     for(int j = i+1;j&lt;=A.length;j++)&#123;</span></span><br><span class="line">        <span class="comment">//         if(arr[j]-arr[i]&gt;=K)&#123;</span></span><br><span class="line">        <span class="comment">//             res = Math.min(j-i,res);</span></span><br><span class="line">        <span class="comment">//         &#125;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">      </span><br><span class="line">        Deque&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;arr.length;i++)&#123;</span><br><span class="line">            <span class="keyword">while</span>(!queue.isEmpty()&amp;&amp;arr[i]&lt;=arr[queue.getLast()])   queue.removeLast();</span><br><span class="line">            <span class="keyword">while</span>(!queue.isEmpty()&amp;&amp;arr[i]-arr[queue.peek()]&gt;=K)    res = Math.min(res,i-queue.poll());</span><br><span class="line">            queue.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res==Integer.MAX_VALUE?-<span class="number">1</span>:res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Q&quot;&gt;&lt;a href=&quot;#Q&quot; class=&quot;headerlink&quot; title=&quot;Q:&quot;&gt;&lt;/a&gt;Q:&lt;/h3&gt;&lt;p&gt;ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ &lt;code&gt;nums&lt;/code&gt; å’Œä¸€ä¸ªæ•´æ•° &lt;code&gt;k&lt;/code&gt; ï¼Œæ‰¾å‡º &lt;code&gt;nums&lt;/code&gt; ä¸­å’Œè‡³å°‘ä¸º &lt;code&gt;k&lt;/code&gt; çš„ &lt;strong&gt;æœ€çŸ­éç©ºå­æ•°ç»„&lt;/strong&gt; ï¼Œå¹¶è¿”å›è¯¥å­æ•°ç»„çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„ &lt;strong&gt;å­æ•°ç»„&lt;/strong&gt; ï¼Œè¿”å› &lt;code&gt;-1&lt;/code&gt; ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å­æ•°ç»„&lt;/strong&gt; æ˜¯æ•°ç»„ä¸­ &lt;strong&gt;è¿ç»­&lt;/strong&gt; çš„ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="å‰ç¼€å’Œ" scheme="http://pjpjsocute.github.io/tags/%E5%89%8D%E7%BC%80%E5%92%8C/"/>
    
      <category term="å•è°ƒé˜Ÿåˆ—" scheme="http://pjpjsocute.github.io/tags/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-406</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-406/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-406/</id>
    <published>2023-05-12T08:13:50.000Z</published>
    <updated>2023-05-12T08:16:05.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>å‡è®¾æœ‰æ‰“ä¹±é¡ºåºçš„ä¸€ç¾¤äººç«™æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ•°ç»„ <code>people</code> è¡¨ç¤ºé˜Ÿåˆ—ä¸­ä¸€äº›äººçš„å±æ€§ï¼ˆä¸ä¸€å®šæŒ‰é¡ºåºï¼‰ã€‚æ¯ä¸ª <code>people[i] = [hi, ki]</code> è¡¨ç¤ºç¬¬ <code>i</code> ä¸ªäººçš„èº«é«˜ä¸º <code>hi</code> ï¼Œå‰é¢ <strong>æ­£å¥½</strong> æœ‰ <code>ki</code> ä¸ªèº«é«˜å¤§äºæˆ–ç­‰äº <code>hi</code> çš„äººã€‚</p><p>è¯·ä½ é‡æ–°æ„é€ å¹¶è¿”å›è¾“å…¥æ•°ç»„ <code>people</code> æ‰€è¡¨ç¤ºçš„é˜Ÿåˆ—ã€‚è¿”å›çš„é˜Ÿåˆ—åº”è¯¥æ ¼å¼åŒ–ä¸ºæ•°ç»„ <code>queue</code> ï¼Œå…¶ä¸­ <code>queue[j] = [hj, kj]</code> æ˜¯é˜Ÿåˆ—ä¸­ç¬¬ <code>j</code> ä¸ªäººçš„å±æ€§ï¼ˆ<code>queue[0]</code> æ˜¯æ’åœ¨é˜Ÿåˆ—å‰é¢çš„äººï¼‰ã€‚</p><span id="more"></span><h4 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼špeople = [[7,0],[4,4],[7,1],[5,0],[6,1],[5,2]]</span><br><span class="line">è¾“å‡ºï¼š[[5,0],[7,0],[5,2],[6,1],[4,4],[7,1]]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">ç¼–å·ä¸º 0 çš„äººèº«é«˜ä¸º 5 ï¼Œæ²¡æœ‰èº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ã€‚</span><br><span class="line">ç¼–å·ä¸º 1 çš„äººèº«é«˜ä¸º 7 ï¼Œæ²¡æœ‰èº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ã€‚</span><br><span class="line">ç¼–å·ä¸º 2 çš„äººèº«é«˜ä¸º 5 ï¼Œæœ‰ 2 ä¸ªèº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ï¼Œå³ç¼–å·ä¸º 0 å’Œ 1 çš„äººã€‚</span><br><span class="line">ç¼–å·ä¸º 3 çš„äººèº«é«˜ä¸º 6 ï¼Œæœ‰ 1 ä¸ªèº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ï¼Œå³ç¼–å·ä¸º 1 çš„äººã€‚</span><br><span class="line">ç¼–å·ä¸º 4 çš„äººèº«é«˜ä¸º 4 ï¼Œæœ‰ 4 ä¸ªèº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ï¼Œå³ç¼–å·ä¸º 0ã€1ã€2ã€3 çš„äººã€‚</span><br><span class="line">ç¼–å·ä¸º 5 çš„äººèº«é«˜ä¸º 7 ï¼Œæœ‰ 1 ä¸ªèº«é«˜æ›´é«˜æˆ–è€…ç›¸åŒçš„äººæ’åœ¨ä»–å‰é¢ï¼Œå³ç¼–å·ä¸º 1 çš„äººã€‚</span><br><span class="line">å› æ­¤ [[5,0],[7,0],[5,2],[6,1],[4,4],[7,1]] æ˜¯é‡æ–°æ„é€ åçš„é˜Ÿåˆ—ã€‚</span><br></pre></td></tr></table></figure><h3 id="S"><a href="#S" class="headerlink" title="S:"></a>S:</h3><p>ä¸€ä¸ªäººæœ‰&lt;h,k&gt;2ä¸ªå±æ€§ï¼Œhä»£è¡¨é«˜åº¦ï¼ŒåŒæ ·çš„é«˜åº¦çš„å‰æä¸‹ï¼Œkå¤§çš„äººåº”è¯¥åœ¨åé¢ã€‚ ä¸ºäº†ç¡®å®š&lt;h,i&gt;åº”è¯¥å»å“ªï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å€’æ’èº«é«˜ï¼Œè¿™æ ·å‰é¢æœ‰å¤šå°‘ä¸ªæ¯”ä»–é«˜çš„äººå°±å·²çŸ¥äº†ã€‚ å‡è®¾æŸä¸ªé˜Ÿåˆ—æ’åˆ°&lt;h,i&gt;ï¼Œå¯¹äºå·²æ’å…¥çš„å‰é¢çš„äººæ¥è¯´ï¼Œèº«é«˜éƒ½â‰¥ä»–ï¼Œæ‰€ä»¥å½“ä»–æ’å…¥ç¬¬iä¸ªä½ç½®çš„æ—¶å€™ï¼Œå¯¹å…¶ä»–äººæ˜¯ä¸äº§ç”Ÿå½±å“çš„ï¼ˆå› ä¸ºå½“èº«é«˜ä¸€è‡´,iä¼šæ­£åºæ’åºï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] reconstructQueue(<span class="type">int</span>[][] people) &#123;</span><br><span class="line">        Arrays.sort(people,<span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;<span class="type">int</span>[]&gt;()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(<span class="type">int</span>[] o1, <span class="type">int</span> [] o2)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> o1[<span class="number">0</span>]==o2[<span class="number">0</span>]?o1[<span class="number">1</span>]-o2[<span class="number">1</span>]:o2[<span class="number">0</span>]-o1[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        List&lt;<span class="type">int</span>[]&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> [] peo:people)&#123;</span><br><span class="line">            res.add(peo[<span class="number">1</span>], peo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res.toArray(<span class="keyword">new</span> <span class="title class_">int</span> [res.size()][<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Q&quot;&gt;&lt;a href=&quot;#Q&quot; class=&quot;headerlink&quot; title=&quot;Q:&quot;&gt;&lt;/a&gt;Q:&lt;/h3&gt;&lt;p&gt;å‡è®¾æœ‰æ‰“ä¹±é¡ºåºçš„ä¸€ç¾¤äººç«™æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ•°ç»„ &lt;code&gt;people&lt;/code&gt; è¡¨ç¤ºé˜Ÿåˆ—ä¸­ä¸€äº›äººçš„å±æ€§ï¼ˆä¸ä¸€å®šæŒ‰é¡ºåºï¼‰ã€‚æ¯ä¸ª &lt;code&gt;people[i] = [hi, ki]&lt;/code&gt; è¡¨ç¤ºç¬¬ &lt;code&gt;i&lt;/code&gt; ä¸ªäººçš„èº«é«˜ä¸º &lt;code&gt;hi&lt;/code&gt; ï¼Œå‰é¢ &lt;strong&gt;æ­£å¥½&lt;/strong&gt; æœ‰ &lt;code&gt;ki&lt;/code&gt; ä¸ªèº«é«˜å¤§äºæˆ–ç­‰äº &lt;code&gt;hi&lt;/code&gt; çš„äººã€‚&lt;/p&gt;
&lt;p&gt;è¯·ä½ é‡æ–°æ„é€ å¹¶è¿”å›è¾“å…¥æ•°ç»„ &lt;code&gt;people&lt;/code&gt; æ‰€è¡¨ç¤ºçš„é˜Ÿåˆ—ã€‚è¿”å›çš„é˜Ÿåˆ—åº”è¯¥æ ¼å¼åŒ–ä¸ºæ•°ç»„ &lt;code&gt;queue&lt;/code&gt; ï¼Œå…¶ä¸­ &lt;code&gt;queue[j] = [hj, kj]&lt;/code&gt; æ˜¯é˜Ÿåˆ—ä¸­ç¬¬ &lt;code&gt;j&lt;/code&gt; ä¸ªäººçš„å±æ€§ï¼ˆ&lt;code&gt;queue[0]&lt;/code&gt; æ˜¯æ’åœ¨é˜Ÿåˆ—å‰é¢çš„äººï¼‰ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
  </entry>
  
  <entry>
    <title>KMP algorithm</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/algorithm/KMP-algorithm/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/algorithm/KMP-algorithm/</id>
    <published>2023-05-12T07:44:17.000Z</published>
    <updated>2023-05-12T08:09:07.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="KMPç®—æ³•"><a href="#KMPç®—æ³•" class="headerlink" title="KMPç®—æ³•:"></a>KMPç®—æ³•:</h3><p>â€‹    KMP (Knuth-Morris-Pratt) ç®—æ³•æ˜¯ä¸€ç§ç”¨äºå­—ç¬¦ä¸²æœç´¢çš„ç®—æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡æœ¬ä¸²Så†…æŸ¥æ‰¾ä¸€ä¸ªè¯Wçš„å‡ºç°ä½ç½®ã€‚</p><p>åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå½“å­ä¸²ä¸ç›®æ ‡å­—ç¬¦ä¸²ä¸åŒ¹é…æ—¶ï¼Œå…¶å·²çŸ¥è¶³å¤Ÿçš„ä¿¡æ¯èƒ½ç¡®å®šä¸‹ä¸€æ­¥çš„æœç´¢ä¸ä¼šå¯¼è‡´ç›®æ ‡å­—ç¬¦ä¸²çš„æ¼æ£€ã€‚è¿™æ ·ï¼Œç®—æ³•å°±ä¸ä¼šè¿›è¡Œæ— æ•ˆçš„æ£€æŸ¥ã€‚</p><p>ä¸‹é¢æ˜¯KMPç®—æ³•çš„æ­¥éª¤ï¼š</p><ol><li>æ„é€ ä¸€ä¸ªâ€éƒ¨åˆ†åŒ¹é…è¡¨â€ï¼ˆä¹Ÿç§°ä¸º â€œå¤±è´¥å‡½æ•°â€ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯¹äºç»™å®šçš„æŸ¥æ‰¾è¯ï¼Œè¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«äº†å½“åŒ¹é…å¤±è´¥æ—¶æŸ¥æ‰¾è¯åº”è¯¥è·³è½¬çš„ä½ç½®ã€‚</li><li>ä½¿ç”¨è¿™ä¸ªè¡¨æ¥è¿›è¡Œå­—ç¬¦ä¸²æœç´¢ã€‚å½“åœ¨æ–‡æœ¬ä¸²ä¸­å‘ç”ŸåŒ¹é…å¤±è´¥æ—¶ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡å‰é¢å·²çŸ¥ä¸ä¼šåŒ¹é…çš„éƒ¨åˆ†ã€‚</li></ol><span id="more"></span><h3 id="Why-KMP"><a href="#Why-KMP" class="headerlink" title="Why KMP"></a>Why KMP</h3><p>â€‹    ä¼ ç»Ÿçš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¦‚æœä»String[i]çš„æ¯”è¾ƒå¤±è´¥ï¼Œç®—æ³•ç›´æ¥å¼€å§‹å°è¯•ä»S[i+1]è¿›è¡Œæ¯”è¾ƒã€‚è¿™ç§è¡Œä¸ºæ˜¯å…¸å‹çš„ â€œä¸ä»ä»¥å‰çš„é”™è¯¯ä¸­å­¦ä¹ â€ã€‚æˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°ï¼Œä¸€ä¸ªå¤±è´¥çš„åŒ¹é…å°†ä¸ºæˆ‘ä»¬æä¾›æœ‰ä»·å€¼çš„ä¿¡æ¯â€“<strong>å¦‚æœString[i : i+len(P)]å’ŒPä¹‹é—´çš„åŒ¹é…åœ¨ç¬¬rä¸ªä½ç½®å¤±è´¥ï¼Œé‚£ä¹ˆä»S[i]ï¼šç¬¬ä¸€ä¸ªï¼ˆr-1ï¼‰è¿ç»­å­—ç¬¦å¿…é¡»ä¸Pçš„ç¬¬ä¸€ä¸ªï¼ˆr-1ï¼‰å­—ç¬¦å®Œå…¨ç›¸åŒ</strong>ã€‚</p><p><img src="/2023/05/12/algorithm/KMP-algorithm/1677815997905-1cc35396-f8b9-4cd8-9eeb-e583c804f942.jpeg" alt></p><p>â€‹    å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°½å¯èƒ½åœ°è·³è¿‡è¿™äº›ä¸å¯èƒ½çš„å­—ç¬¦ä¸²æ¥ä¼˜åŒ–æˆ‘ä»¬çš„æ–¹æ³•ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼š</p><p><img src="/2023/05/12/algorithm/KMP-algorithm/1677830257055-487dcd00-8b04-4467-a430-34fbb1285c8e.jpeg" alt></p><p>â€‹    é¦–å…ˆï¼ŒP[5]æœªèƒ½åŒ¹é…ï¼Œé‚£ä¹ˆè¿™æ„å‘³ç€S[0:5]ç­‰äºP[0:5]ï¼Œä¹Ÿå°±æ˜¯ â€œabcabâ€ã€‚<br>ç°åœ¨æˆ‘ä»¬è€ƒè™‘ï¼šä»S[1]ï¼ŒS[2]ï¼ŒS[3]æœ€åˆçš„åŒ¹é…å°è¯•æ˜¯å¦æœ‰æœºä¼šæˆåŠŸï¼Ÿ<br>å½“æˆ‘ä»¬ä»S[1]å¼€å§‹æ—¶ï¼Œå®ƒä¸ä¼šæˆåŠŸã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šP[1]ï¼=P[0]ï¼Œä½†P[1]=S[1]ï¼Œæ‰€ä»¥P[0]ï¼=S[1]ã€‚<br>åœ¨S[2]ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚<br>ä½†æ˜¯å½“æˆ‘ä»¬ä»S[3]å¼€å§‹æ—¶ï¼ˆè¿™å¾ˆé‡è¦ï¼‰ï¼š <strong>P[0] = P[3], S[3] = P[3], æ‰€ä»¥P[0] = S[3].</strong><br>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨S[3]ä¸­ï¼Œæœ‰å¯èƒ½åŒ¹é…æˆåŠŸã€‚è€Œä¸”æˆ‘ä»¬ä¼šå‘ç°ï¼Œå¦‚æœçŸ¥é“Så’ŒPåœ¨é•¿åº¦Lå†…æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªiæ˜¯å¦å¯ä»¥ä½œä¸ºåŒ¹é…çš„èµ·ç‚¹ï¼Œåªå–å†³äºP[0]=P[i]æ˜¯å¦ç›¸ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°KMPç®—æ³•çš„æ ¸å¿ƒä¸‹ä¸€ä¸ªæ•°ç»„</p><h3 id="NextArray"><a href="#NextArray" class="headerlink" title="NextArray"></a>NextArray</h3><p>â€‹    ä¸‹ä¸€ä¸ªæ•°ç»„æ˜¯ç”¨äºæ¨¡å¼å­—ç¬¦ä¸²ã€‚Pçš„ä¸‹ä¸€ä¸ªæ•°ç»„å®šä¹‰ä¸ºï¼šï¼š <strong>next[i]ä»£è¡¨P[0]~P[i]çš„ä¸€ä¸ªå­ä¸²ï¼Œå› æ­¤å‰kä¸ªå­—ç¬¦æ­£å¥½ç­‰äºåkä¸ªå­—ç¬¦çš„æœ€å¤§kã€‚ç‰¹åˆ«æ˜¯ï¼Œkä¸èƒ½æ˜¯i+1 </strong>(å› ä¸ºè¿™ä¸ªå­ä¸²æ€»å…±åªæœ‰i+1ä¸ªå­—ç¬¦ï¼Œå®ƒå¿…é¡»ç­‰äºå®ƒè‡ªå·±ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰æ„ä¹‰)ã€‚ <strong>äº‹å®ä¸Šï¼Œå®ƒæ˜¯ä¸ºäº†å¾—åˆ°ä¸åŒèµ·ç‚¹iæ—¶Pä¸²ä¸­æœ€é•¿çš„ç›¸åŒå‰ç¼€å’Œåç¼€çš„æœ€å¤§é•¿åº¦</strong>ã€‚</p><p><img src="/2023/05/12/algorithm/KMP-algorithm/1677816850922-c3abca12-6649-486d-b8aa-71139dcbc716.jpeg" alt></p><h3 id="åŒ¹é…"><a href="#åŒ¹é…" class="headerlink" title="åŒ¹é…"></a>åŒ¹é…</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">getNext(needle,next);</span><br><span class="line"><span class="keyword">while</span> (i &lt; length &amp;&amp; j &lt; length1)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (j == -<span class="number">1</span> || haystack.charAt(i) == needle.charAt(j))</span><br><span class="line">    &#123;</span><br><span class="line">        i++;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        j = next[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/12/algorithm/KMP-algorithm/1677827701314-03d97a1b-a666-4268-b392-cfa46e8bb70c.jpeg" alt></p><h4 id="é¦–å…ˆï¼šæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªç‚¹æ¥æ•æ‰å­—ç¬¦ä¸²ã€‚é—®é¢˜æ˜¯å¦‚ä½•æ”¹å˜è¿™ä¸ªç‚¹ï¼Ÿ"><a href="#é¦–å…ˆï¼šæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªç‚¹æ¥æ•æ‰å­—ç¬¦ä¸²ã€‚é—®é¢˜æ˜¯å¦‚ä½•æ”¹å˜è¿™ä¸ªç‚¹ï¼Ÿ" class="headerlink" title="é¦–å…ˆï¼šæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªç‚¹æ¥æ•æ‰å­—ç¬¦ä¸²ã€‚é—®é¢˜æ˜¯å¦‚ä½•æ”¹å˜è¿™ä¸ªç‚¹ï¼Ÿ"></a>é¦–å…ˆï¼šæˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªç‚¹æ¥æ•æ‰å­—ç¬¦ä¸²ã€‚é—®é¢˜æ˜¯å¦‚ä½•æ”¹å˜è¿™ä¸ªç‚¹ï¼Ÿ</h4><h4 id="ç¬¬äºŒï¼š"><a href="#ç¬¬äºŒï¼š" class="headerlink" title="ç¬¬äºŒï¼š"></a>ç¬¬äºŒï¼š</h4><pre><code>String[i] != P [j] ,ç°åœ¨æˆ‘ä»¬éœ€è¦æ”¹å˜jæ¥æ‰¾åˆ°ä¸€ä¸ªæ–°çš„å¼€å§‹ï¼Œå³Stringçš„å‰ç¼€ç­‰åŒäºPã€‚æ‰€ä»¥ï¼Œä¸‹ä¸€ä¸ªæ•°ç»„æ˜¯æœ‰ç”¨çš„ï¼š` j = next[j]`ã€‚</code></pre><h3 id="å¦‚ä½•è·å¾—ä¸‹ä¸€ä¸ªæ•°ç»„"><a href="#å¦‚ä½•è·å¾—ä¸‹ä¸€ä¸ªæ•°ç»„" class="headerlink" title="å¦‚ä½•è·å¾—ä¸‹ä¸€ä¸ªæ•°ç»„"></a>å¦‚ä½•è·å¾—ä¸‹ä¸€ä¸ªæ•°ç»„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">getNext</span><span class="params">(String p, <span class="type">int</span> [] next)</span></span><br><span class="line">    &#123;</span><br><span class="line">        next[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; (p.length()))&#123;</span><br><span class="line">            <span class="keyword">if</span> (j == -<span class="number">1</span> || p.charAt(i)==p.charAt(j)) &#123;</span><br><span class="line">                ++i;</span><br><span class="line">                ++j;</span><br><span class="line">                next[i] = j;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™æ®µä»£ç ä½¿ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼šä½¿next[0]=-1.ä½ å¯ä»¥è®°ä½å®ƒï¼Œè¿™å°†ä½¿ä»£ç æ›´åŠ å®¹æ˜“ï¼›</strong></p><h3 id="åŠ¨æ€è§„åˆ’ï¼š"><a href="#åŠ¨æ€è§„åˆ’ï¼š" class="headerlink" title="åŠ¨æ€è§„åˆ’ï¼š"></a>åŠ¨æ€è§„åˆ’ï¼š</h3><p>next[i]æ˜¯æŒ‡p[0,next[i]]=p[i-next[i],i]çš„æœ€å¤§å€¼(i)<br>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“next[0],next[1],â€¦next[i-1]ï¼Œå¦‚ä½•çŸ¥é“next[i]ï¼Ÿ<br>è®¾ç½®<code>next[i-1] = pre</code>ã€‚<br>å¦‚æœ<code>p[i]=p[pre+1]</code>ï¼Œè¿™æ„å‘³ç€<code>ä¸‹ä¸€ä¸ª[i]=pre+1</code>ã€‚<br>å¦åˆ™å¦‚æœ<code>p[i] != p[pre+1],</code>å°±æ„å‘³ç€<code>p[i-pre-1,i-1] = p[pre-1]</code>ã€‚<br>æˆ‘ä»¬åº”è¯¥å‡å°‘pre:<code>pre = next[pre]</code>ã€‚</p><p><img src="/2023/05/12/algorithm/KMP-algorithm/1677829808221-92178aa3-0c00-4c60-af02-dc14e6752b5b.jpeg" alt></p><h3 id="Code"><a href="#Code" class="headerlink" title="Code:"></a>Code:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * now we can use kmp algorithmï¼Œa prefix matching algorithm</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">strStr</span><span class="params">(String haystack, String needle)</span>&#123;</span><br><span class="line">        <span class="comment">//in first method,we can find that we need match all the substring if it&#x27;s not match.</span></span><br><span class="line">        <span class="comment">//some message have been lost: the prefix of the last string we have compared.</span></span><br><span class="line">        <span class="comment">//we can start with the same prefix string to match,so that the time can be saved</span></span><br><span class="line">        <span class="comment">// we can store the same prefix in a array or list, so we called kmp algorithm</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> haystack.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length1</span> <span class="operator">=</span> needle.length();</span><br><span class="line">        <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> [] next = <span class="keyword">new</span> <span class="title class_">int</span> [length1];</span><br><span class="line">        getNext(needle,next);</span><br><span class="line">        <span class="keyword">while</span> (i &lt; length &amp;&amp; j &lt; length1)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (j == -<span class="number">1</span> || haystack.charAt(i) == needle.charAt(j))</span><br><span class="line">            &#123;</span><br><span class="line">                i++;</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (j == length1)&#123;</span><br><span class="line">            <span class="keyword">return</span> i - j;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">getNext</span><span class="params">(String p, <span class="type">int</span> [] next)</span></span><br><span class="line">    &#123;</span><br><span class="line">        next[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i &lt; (p.length()))&#123;</span><br><span class="line">            <span class="keyword">if</span> (j == -<span class="number">1</span> || p.charAt(i)==p.charAt(j)) &#123;</span><br><span class="line">                ++i;</span><br><span class="line">                ++j;</span><br><span class="line">                next[i] = j;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                j = next[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;KMPç®—æ³•&quot;&gt;&lt;a href=&quot;#KMPç®—æ³•&quot; class=&quot;headerlink&quot; title=&quot;KMPç®—æ³•:&quot;&gt;&lt;/a&gt;KMPç®—æ³•:&lt;/h3&gt;&lt;p&gt;â€‹    KMP (Knuth-Morris-Pratt) ç®—æ³•æ˜¯ä¸€ç§ç”¨äºå­—ç¬¦ä¸²æœç´¢çš„ç®—æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–‡æœ¬ä¸²Så†…æŸ¥æ‰¾ä¸€ä¸ªè¯Wçš„å‡ºç°ä½ç½®ã€‚&lt;/p&gt;
&lt;p&gt;åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå½“å­ä¸²ä¸ç›®æ ‡å­—ç¬¦ä¸²ä¸åŒ¹é…æ—¶ï¼Œå…¶å·²çŸ¥è¶³å¤Ÿçš„ä¿¡æ¯èƒ½ç¡®å®šä¸‹ä¸€æ­¥çš„æœç´¢ä¸ä¼šå¯¼è‡´ç›®æ ‡å­—ç¬¦ä¸²çš„æ¼æ£€ã€‚è¿™æ ·ï¼Œç®—æ³•å°±ä¸ä¼šè¿›è¡Œæ— æ•ˆçš„æ£€æŸ¥ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æ˜¯KMPç®—æ³•çš„æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ„é€ ä¸€ä¸ªâ€éƒ¨åˆ†åŒ¹é…è¡¨â€ï¼ˆä¹Ÿç§°ä¸º â€œå¤±è´¥å‡½æ•°â€ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯¹äºç»™å®šçš„æŸ¥æ‰¾è¯ï¼Œè¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«äº†å½“åŒ¹é…å¤±è´¥æ—¶æŸ¥æ‰¾è¯åº”è¯¥è·³è½¬çš„ä½ç½®ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨è¿™ä¸ªè¡¨æ¥è¿›è¡Œå­—ç¬¦ä¸²æœç´¢ã€‚å½“åœ¨æ–‡æœ¬ä¸²ä¸­å‘ç”ŸåŒ¹é…å¤±è´¥æ—¶ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡å‰é¢å·²çŸ¥ä¸ä¼šåŒ¹é…çš„éƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="ç®—æ³•" scheme="http://pjpjsocute.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>chatGPT with confluence</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/algorithm/chatGPT-with-confluence/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/algorithm/chatGPT-with-confluence/</id>
    <published>2023-05-12T07:44:05.000Z</published>
    <updated>2023-05-12T07:57:11.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Target"><a href="#Target" class="headerlink" title="Target:"></a>Target:</h3><p>ç”±äºå·¥ä½œæ—¶Confluenceä¸­çš„æ–‡ä»¶å¤ªå¤šï¼Œä¹Ÿæ¯”è¾ƒæ‚ä¹±ï¼Œéš¾ä»¥é˜…è¯»ï¼Œæ‰€ä»¥å¸Œæœ›åŸºäºchatGPTèƒ½å¤Ÿå¸®åŠ©æˆ‘å¿«é€Ÿä»æ–‡ä»¶ä¸­è·å–æˆ‘æƒ³è¦çš„çŸ¥è¯†</p><span id="more"></span><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªdemoçš„ä»£ç ï¼Œå‚è€ƒäº†GPTå®˜ç½‘çš„åšæ³•</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##çˆ¬è™«</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> html2text</span><br><span class="line"><span class="keyword">from</span> atlassian <span class="keyword">import</span> Confluence</span><br><span class="line"><span class="keyword">import</span> tiktoken</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">from</span> openai.embeddings_utils <span class="keyword">import</span> distances_from_embeddings</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> openai.embeddings_utils <span class="keyword">import</span> distances_from_embeddings, cosine_similarity</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># public çš„è´¦å· å’Œconfluenceç©ºé—´é…ç½®</span></span><br><span class="line">domain = <span class="string">&quot;confluence.xxxxx.com&quot;</span></span><br><span class="line">full_url = <span class="string">&quot;https://confluence.xxxxx.com/&quot;</span></span><br><span class="line">login_url = <span class="string">&quot;https://confluence.xxxxx.com/login.action?os_destination=%2Fdologin.action&quot;</span></span><br><span class="line">page_url = <span class="string">&quot;https://confluence.xxxxx.com/display/41JTSP/&quot;</span></span><br><span class="line">user_name = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line">password = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="comment"># å®šä¹‰è¦çˆ¬å–çš„ç©ºé—´keyï¼Œè¿™æ˜¯ç›®å‰æˆ‘ä»¬çš„ç©ºé—´</span></span><br><span class="line">space_key = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="comment">##æ•°æ®ä¿å­˜åœ°å€ï¼Œè¯·è‡ªå®šä¹‰</span></span><br><span class="line">filePath = <span class="string">&quot;&quot;</span></span><br><span class="line">processPath = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##åˆ†éš”ç¬¦å’Œæ›¿æ¢ç¬¦ï¼Œä¸»è¦ç”¨äºæ–‡ä»¶åç”Ÿæˆå’Œæ ‡é¢˜è¿˜åŸ</span></span><br><span class="line">splitFlag = <span class="string">&quot;$&quot;</span></span><br><span class="line">replaceFlag = <span class="string">&quot;_&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##è®¾ç½®openaiç¯å¢ƒ</span></span><br><span class="line">openai.organization = <span class="string">&quot;&quot;</span></span><br><span class="line">openai.api_key = <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">crawler</span>(<span class="params">base_url,username,password,space_key,totalSpace = <span class="literal">False</span></span>):</span><br><span class="line">    confluence = Confluence(url=base_url, username=username, password=password)</span><br><span class="line">    <span class="comment">##å¾…å®ç°ï¼Œçˆ¬å–æ‰€æœ‰çš„space</span></span><br><span class="line">    <span class="comment">##è·å–å¯¹åº”ç©ºé—´</span></span><br><span class="line">    space = confluence.get_space(space_key, expand=<span class="string">&#x27;description.plain,homepage&#x27;</span>)</span><br><span class="line">    <span class="comment">##è·å–spaceé¡µé¢id</span></span><br><span class="line">    page_id = space[<span class="string">&quot;homepage&quot;</span>][<span class="string">&quot;id&quot;</span>]</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># Create a directory to store the text files</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(filePath):</span><br><span class="line">            os.mkdir(filePath)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create a directory to store the csv files</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(processPath):</span><br><span class="line">            os.mkdir(processPath)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">##å­é¡µé¢</span></span><br><span class="line">    child = confluence.get_page_child_by_type(page_id, <span class="built_in">type</span>=<span class="string">&#x27;page&#x27;</span>, start=<span class="literal">None</span>, limit=<span class="literal">None</span>, expand=<span class="literal">None</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">##åˆå§‹åŒ–é˜Ÿåˆ—</span></span><br><span class="line">    queue = deque()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> child:</span><br><span class="line">        queue.append(i)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> queue:</span><br><span class="line">        <span class="comment"># Get the next URL from the queue</span></span><br><span class="line">        childPage = queue.pop()</span><br><span class="line">        <span class="comment">##æ‹¿åˆ°é¡µé¢id</span></span><br><span class="line">        html = confluence.get_page_by_id(childPage[<span class="string">&quot;id&quot;</span>], expand=<span class="string">&quot;body.storage&quot;</span>)</span><br><span class="line">        <span class="comment"># è°ƒç”¨æ–¹æ³•ï¼Œå°†htmlè½¬ä¸ºçº¯æ–‡æœ¬</span></span><br><span class="line">        content = html[<span class="string">&quot;body&quot;</span>][<span class="string">&quot;storage&quot;</span>][<span class="string">&quot;value&quot;</span>]</span><br><span class="line">        content_text = html2text.html2text(content)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">##æ–‡æœ¬ä¸ä¸ºç©ºå†™å…¥</span></span><br><span class="line">        <span class="keyword">if</span> content_text.lstrip() != <span class="string">&quot;&quot;</span>:</span><br><span class="line">            title = <span class="built_in">str</span>(html[<span class="string">&quot;title&quot;</span>]).replace(<span class="string">&quot;/&quot;</span>,replaceFlag)</span><br><span class="line">    <span class="comment">#         if not os.path.exists(&quot;/Users/lei.zhou/text/&quot;+html[&quot;title&quot;]):</span></span><br><span class="line">    <span class="comment">#             os.mkdir(&quot;/Users/lei.zhou/text/&quot;)</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filePath+ childPage[<span class="string">&quot;id&quot;</span>]+splitFlag+title+ <span class="string">&quot;.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(content_text)</span><br><span class="line"></span><br><span class="line">        <span class="comment">##åŠ å…¥å­èŠ‚ç‚¹â€˜</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> confluence.get_page_child_by_type(childPage[<span class="string">&quot;id&quot;</span>], <span class="built_in">type</span>=<span class="string">&#x27;page&#x27;</span>, start=<span class="literal">None</span>, limit=<span class="literal">None</span>, expand=<span class="literal">None</span>):</span><br><span class="line">            queue.append(i)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">max_tokens = <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_newlines</span>(<span class="params">serie</span>):</span><br><span class="line">    serie = serie.<span class="built_in">str</span>.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    serie = serie.<span class="built_in">str</span>.replace(<span class="string">&#x27;\\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    serie = serie.<span class="built_in">str</span>.replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    serie = serie.<span class="built_in">str</span>.replace(<span class="string">&#x27;  &#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> serie</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_context</span>(<span class="params"></span></span><br><span class="line"><span class="params">    question, df, max_len=<span class="number">1800</span>, size=<span class="string">&quot;ada&quot;</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¯»æ‰¾æœ€ç›¸ä¼¼çš„æ–‡æœ¬æ®µ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Get the embeddings for the question</span></span><br><span class="line">    q_embeddings = openai.Embedding.create(<span class="built_in">input</span>=question, engine=<span class="string">&#x27;text-embedding-ada-002&#x27;</span>)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ä½™å¼¦ç®—æ³•è®¡ç®—æœ€ç›¸ä¼¼çš„æ–‡æœ¬</span></span><br><span class="line">    df[<span class="string">&#x27;distances&#x27;</span>] = distances_from_embeddings(q_embeddings, df[<span class="string">&#x27;embeddings&#x27;</span>].values, distance_metric=<span class="string">&#x27;cosine&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    returns = []</span><br><span class="line">    cur_len = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸æ–­æ·»åŠ æ–‡æœ¬åˆ°ä¸Šé™</span></span><br><span class="line">    <span class="keyword">for</span> i, row <span class="keyword">in</span> df.sort_values(<span class="string">&#x27;distances&#x27;</span>, ascending=<span class="literal">True</span>).iterrows():</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ–‡æœ¬åˆ›å»º</span></span><br><span class="line">        cur_len += row[<span class="string">&#x27;n_tokens&#x27;</span>] + <span class="number">4</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è¶…å‡ºä¸Šé™é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> cur_len &gt; max_len:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¢åŠ æ–‡æœ¬</span></span><br><span class="line">        returns.append(row[<span class="string">&quot;text&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n###\n\n&quot;</span>.join(returns)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># tokenåˆ†å‰²</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_into_many</span>(<span class="params">text, max_tokens = max_tokens</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰åˆ†å‰²ç¬¦å·ï¼Œå¯ä»¥å…è®¸è‡ªå®šä¹‰</span></span><br><span class="line">    sentences = re.split(<span class="string">&#x27;[.ã€‚ï¼ï¼Ÿ!?]&#x27;</span>,text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–æ¯æ®µçš„token</span></span><br><span class="line">    n_tokens = [<span class="built_in">len</span>(tokenizer.encode(<span class="string">&quot; &quot;</span> + sentence)) <span class="keyword">for</span> sentence <span class="keyword">in</span> sentences]</span><br><span class="line">    </span><br><span class="line">    chunks = []</span><br><span class="line">    tokens_so_far = <span class="number">0</span></span><br><span class="line">    chunk = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éå†</span></span><br><span class="line">    <span class="keyword">for</span> sentence, token <span class="keyword">in</span> <span class="built_in">zip</span>(sentences, n_tokens):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœåˆ°ç›®å‰ä¸ºæ­¢çš„æ ‡è®°æ•°é‡åŠ ä¸Šå½“å‰å¥å­ä¸­çš„æ ‡è®°æ•°é‡å¤§äº,å¤§äºæœ€å¤§æ ‡è®°æ•°ï¼Œåˆ™å°†è¯¥å—æ·»åŠ åˆ°å—çš„åˆ—è¡¨ä¸­ï¼Œå¹¶é‡ç½®åˆ°ç›®å‰ä¸ºæ­¢çš„å—å’Œæ ‡è®°æ•°</span></span><br><span class="line">        <span class="keyword">if</span> tokens_so_far + token &gt; max_tokens:</span><br><span class="line">            chunks.append(<span class="string">&quot;. &quot;</span>.join(chunk) + <span class="string">&quot;.&quot;</span>)</span><br><span class="line">            chunk = []</span><br><span class="line">            tokens_so_far = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> token &gt; max_tokens:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ </span></span><br><span class="line">        chunk.append(sentence)</span><br><span class="line">        tokens_so_far += token + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chunks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##æ•°æ®ï¼Œæ¨¡å‹ï¼Œé—®é¢˜ï¼Œé•¿åº¦ï¼Œ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">answer_question</span>(<span class="params"></span></span><br><span class="line"><span class="params">    df,</span></span><br><span class="line"><span class="params">    model=<span class="string">&quot;text-davinci-003&quot;</span>,</span></span><br><span class="line"><span class="params">    question=<span class="string">&quot;ä½ æœ‰ä»€ä¹ˆé—®é¢˜&quot;</span>,</span></span><br><span class="line"><span class="params">    max_len=<span class="number">1800</span>,</span></span><br><span class="line"><span class="params">    size=<span class="string">&quot;ada&quot;</span>,</span></span><br><span class="line"><span class="params">    debug=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    max_tokens=<span class="number">1800</span>,</span></span><br><span class="line"><span class="params">    stop_sequence=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    use_GPT=<span class="literal">False</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å›ç­”é—®é¢˜</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    context = create_context(</span><br><span class="line">        question,</span><br><span class="line">        df,</span><br><span class="line">        max_len=max_len,</span><br><span class="line">        size=size,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># If debug, print the raw model response</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Context:\n&quot;</span> + context)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Answer the question based on the context below, and if the question can&#x27;t be answered based on the context, say \&quot;I don&#x27;t know\&quot;\n\nContext: <span class="subst">&#123;context&#125;</span>\n\n---\n\nQuestion: <span class="subst">&#123;question&#125;</span>\nAnswer:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> use_GPT:</span><br><span class="line">        completion = openai.ChatCompletion.create(model=<span class="string">&quot;gpt-3.5-turbo&quot;</span>,messages=[</span><br><span class="line">    &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">f&quot;Answer the question based on the context below, and if the question can&#x27;t be answered based on the context, say \&quot;I don&#x27;t know\&quot;\n\nContext: <span class="subst">&#123;context&#125;</span>\n\n---\n\nQuestion: <span class="subst">&#123;question&#125;</span>\nAnswer:&quot;</span>&#125;])</span><br><span class="line">        <span class="keyword">return</span> completion.to_dict()[<span class="string">&quot;choices&quot;</span>][<span class="number">0</span>][<span class="string">&quot;message&quot;</span>][<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Create a completions using the question and context</span></span><br><span class="line">        response = openai.Completion.create(</span><br><span class="line">            prompt=<span class="string">f&quot;Answer the question based on the context below, and if the question can&#x27;t be answered based on the context, say \&quot;I don&#x27;t know\&quot;\n\nContext: <span class="subst">&#123;context&#125;</span>\n\n---\n\nQuestion: <span class="subst">&#123;question&#125;</span>\nAnswer:&quot;</span>,</span><br><span class="line">            temperature=<span class="number">0</span>,</span><br><span class="line">            max_tokens=max_tokens,</span><br><span class="line">            top_p=<span class="number">1</span>,</span><br><span class="line">            frequency_penalty=<span class="number">0</span>,</span><br><span class="line">            presence_penalty=<span class="number">0</span>,</span><br><span class="line">            stop=stop_sequence,</span><br><span class="line">            model=model,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> response[<span class="string">&quot;choices&quot;</span>][<span class="number">0</span>][<span class="string">&quot;text&quot;</span>].strip()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crawler(base_url,username,password,space_key)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åŸå§‹æ–‡æœ¬</span></span><br><span class="line">texts=[]</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(filePath):</span><br><span class="line">    <span class="comment"># æ–‡ä»¶è¯»å–</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filePath+file, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        titles = file.split(splitFlag)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(titles) &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        title = titles[<span class="number">1</span>]</span><br><span class="line">        text = f.read()</span><br><span class="line">        <span class="comment"># æ ‡é¢˜è¿˜åŸï¼ŒæŠŠ_æ›¿æ¢ä¸ºç©ºæ ¼æ’å…¥</span></span><br><span class="line">        texts.append((title.replace(replaceFlag,<span class="string">&quot; &quot;</span>), text))</span><br><span class="line">        </span><br><span class="line"><span class="comment"># pdåˆ›å»º</span></span><br><span class="line">df = pd.DataFrame(texts, columns = [<span class="string">&#x27;fname&#x27;</span>, <span class="string">&#x27;text&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰è¡Œåˆ†æ®µ</span></span><br><span class="line">df[<span class="string">&#x27;text&#x27;</span>] = df.fname + <span class="string">&quot;. &quot;</span> + remove_newlines(df.text)</span><br><span class="line">df.to_csv(<span class="string">&#x27;processed/scraped.csv&#x27;</span>)</span><br><span class="line">df.head()</span><br></pre></td></tr></table></figure><p></p><table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>fname</th><br>      <th>text</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>bak.B1.1 Payment Center Integration Test Reporâ€¦</td><br>      <td>bak.B1.1 Payment Center Integration Test Reporâ€¦</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>2022-03-15  [VWASP] ã€ULHã€‘DP token exchange witâ€¦</td><br>      <td>2022-03-15  [VWASP] ã€ULHã€‘DP token exchange witâ€¦</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>OnlineRadio and OlineMusic B0.2 testcase revieâ€¦</td><br>      <td>OnlineRadio and OlineMusic B0.2 testcase revieâ€¦</td><br>    </tr><br>  </tbody><br></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tokenizer = tiktoken.get_encoding(<span class="string">&quot;cl100k_base&quot;</span>)</span><br><span class="line"></span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;processed/scraped.csv&#x27;</span>, index_col=<span class="number">0</span>)</span><br><span class="line">df.columns = [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"></span><br><span class="line">df[<span class="string">&#x27;n_tokens&#x27;</span>] = df.text.apply(<span class="keyword">lambda</span> x: <span class="built_in">len</span>(tokenizer.encode(x)))</span><br><span class="line"></span><br><span class="line">df</span><br></pre></td></tr></table></figure><p></p><table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>title</th><br>      <th>text</th><br>      <th>n_tokens</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>      <td>1423</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>      <td>1355</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>bak.B1.1 Payment Center Integration Test Reporâ€¦</td><br>      <td>bak.B1.1 Payment Center Integration Test Reporâ€¦</td><br>      <td>1106</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>2022-03-15  [VWASP] ã€ULHã€‘DP token exchange witâ€¦</td><br>      <td>2022-03-15  [VWASP] ã€ULHã€‘DP token exchange witâ€¦</td><br>      <td>1429</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>OnlineRadio and OlineMusic B0.2 testcase revieâ€¦</td><br>      <td>OnlineRadio and OlineMusic B0.2 testcase revieâ€¦</td><br>      <td>2736</td><br>    </tr><br>    <tr><br>      <th>â€¦</th><br>      <td>â€¦</td><br>      <td>â€¦</td><br>      <td>â€¦</td><br>    </tr><br>    <tr><br>      <th>412</th><br>      <td>B1 OnePortal Qulification Test Report.txt</td><br>      <td>B1 OnePortal Qulification Test Report.txt.   #â€¦</td><br>      <td>966</td><br>    </tr><br>    <tr><br>      <th>413</th><br>      <td>Detailed Solution Architecture.txt</td><br>      <td>Detailed Solution Architecture.txt. 250</td><br>      <td>8</td><br>    </tr><br>    <tr><br>      <th>414</th><br>      <td>B1.3 Release.txt</td><br>      <td>B1.3 Release.txt. true</td><br>      <td>9</td><br>    </tr><br>    <tr><br>      <th>415</th><br>      <td>04  B1éªŒæ”¶Charging&amp;RBC.txt</td><br>      <td>04  B1éªŒæ”¶Charging&amp;RBC.txt.  L1| L2| L3| | | L4|â€¦</td><br>      <td>1492</td><br>    </tr><br>    <tr><br>      <th>416</th><br>      <td>ULH - Integration Outline and API-Specificatioâ€¦</td><br>      <td>ULH - Integration Outline and API-Specificatioâ€¦</td><br>      <td>38</td><br>    </tr><br>  </tbody><br></table><br><p>417 rows Ã— 3 columns</p><br><br><br><br><br><br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Tokenize the text and save the number of tokens to a new column</span></span><br><span class="line">df[<span class="string">&#x27;n_tokens&#x27;</span>] = df.text.apply(<span class="keyword">lambda</span> x: <span class="built_in">len</span>(tokenizer.encode(x)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Visualize the distribution of the number of tokens per row using a histogram</span></span><br><span class="line">df.n_tokens.hist()</span><br></pre></td></tr></table></figure><br><br><br><br><br>    <a href="AxesSubplot:">AxesSubplot:</a><br><br><br><br><br><img src="/2023/05/12/algorithm/chatGPT-with-confluence/output_7_1-3877587.png" alt="png"><br>â€‹<br><br><br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">shortened = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¾ªç¯å‡å°‘æ–‡æœ¬</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> df.iterrows():</span><br><span class="line">    <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> row[<span class="number">1</span>][<span class="string">&#x27;text&#x27;</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> row[<span class="number">1</span>][<span class="string">&#x27;n_tokens&#x27;</span>] &gt; max_tokens:</span><br><span class="line">        shortened += split_into_many(row[<span class="number">1</span>][<span class="string">&#x27;text&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        shortened.append( row[<span class="number">1</span>][<span class="string">&#x27;text&#x27;</span>] )</span><br><span class="line">df = pd.DataFrame(shortened, columns = [<span class="string">&#x27;text&#x27;</span>])</span><br><span class="line">df[<span class="string">&#x27;n_tokens&#x27;</span>] = df.text.apply(<span class="keyword">lambda</span> x: <span class="built_in">len</span>(tokenizer.encode(x)))</span><br><span class="line">df.n_tokens.hist()</span><br></pre></td></tr></table></figure><br><br><br><br><br><br><img src="/2023/05/12/algorithm/chatGPT-with-confluence/output_8_1-3877587.png" alt="png"><br>â€‹<br><br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##ç”±äºå®˜æ–¹çš„é™åˆ¶ï¼Œ1åˆ†é’Ÿæœ€å¤šå‘èµ·60ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢æŠ¥é”™æ­¤å¤„ä¸»åŠ¨ä¼‘çœ </span></span><br><span class="line"><span class="comment">##ç”±äºæ•°æ®é‡è¿‡å¤§ï¼Œå¦‚æœæ— æ³•è¿è¡Œï¼Œå¯ä»¥åœ¨ä¸Šé¢ä¸€æ     æˆªå–éƒ¨åˆ†æ•°æ®df = df[0:x]  xä¸ºæˆªå–é•¿åº¦</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cal</span>(<span class="params">x,waittime = <span class="number">0.6</span></span>):</span><br><span class="line">    res = openai.Embedding.create(<span class="built_in">input</span>=x, engine=<span class="string">&#x27;text-embedding-ada-002&#x27;</span>)[<span class="string">&#x27;data&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;embedding&#x27;</span>]</span><br><span class="line">    time.sleep(waittime)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">df[<span class="string">&#x27;embeddings&#x27;</span>] = df.text.apply(<span class="keyword">lambda</span> x: cal(x))</span><br><span class="line"></span><br><span class="line">df.to_csv(<span class="string">&#x27;processed/embeddings.csv&#x27;</span>)</span><br><span class="line">df.head()</span><br></pre></td></tr></table></figure><br><br><br><br><br><br><table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>text</th><br>      <th>n_tokens</th><br>      <th>embeddings</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>      <td>472</td><br>      <td>[-0.0035752991680055857, 0.015155627392232418,â€¦</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>| 11 incomplete | /  6 | ç”¨ä¾‹è®¾è®¡æ˜¯å¦åŒ…å«å……åˆ†çš„æ­£é¢ã€è´Ÿé¢å¼‚å¸¸æµ‹è¯•â€¦</td><br>      <td>343</td><br>      <td>[0.012331507168710232, 0.002946529071778059, -â€¦</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>      <td>454</td><br>      <td>[0.004054947756230831, -0.0028905682265758514,â€¦</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>| 203 complete OK |  |   <strong>ä¸“å±éƒ¨åˆ†</strong> |  | æ£€æŸ¥äººï¼šZhâ€¦</td><br>      <td>492</td><br>      <td>[0.019448528066277504, 0.00747803645208478, 0â€¦.</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>bak. B1. 1 Payment Center Integration Test Repâ€¦</td><br>      <td>481</td><br>      <td>[0.0010055731981992722, -0.013514618389308453,â€¦</td><br>    </tr><br>  </tbody><br></table><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##è¯»å–tokenæ•°æ®</span></span><br><span class="line">df=pd.read_csv(<span class="string">&#x27;processed/embeddings.csv&#x27;</span>, index_col=<span class="number">0</span>)</span><br><span class="line">df[<span class="string">&#x27;embeddings&#x27;</span>] = df[<span class="string">&#x27;embeddings&#x27;</span>].apply(<span class="built_in">eval</span>).apply(np.array)</span><br><span class="line">df.head()</span><br></pre></td></tr></table></figure><p></p><p><table border="1" class="dataframe"><br>  <thead><br>    <tr style="text-align: right;"><br>      <th></th><br>      <th>text</th><br>      <th>n_tokens</th><br>      <th>embeddings</th><br>    </tr><br>  </thead><br>  <tbody><br>    <tr><br>      <th>0</th><br>      <td>2022-12-15ã€VWASPã€‘ã€IDPã€‘Scan qrcode login HU to â€¦</td><br>      <td>472</td><br>      <td>[-0.0035752991680055857, 0.015155627392232418,â€¦</td><br>    </tr><br>    <tr><br>      <th>1</th><br>      <td>| 11 incomplete | /  6 | ç”¨ä¾‹è®¾è®¡æ˜¯å¦åŒ…å«å……åˆ†çš„æ­£é¢ã€è´Ÿé¢å¼‚å¸¸æµ‹è¯•â€¦</td><br>      <td>343</td><br>      <td>[0.012331507168710232, 0.002946529071778059, -â€¦</td><br>    </tr><br>    <tr><br>      <th>2</th><br>      <td>2022-12-19   ã€VWASPã€‘ã€StartupBroadcastingã€‘Conteâ€¦</td><br>      <td>454</td><br>      <td>[0.004054947756230831, -0.0028905682265758514,â€¦</td><br>    </tr><br>    <tr><br>      <th>3</th><br>      <td>| 203 complete OK |  |   <strong>ä¸“å±éƒ¨åˆ†</strong> |  | æ£€æŸ¥äººï¼šZhâ€¦</td><br>      <td>492</td><br>      <td>[0.019448528066277504, 0.00747803645208478, 0â€¦.</td><br>    </tr><br>    <tr><br>      <th>4</th><br>      <td>bak. B1. 1 Payment Center Integration Test Repâ€¦</td><br>      <td>481</td><br>      <td>[0.0010055731981992722, -0.013514618389308453,â€¦</td><br>    </tr><br>  </tbody><br></table><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##è¾“å…¥æœ€å¤§tokenï¼Œè¿”å›é•¿åº¦è¿›è¡Œæé—®</span></span><br><span class="line">answer_question(df, question=<span class="string">&quot;æµ‹è¯•ç”¨ä¾‹éœ€è¦æ»¡è¶³é‚£äº›è¦æ±‚?&quot;</span>, debug=<span class="literal">False</span>,use_GPT=<span class="literal">True</span>,max_len=<span class="number">1800</span>,max_tokens = <span class="number">1800</span>)</span><br></pre></td></tr></table></figure><pre><code>&apos;æµ‹è¯•ç”¨ä¾‹éœ€è¦æ»¡è¶³è®¸å¤šè¦æ±‚ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šå‰ææ¡ä»¶ã€è¾“å…¥æ•°æ®å’ŒæœŸå¾…ç»“æœæ¸…æ™°ã€æ˜ç¡®ï¼›åŒ…å«å……åˆ†çš„æ­£é¢ã€è´Ÿé¢å¼‚å¸¸æµ‹è¯•ç”¨ä¾‹ï¼›æ˜¯å¦ä»ç”¨æˆ·å±‚é¢æ¥è®¾è®¡ç”¨æˆ·ä½¿ç”¨åœºæ™¯å’Œä½¿ç”¨æµç¨‹çš„æµ‹è¯•ç”¨ä¾‹ï¼›æ˜¯å¦ç®€æ´ï¼Œå¤ç”¨æ€§å¼ºç­‰ã€‚å…·ä½“è¦æ±‚è§ä¸Šæ–‡ä¸­çš„å„é¡¹æ£€æŸ¥é¡¹ã€‚&apos;</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">answer_question(df, question=<span class="string">&quot;ä¸€ä»½DDæ–‡æ¡£æˆ–æ˜¯ADæ–‡æ¡£éœ€è¦æ»¡è¶³é‚£äº›è¦æ±‚?,è¯·ç”¨ä¸­æ–‡å›ç­”&quot;</span>, debug=<span class="literal">False</span>,use_GPT=<span class="literal">True</span>,max_len=<span class="number">1800</span>,max_tokens = <span class="number">1800</span>)</span><br></pre></td></tr></table></figure><pre><code>&apos;DDæ–‡æ¡£æˆ–ADæ–‡æ¡£éœ€è¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\n1. å®ƒåº”è¯¥æ¸…æ™°æ˜äº†ï¼ŒåŒ…æ‹¬åº”ç”¨çš„åŠŸèƒ½ã€æ€§èƒ½ã€ç•Œé¢ã€å®‰å…¨ç­‰æ–¹é¢ã€‚\n2. å®ƒåº”è¯¥æ˜“äºç†è§£ï¼ŒåŒ…æ‹¬é€‚å½“çš„è¯´æ˜ã€æµç¨‹å›¾ã€çŠ¶æ€å›¾ç­‰ã€‚\n3. å®ƒåº”è¯¥æ»¡è¶³å¯å¤ç”¨æ€§ã€æ˜“ç»´æŠ¤æ€§ç­‰è½¯ä»¶å·¥ç¨‹çš„åŸºæœ¬åŸåˆ™ã€‚\n4. å®ƒåº”è¯¥åŒ…æ‹¬å¯é æ€§éœ€æ±‚ï¼Œæè¿°ç³»ç»Ÿçš„å¯ç”¨æ€§ã€å¥å£®æ€§ç­‰éœ€æ±‚ã€‚\n5. å®ƒåº”è¯¥è€ƒè™‘çº¦æŸå’Œå‡è®¾ï¼ŒåŒ…æ‹¬å®¢æˆ·å’ŒMAçš„çº¦æŸå’Œå‡è®¾ã€‚\n6. å®ƒåº”è¯¥åŒ…æ‹¬è¯¦ç»†è®¾è®¡ï¼Œä»¥é˜æ˜æ›´æ”¹çš„åŸå› å’Œè¿‡ç¨‹ï¼Œå¹¶è¿›è¡Œä¸€è‡´æ€§è¯„ä¼°ã€‚\n7. å®ƒåº”è¯¥è€ƒè™‘è½¯ä»¶å•å…ƒçš„äº’æ“ä½œæ€§ã€äº¤äº’ã€å…³é”®æ€§ã€æŠ€æœ¯å¤æ‚æ€§ã€é£é™©å’Œå¯æµ‹è¯•æ€§ç­‰æ–¹é¢ã€‚ \n8. å®ƒåº”è¯¥åŒ…æ‹¬æ¥å£å®šä¹‰ï¼Œä»¥ä½¿æ¥å£æ¸…æ¥šæ˜äº†ã€‚\n9. å†å²è®°å½•åº”è¯¥å¾—åˆ°æ­£ç¡®ç»´æŠ¤ã€‚&apos;</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Target&quot;&gt;&lt;a href=&quot;#Target&quot; class=&quot;headerlink&quot; title=&quot;Target:&quot;&gt;&lt;/a&gt;Target:&lt;/h3&gt;&lt;p&gt;ç”±äºå·¥ä½œæ—¶Confluenceä¸­çš„æ–‡ä»¶å¤ªå¤šï¼Œä¹Ÿæ¯”è¾ƒæ‚ä¹±ï¼Œéš¾ä»¥é˜…è¯»ï¼Œæ‰€ä»¥å¸Œæœ›åŸºäºchatGPTèƒ½å¤Ÿå¸®åŠ©æˆ‘å¿«é€Ÿä»æ–‡ä»¶ä¸­è·å–æˆ‘æƒ³è¦çš„çŸ¥è¯†&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ç®—æ³•" scheme="http://pjpjsocute.github.io/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="python" scheme="http://pjpjsocute.github.io/tags/python/"/>
    
      <category term="chatGpt" scheme="http://pjpjsocute.github.io/tags/chatGpt/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-386</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-386/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-386/</id>
    <published>2023-05-12T07:31:09.000Z</published>
    <updated>2023-05-12T14:36:08.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Qï¼š"><a href="#Qï¼š" class="headerlink" title="Qï¼š"></a>Qï¼š</h3><p>ç»™ä½ ä¸€ä¸ªæ•´æ•° <code>n</code> ï¼ŒæŒ‰å­—å…¸åºè¿”å›èŒƒå›´ <code>[1, n]</code> å†…æ‰€æœ‰æ•´æ•°ã€‚</p><p>ä½ å¿…é¡»è®¾è®¡ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º <code>O(n)</code> ä¸”ä½¿ç”¨ <code>O(1)</code> é¢å¤–ç©ºé—´çš„ç®—æ³•ã€‚</p><span id="more"></span><h3 id="Sï¼š"><a href="#Sï¼š" class="headerlink" title="Sï¼š"></a>Sï¼š</h3><p>é¦–å…ˆï¼šå­—å…¸åºå¯ä»¥æŠ½è±¡ä¸ºä¸€æ£µæ ‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2023/05/12/LeetCode/LeetCode-386/1603875858-aRThUF-QQ20201028-170405@2x.png" alt="1603875858-aRThUF-QQ20201028-170405@2x"></p><p>æ‰€ä»¥ï¼Œæœ‰å°åˆ°å¤§è¾“å‡ºå…¶å®å°±æ˜¯è¾“å‡ºä»–çš„å…ˆåºéå†</p><p><strong>å‚è€ƒäºŒå‰æœç´¢æ ‘çš„å…ˆåºéå†å†™æ³•</strong></p><p>â€‹    1.é€’å½’ï¼š</p><p>â€‹        æ­¤å¤„ä¸ä¸€æ ·çš„æ˜¯éœ€è¦èˆå»å¤´ç»“ç‚¹0ï¼Œä»¥1-9åˆ†åˆ«ä¸ºæ ¹èŠ‚ç‚¹è¿›è¡Œéå†è¾“å‡ºï¼š</p><p>â€‹            1.é€’å½’ç»“æŸæ¡ä»¶ï¼Œå½“å‰ç»“ç‚¹ï¼nï¼Œåˆ™é€’å½’ç»“æŸ</p><p>â€‹            2.å°†å…ƒç´ å€¼æ·»åŠ è¿›å…¥res,éå†å…¶10ä¸ªå…„å¼Ÿç»“ç‚¹ï¼Œè¿›å…¥é€’å½’å…¶å­èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">lexicalOrder</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">             dfs(n, i, list);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> n,<span class="type">int</span> i,List&lt;Integer&gt;list)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&gt;n)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(i);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=<span class="number">9</span>;j++)&#123;</span><br><span class="line">            dfs(n,i*<span class="number">10</span>+j,list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure><p>â€‹    2.è¿­ä»£:</p><p>â€‹    <strong>tipp </strong>ï¼š<code>while(curr%10==0) curr/=10;</code> è¿™è¡Œä»£ç çš„ç›®çš„æ˜¯å¤„ç†é‚£äº›åœ¨å­—å…¸åºä¸­åº”è¯¥æå‰ç»“æŸçš„æ•°å­—ã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾ <code>n</code> æ˜¯ 130ã€‚æˆ‘ä»¬åœ¨å­—å…¸åºä¸­éå†æ—¶ï¼Œåº”è¯¥æ˜¯è¿™æ ·çš„é¡ºåºï¼š1, 10, 11, â€¦, 19, 2, 20, â€¦, 29, â€¦, 13, 130, 14, â€¦, 19, 2, â€¦, 9ã€‚</p><p>å½“æˆ‘ä»¬çš„ <code>curr</code> å˜æˆ 130 åï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ <code>curr+=1</code>ï¼Œé‚£ä¹ˆ <code>curr</code> å°±å˜æˆäº† 131ï¼Œè¿™æ˜¾ç„¶æ˜¯è¶…è¿‡ <code>n</code> çš„ï¼Œè€Œä¸”ä¸ç¬¦åˆå­—å…¸åºã€‚æˆ‘ä»¬åº”è¯¥è·³è¿‡æ‰€æœ‰ 13xï¼ˆx &gt; 0ï¼‰çš„æ•°å­—ï¼Œç›´æ¥å˜æˆ 14ã€‚</p><p>è¿™å°±æ˜¯ <code>while(curr%10==0) curr/=10;</code> è¿™è¡Œä»£ç çš„ç›®çš„ï¼šå½“ <code>curr</code> çš„æœ€åä¸€ä½æ˜¯ 0ï¼ˆå³ <code>curr%10==0</code>ï¼‰æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥é€€å›åˆ°ä¸Šä¸€å±‚ï¼ˆå³ <code>curr/=10</code>ï¼‰ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ130 é€€å›åˆ° 13ï¼Œç„¶å <code>curr+=1</code> å˜æˆ 14ï¼Œè¿™æ ·å°±ç¬¦åˆå­—å…¸åºäº†ã€‚</p><p>è¿™æ ·çš„å¤„ç†èƒ½ä¿è¯æˆ‘ä»¬çš„éå†é¡ºåºå§‹ç»ˆæ˜¯æŒ‰ç…§å­—å…¸åºè¿›è¡Œçš„ï¼Œå³å…ˆéå†åŒä¸€å±‚çš„æ•°ï¼Œç„¶åå†éå†ä¸‹ä¸€å±‚çš„æ•°ã€‚</p><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">lexicalOrder</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">         List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">         <span class="type">int</span> <span class="variable">curr</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">         <span class="comment">// éå†/traverse</span></span><br><span class="line">         <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">             list.add(curr);</span><br><span class="line">             <span class="keyword">if</span>(curr*<span class="number">10</span>&lt;=n)&#123;</span><br><span class="line">                 curr*=<span class="number">10</span>;<span class="comment">//éå†ä¸‹ä¸€å±‚/find next level number</span></span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="keyword">if</span>(curr&gt;=n)   curr/=<span class="number">10</span>;<span class="comment">//å¦‚æœæ¯”nå¤§ï¼Œç»“æŸéå†é€€å›ä¸Šä¸€å±‚/If greater than n, end traversal and return to previous level</span></span><br><span class="line">                 curr+=<span class="number">1</span>;</span><br><span class="line">                 <span class="keyword">while</span>(curr%<span class="number">10</span>==<span class="number">0</span>) curr/=<span class="number">10</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> list;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Qï¼š&quot;&gt;&lt;a href=&quot;#Qï¼š&quot; class=&quot;headerlink&quot; title=&quot;Qï¼š&quot;&gt;&lt;/a&gt;Qï¼š&lt;/h3&gt;&lt;p&gt;ç»™ä½ ä¸€ä¸ªæ•´æ•° &lt;code&gt;n&lt;/code&gt; ï¼ŒæŒ‰å­—å…¸åºè¿”å›èŒƒå›´ &lt;code&gt;[1, n]&lt;/code&gt; å†…æ‰€æœ‰æ•´æ•°ã€‚&lt;/p&gt;
&lt;p&gt;ä½ å¿…é¡»è®¾è®¡ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º &lt;code&gt;O(n)&lt;/code&gt; ä¸”ä½¿ç”¨ &lt;code&gt;O(1)&lt;/code&gt; é¢å¤–ç©ºé—´çš„ç®—æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="DFS" scheme="http://pjpjsocute.github.io/tags/DFS/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode-934</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-934/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-934/</id>
    <published>2023-05-12T07:22:55.000Z</published>
    <updated>2023-05-12T14:36:15.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="LeetCode-934"><a href="#LeetCode-934" class="headerlink" title="LeetCode-934"></a>LeetCode-934</h2><h3 id="Question"><a href="#Question" class="headerlink" title="Question:"></a>Question:</h3><p>ç»™ä½ ä¸€ä¸ªå¤§å°ä¸º <code>n x n</code> çš„äºŒå…ƒçŸ©é˜µ <code>grid</code> ï¼Œå…¶ä¸­ <code>1</code> è¡¨ç¤ºé™†åœ°ï¼Œ<code>0</code> è¡¨ç¤ºæ°´åŸŸã€‚</p><p><strong>å²›</strong> æ˜¯ç”±å››é¢ç›¸è¿çš„ <code>1</code> å½¢æˆçš„ä¸€ä¸ªæœ€å¤§ç»„ï¼Œå³ä¸ä¼šä¸éç»„å†…çš„ä»»ä½•å…¶ä»– <code>1</code> ç›¸è¿ã€‚<code>grid</code> ä¸­ <strong>æ°å¥½å­˜åœ¨ä¸¤åº§å²›</strong> ã€‚</p><p>ä½ å¯ä»¥å°†ä»»æ„æ•°é‡çš„ <code>0</code> å˜ä¸º <code>1</code> ï¼Œä»¥ä½¿ä¸¤åº§å²›è¿æ¥èµ·æ¥ï¼Œå˜æˆ <strong>ä¸€åº§å²›</strong> ã€‚</p><p>è¿”å›å¿…é¡»ç¿»è½¬çš„ <code>0</code> çš„æœ€å°æ•°ç›®ã€‚</p><span id="more"></span><h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution:</h3><p>å› ä¸ºé¢˜å¹²ä¸­åªæœ‰2ä¸ªå²›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ·±æœï¼Œå…ˆæ‰¾åˆ°å…¶ä¸­ä¸€ä¸ªå²›ã€‚</p><p>å¯¹è¿™ä¸ªå²›ä½¿ç”¨å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹è¿™ä¸ªå²›æ¯æ¬¡å‘å¤–æ‹“å±•1ï¼Œå½“æ‹“å±•ç¬¬Næ¬¡æ‰¾åˆ°å¦å¤–ä¸€ä¸ªå²›æ—¶ï¼Œåˆ™ä¸ºé¢˜å¹²æ‰€æ±‚è§£ã€‚</p><h3 id="Codeï¼š"><a href="#Codeï¼š" class="headerlink" title="Codeï¼š"></a>Codeï¼š</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">shortestBridge</span><span class="params">(<span class="type">int</span>[][] A)</span> &#123;</span><br><span class="line">        <span class="type">int</span> [][] direction = <span class="keyword">new</span> <span class="title class_">int</span> [][]&#123;&#123;<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;-<span class="number">1</span>,<span class="number">0</span>&#125;,&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,&#123;<span class="number">0</span>,-<span class="number">1</span>&#125;&#125;;</span><br><span class="line">        Deque&lt;<span class="type">int</span> []&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">boolean</span> [][] visited = <span class="keyword">new</span> <span class="title class_">boolean</span>[A.length][A[<span class="number">0</span>].length];</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;A.length&amp;&amp;flag;i++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;A[<span class="number">0</span>].length;j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (A[i][j] == <span class="number">1</span>) &#123;</span><br><span class="line">                    dfs(  A, i, j, queue, visited);</span><br><span class="line">                    flag = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty())&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> queue.size();</span><br><span class="line">            ans++;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;size;i++)&#123;</span><br><span class="line">                <span class="type">int</span> []node = queue.poll();</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">                    <span class="type">int</span>  <span class="variable">nx</span> <span class="operator">=</span> node[<span class="number">0</span>]+direction[j][<span class="number">0</span>];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">ny</span> <span class="operator">=</span> node[<span class="number">1</span>]+direction[j][<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">if</span>(nx&lt;<span class="number">0</span>||nx&gt;=A.length||ny&lt;<span class="number">0</span>||ny&gt;=A[<span class="number">0</span>].length||visited[nx][ny])    <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span>(A[nx][ny]==<span class="number">1</span>)    <span class="keyword">return</span> ans;</span><br><span class="line">                    visited[nx][ny] = <span class="literal">true</span>;</span><br><span class="line">                    queue.add(<span class="keyword">new</span> <span class="title class_">int</span> []&#123;nx,ny&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> [][]A,<span class="type">int</span> i,<span class="type">int</span> j,Deque queue,<span class="type">boolean</span>[][]visited)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;<span class="number">0</span>||i&gt;=A.length||j&lt;<span class="number">0</span>||j&gt;=A[<span class="number">0</span>].length||visited[i][j]||A[i][j]!=<span class="number">1</span>)    <span class="keyword">return</span>;</span><br><span class="line">        visited[i][j] = <span class="literal">true</span>;</span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">int</span> []&#123;i,j&#125;);</span><br><span class="line">        dfs( A, i-<span class="number">1</span>, j, queue, visited);</span><br><span class="line">        dfs( A, i+<span class="number">1</span>, j, queue, visited);</span><br><span class="line">        dfs( A, i, j-<span class="number">1</span>, queue, visited);</span><br><span class="line">        dfs( A, i, j+<span class="number">1</span>, queue, visited);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;LeetCode-934&quot;&gt;&lt;a href=&quot;#LeetCode-934&quot; class=&quot;headerlink&quot; title=&quot;LeetCode-934&quot;&gt;&lt;/a&gt;LeetCode-934&lt;/h2&gt;&lt;h3 id=&quot;Question&quot;&gt;&lt;a href=&quot;#Question&quot; class=&quot;headerlink&quot; title=&quot;Question:&quot;&gt;&lt;/a&gt;Question:&lt;/h3&gt;&lt;p&gt;ç»™ä½ ä¸€ä¸ªå¤§å°ä¸º &lt;code&gt;n x n&lt;/code&gt; çš„äºŒå…ƒçŸ©é˜µ &lt;code&gt;grid&lt;/code&gt; ï¼Œå…¶ä¸­ &lt;code&gt;1&lt;/code&gt; è¡¨ç¤ºé™†åœ°ï¼Œ&lt;code&gt;0&lt;/code&gt; è¡¨ç¤ºæ°´åŸŸã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å²›&lt;/strong&gt; æ˜¯ç”±å››é¢ç›¸è¿çš„ &lt;code&gt;1&lt;/code&gt; å½¢æˆçš„ä¸€ä¸ªæœ€å¤§ç»„ï¼Œå³ä¸ä¼šä¸éç»„å†…çš„ä»»ä½•å…¶ä»– &lt;code&gt;1&lt;/code&gt; ç›¸è¿ã€‚&lt;code&gt;grid&lt;/code&gt; ä¸­ &lt;strong&gt;æ°å¥½å­˜åœ¨ä¸¤åº§å²›&lt;/strong&gt; ã€‚&lt;/p&gt;
&lt;p&gt;ä½ å¯ä»¥å°†ä»»æ„æ•°é‡çš„ &lt;code&gt;0&lt;/code&gt; å˜ä¸º &lt;code&gt;1&lt;/code&gt; ï¼Œä»¥ä½¿ä¸¤åº§å²›è¿æ¥èµ·æ¥ï¼Œå˜æˆ &lt;strong&gt;ä¸€åº§å²›&lt;/strong&gt; ã€‚&lt;/p&gt;
&lt;p&gt;è¿”å›å¿…é¡»ç¿»è½¬çš„ &lt;code&gt;0&lt;/code&gt; çš„æœ€å°æ•°ç›®ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="åŠ›æ‰£ä¹‹æ—…" scheme="http://pjpjsocute.github.io/tags/%E5%8A%9B%E6%89%A3%E4%B9%8B%E6%97%85/"/>
    
      <category term="DFS" scheme="http://pjpjsocute.github.io/tags/DFS/"/>
    
  </entry>
  
  <entry>
    <title>springboot+cucumberå®è·µ</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/%E5%9F%BA%E4%BA%8Espringboot%E2%80%94%E2%80%94%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84BDD%E5%AE%9E%E8%B7%B5/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/åŸºäºspringbootâ€”â€”ä¸€ä¸ªç®€å•çš„BDDå®è·µ/</id>
    <published>2023-05-12T07:09:40.000Z</published>
    <updated>2023-05-13T08:37:20.685Z</updated>
    
    <content type="html"><![CDATA[<h1 id="springboot-cucumberå®è·µ"><a href="#springboot-cucumberå®è·µ" class="headerlink" title="springboot+cucumberå®è·µ"></a>springboot+cucumberå®è·µ</h1><h2 id="why-BDD"><a href="#why-BDD" class="headerlink" title="why BDD"></a>why BDD</h2><ul><li><strong>æ»¡è¶³ä¸šåŠ¡ç›®æ ‡ã€‚</strong></li><li><strong>å…³æ³¨ç”¨æˆ·éœ€æ±‚</strong></li><li><strong>è‰¯å¥½çš„å¯è¯»æ€§</strong></li></ul><p>å…¶å®å¯¹äºæˆ‘è‡ªå·±æ¥è¯´ï¼Œä¹Ÿæœ‰å…¶ä»–åŸå› ï¼š</p><p>1.å› ä¸ºå®¢è§‚åŸå› ï¼Œæœ‰æ—¶å€™é¡¹ç›®å¼€å‘ç»“æŸåæ‰æ‹¿åˆ°PRDï¼Œæ‰€ä»¥åœ¨å¼€å‘å‰æœŸï¼Œé€šè¿‡ä¸€äº›æ–¹å¼ç¡®å®šæ˜ç¡®çš„ä¸šåŠ¡æµç¨‹ä¼šæ¯”ç›´æ¥ä¸Šæ‰‹å¼€å‘å¯ä»¥æ›´å®¹æ˜“çš„å‘ç°é—®é¢˜ã€‚ç›¸æ¯”è¾ƒDDæ–‡æ¡£ï¼ŒBDDçš„featureå¯èƒ½æ˜¯å¯¹äºéå¼€å‘äººå‘˜æ›´æ˜“æ‡‚çš„æ–¹æ¡ˆã€‚</p><p>2.å› ä¸ºæ–‡æ¡£å¾€å¾€å­˜åœ¨æ»åï¼Œå¸®åŠ©å°†æ¥çš„è‡ªå·±æˆ–æ˜¯å…¶ä»–æ¥æ‰‹çš„åŒå­¦å»æ›´å¿«çš„å›é¡¾æˆ–æ˜¯äº†è§£æŸä¸ªä¸šåŠ¡çš„è¯‰æ±‚ã€‚</p><span id="more"></span><h2 id="ä¸€ä¸ªæ ·ä¾‹é¡¹ç›®çš„å¼€å§‹"><a href="#ä¸€ä¸ªæ ·ä¾‹é¡¹ç›®çš„å¼€å§‹" class="headerlink" title="ä¸€ä¸ªæ ·ä¾‹é¡¹ç›®çš„å¼€å§‹"></a>ä¸€ä¸ªæ ·ä¾‹é¡¹ç›®çš„å¼€å§‹</h2><h4 id="é¡¹ç›®åˆ†å±‚ï¼š"><a href="#é¡¹ç›®åˆ†å±‚ï¼š" class="headerlink" title="é¡¹ç›®åˆ†å±‚ï¼š"></a>é¡¹ç›®åˆ†å±‚ï¼š</h4><p><img src="/2023/05/12/%E5%9F%BA%E4%BA%8Espringboot%E2%80%94%E2%80%94%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84BDD%E5%AE%9E%E8%B7%B5/WX20230512-151458@2x.png" alt="WX20230512-151458@2x"></p><h4 id="ä»£ç ï¼š"><a href="#ä»£ç ï¼š" class="headerlink" title="ä»£ç ï¼š"></a>ä»£ç ï¼š</h4><p>ä»¥<strong>åŠŸèƒ½é…ç½®</strong>å•ä¸Šçº¿æ“ä½œä¸ºä¾‹</p><p>applicationä¸­å­˜åœ¨ä¸€ä¸ªä¸Šçº¿æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">interface</span> ConfigurationCmdService&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸Šçº¿åŠŸèƒ½</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Result&lt;Boolean&gt;  <span class="title function_">online</span><span class="params">(ConfigOnlineCmd cmd)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* æ¥å£éœ€è¦å®ç°ä¸Šçº¿åŠŸèƒ½</span></span><br><span class="line"><span class="comment">* å‡è®¾æ“ä½œåªéœ€è¦3æ­¥ï¼š</span></span><br><span class="line"><span class="comment">*1.æŸ¥åˆ°éœ€è¦ä¸Šçº¿çš„é…ç½®</span></span><br><span class="line"><span class="comment">*   2.ä¸Šçº¿æ“ä½œ</span></span><br><span class="line"><span class="comment">*   3.æ›´æ–°db</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">class</span> ConfigurationCmdServiceImpl <span class="keyword">implements</span> <span class="title class_">ConfigurationCmdService</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigRepository    repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConfigurationCmdServiceImpl</span><span class="params">(ConfigRepository repository,ConfigFactory factory)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.repository = repository;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ManualQueryServiceImpl</span><span class="params">(SnapshotRepository repository, ManualSnapshotFactory factory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.repository = repository;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@AutoWired</span></span><br><span class="line">    Result&lt;Boolean&gt;  <span class="title function_">online</span><span class="params">(ConfigOnlineCmd cmd)</span>&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> repository.queryById(cmd.getId());</span><br><span class="line">        config.online();</span><br><span class="line">        <span class="comment">//å¯èƒ½è¿˜æœ‰å…¶ä»–çš„ä¸€äº›æ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> repository.update(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BDDçš„æ¥å…¥"><a href="#BDDçš„æ¥å…¥" class="headerlink" title="BDDçš„æ¥å…¥"></a>BDDçš„æ¥å…¥</h2><h3 id="å‰ç½®å·¥ä½œ"><a href="#å‰ç½®å·¥ä½œ" class="headerlink" title="å‰ç½®å·¥ä½œ"></a>å‰ç½®å·¥ä½œ</h3><h4 id="cucumberä¾èµ–"><a href="#cucumberä¾èµ–" class="headerlink" title="cucumberä¾èµ–"></a>cucumberä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- bddä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.cucumber<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cucumber-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç»“åˆjunit4"><a href="#ç»“åˆjunit4" class="headerlink" title="ç»“åˆjunit4"></a>ç»“åˆjunit4</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven-surefire-plugin.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                        com.example.**Test.java</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">testFailureIgnore</span>&gt;</span>false<span class="tag">&lt;/<span class="name">testFailureIgnore</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>false<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.surefire<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>surefire-junit4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.22.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç»“åˆjacocoç”Ÿæˆå•æµ‹æŠ¥å‘Š"><a href="#ç»“åˆjacocoç”Ÿæˆå•æµ‹æŠ¥å‘Š" class="headerlink" title="ç»“åˆjacocoç”Ÿæˆå•æµ‹æŠ¥å‘Š"></a>ç»“åˆjacocoç”Ÿæˆå•æµ‹æŠ¥å‘Š</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jacoco<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jacoco-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jacoco.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>prepare-agent<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>report<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">phase</span>&gt;</span>prepare-package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>report<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- -æ’æ‰å·¥å…·ç±»åŒ… æ¯”æ–¹è¯´ï¼Œéœ€è¦æ’å‡ºå·¥å…·åŒ…--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.example.util.*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€æ­¥"><a href="#ç¬¬ä¸€æ­¥" class="headerlink" title="ç¬¬ä¸€æ­¥"></a>ç¬¬ä¸€æ­¥</h3><p>å¯åŠ¨ç±»</p><p>glueå®é™…ä¸Šæ˜¯å‘Šè¯‰cucumberå¯åŠ¨åå»æ‰«æå¯¹åº”åŒ…ä¸‹å«æœ‰@CucumberContextConfigurationçš„æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(Cucumber.class)</span></span><br><span class="line"><span class="meta">@CucumberOptions(</span></span><br><span class="line"><span class="meta">        features = &#123;&quot;classpath:feature&quot;&#125;,</span></span><br><span class="line"><span class="meta">        glue = &#123;&quot;com.example.step&quot;&#125;,</span></span><br><span class="line"><span class="meta">        plugin = &#123;&quot;pretty&quot;,&quot;html:target/html-reports.htm&quot;&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationTest</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®åœ¨æµ‹è¯•ä¸­éœ€è¦å¯åŠ¨çš„beanä»¥åŠä¸€äº›éœ€è¦å»mockçš„beanã€</p><p>initæ–¹æ³•åœ¨è¿è¡Œä¹‹å‰è§¦å‘ï¼Œresetæ–¹æ³•è§ç¬¬å››æ­¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CucumberContextConfiguration</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = &#123;</span></span><br><span class="line"><span class="meta">        SpringTestConfig.class,</span></span><br><span class="line"><span class="meta">        MockObjectConfiguration.class</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Resetable&gt; resetables;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        CollectionUtils.emptyIfNull(resetables)</span><br><span class="line">                .stream().forEach(v-&gt;v.reset());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒæ­¥"><a href="#ç¬¬äºŒæ­¥" class="headerlink" title="ç¬¬äºŒæ­¥"></a>ç¬¬äºŒæ­¥</h3><p>åœ¨classpath:featureä¸‹æ–°å»ºä¸€ä¸ªfeatureæ–‡ä»¶</p><p>#language:zh-CNä»£è¡¨è¯­è¨€ä¸ºä¸­æ–‡</p><figure class="highlight feature"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#language:zh-CN</span></span><br><span class="line">åŠŸèƒ½:é…ç½®çš„CMDæ“ä½œ</span><br><span class="line">  åœºæ™¯:ä¸Šçº¿ä¸€æ¡é…ç½®</span><br><span class="line">    å‡è®¾å­˜åœ¨ä»¥ä¸‹é…ç½®</span><br><span class="line">        |<span class="string">id  </span>|<span class="string"> content</span>|<span class="string"> status </span>|<span class="string"> bizCode </span>|</span><br><span class="line">        |<span class="string">1 </span>|<span class="string">xxxxx   </span>|<span class="string"> AUDIT  </span>|<span class="string"> XXXX    </span>|</span><br><span class="line">        |<span class="string">2 </span>|<span class="string">xxxxx   </span>|<span class="string"> DRAFT  </span>|<span class="string"> XXXX    </span>|</span><br><span class="line">    å½“idä¸º<span class="string">&quot;1&quot;</span>ä¸Šçº¿</span><br><span class="line">        |<span class="string"> languageType </span>|<span class="string"> bizCode </span>|</span><br><span class="line">        |<span class="string"> zh_CN        </span>|<span class="string"> 008     </span>|</span><br><span class="line">    é‚£ä¹ˆidä¸º<span class="string">&quot;1&quot;</span>çš„é…ç½®çŠ¶æ€ä¸º<span class="string">&quot;ä¸Šçº¿ä¸­&quot;</span></span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸‰æ­¥"><a href="#ç¬¬ä¸‰æ­¥" class="headerlink" title="ç¬¬ä¸‰æ­¥"></a>ç¬¬ä¸‰æ­¥</h3><p>å®ç°ä¸Šè¿°çš„åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ContentStep</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FakeConfigRepositoryImpl       configRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String                            result;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigurationCmdService cmdService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CODE</span> <span class="operator">=</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">AssertService</span> <span class="variable">contentAssertService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AssertService</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String,String&gt; codeMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;()&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            put(<span class="string">&quot;ä¸Šçº¿&quot;</span>,<span class="string">&quot;ONLINE&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;å®¡æ ¸&quot;</span>,<span class="string">&quot;AUDIT&quot;</span>);</span><br><span class="line">            put(<span class="string">&quot;è‰ç¨¿&quot;</span>,<span class="string">&quot;DRAFT&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    @å‡å¦‚(<span class="string">&quot;å‡è®¾å­˜åœ¨ä»¥ä¸‹é…ç½®&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> å­˜åœ¨ä»¥ä¸‹å†…å®¹(DataTable dataTable) &#123;</span><br><span class="line">        <span class="comment">//æ ¹æ®dataTableå»åˆ›å»ºä¸€æ¡å†…å®¹</span></span><br><span class="line">        List&lt;Config&gt; configs = ConfigTransform.transToConfig(dataTable.entries());</span><br><span class="line">        contentRepository.createAll(configs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @é‚£ä¹ˆ(<span class="string">&quot;idä¸º&#123;string&#125;çš„é…ç½®çŠ¶æ€ä¸º&#123;string&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> idä¸ºçš„é…ç½®çŠ¶æ€ä¸º(String id,String status)&#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> configRepository.queryById(id);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ç»“æœ</span></span><br><span class="line">        Assert.assertEquals(config.getStatus(),codeMap.get(status));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @å½“(<span class="string">&quot;idä¸º&#123;string&#125;ä¸Šçº¿&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> åœ¨idä¸ºçš„ç›®å½•ä¸‹æ’å…¥ä¸€æ¡å†…å®¹(String id)&#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºå‘½ä»¤</span></span><br><span class="line">        <span class="type">ContentCreateParam</span> <span class="variable">param</span> <span class="operator">=</span> createOnlineCmd(id);</span><br><span class="line">        <span class="comment">//è·å¾—ç»“æœ</span></span><br><span class="line">        result = cmdService.online(param).getData().toString();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬å››æ­¥"><a href="#ç¬¬å››æ­¥" class="headerlink" title="ç¬¬å››æ­¥"></a>ç¬¬å››æ­¥</h3><p>mock dbã€å¤–éƒ¨æœåŠ¡ã€‚ä»¥mock dbä¸ºä¾‹</p><p>DBä½¿ç”¨ä¸€ä¸ªmapæ¥æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ</p><p>resetæ“ä½œç”¨äºæ¸…ç©ºmapï¼Œæ¯ä¸€æ¡ç”¨ä¾‹éƒ½ä¼šè‡ªåŠ¨æ¸…ç©ºmapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FakeConfigRepositoryImpl</span> <span class="keyword">implements</span> <span class="title class_">SearchDataRepository</span> ,Resetable&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SearchDataDO&gt; doMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigConverter converter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FakeSearchDataRepositoryImpl</span><span class="params">(SearchDataConverter converter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.doMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.converter = converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">create</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        <span class="type">ConfigDO</span> <span class="variable">configDo</span> <span class="operator">=</span> converter.convert2DO(config);</span><br><span class="line">        doMap.put(String.valueOf(config.getId()),configDo);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ›´æ–°æ•°æ®</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">update</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        create(searchData);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> &#123;</span><br><span class="line">        doMap.clear();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>spring-testå’Œspring-contextç‰ˆæœ¬å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ¥é”™</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;springboot-cucumberå®è·µ&quot;&gt;&lt;a href=&quot;#springboot-cucumberå®è·µ&quot; class=&quot;headerlink&quot; title=&quot;springboot+cucumberå®è·µ&quot;&gt;&lt;/a&gt;springboot+cucumberå®è·µ&lt;/h1&gt;&lt;h2 id=&quot;why-BDD&quot;&gt;&lt;a href=&quot;#why-BDD&quot; class=&quot;headerlink&quot; title=&quot;why BDD&quot;&gt;&lt;/a&gt;why BDD&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ»¡è¶³ä¸šåŠ¡ç›®æ ‡ã€‚&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å…³æ³¨ç”¨æˆ·éœ€æ±‚&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è‰¯å¥½çš„å¯è¯»æ€§&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å…¶å®å¯¹äºæˆ‘è‡ªå·±æ¥è¯´ï¼Œä¹Ÿæœ‰å…¶ä»–åŸå› ï¼š&lt;/p&gt;
&lt;p&gt;1.å› ä¸ºå®¢è§‚åŸå› ï¼Œæœ‰æ—¶å€™é¡¹ç›®å¼€å‘ç»“æŸåæ‰æ‹¿åˆ°PRDï¼Œæ‰€ä»¥åœ¨å¼€å‘å‰æœŸï¼Œé€šè¿‡ä¸€äº›æ–¹å¼ç¡®å®šæ˜ç¡®çš„ä¸šåŠ¡æµç¨‹ä¼šæ¯”ç›´æ¥ä¸Šæ‰‹å¼€å‘å¯ä»¥æ›´å®¹æ˜“çš„å‘ç°é—®é¢˜ã€‚ç›¸æ¯”è¾ƒDDæ–‡æ¡£ï¼ŒBDDçš„featureå¯èƒ½æ˜¯å¯¹äºéå¼€å‘äººå‘˜æ›´æ˜“æ‡‚çš„æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;2.å› ä¸ºæ–‡æ¡£å¾€å¾€å­˜åœ¨æ»åï¼Œå¸®åŠ©å°†æ¥çš„è‡ªå·±æˆ–æ˜¯å…¶ä»–æ¥æ‰‹çš„åŒå­¦å»æ›´å¿«çš„å›é¡¾æˆ–æ˜¯äº†è§£æŸä¸ªä¸šåŠ¡çš„è¯‰æ±‚ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="é¡¹ç›®" scheme="http://pjpjsocute.github.io/tags/%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>æ ‘â€”â€”äºŒå‰æ ‘ã€å¹³è¡¡äºŒå‰æ ‘</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E2%80%94%E2%80%94%E4%BA%8C%E5%8F%89%E6%A0%91%E3%80%81%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/æ•°æ®ç»“æ„/æ ‘â€”â€”äºŒå‰æ ‘ã€å¹³è¡¡äºŒå‰æ ‘/</id>
    <published>2023-05-12T05:15:17.000Z</published>
    <updated>2023-05-13T08:36:41.533Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ ‘ï¼ˆTreeï¼‰æ˜¯ä¸€ç§é‡è¦çš„æ•°æ®ç»“æ„ï¼Œç”¨äºç»„ç»‡å’Œå­˜å‚¨æ•°æ®ã€‚æ ‘çš„ç»“æ„ç±»ä¼¼äºè‡ªç„¶ç•Œä¸­çš„æ ‘ï¼Œç”±æ ¹èŠ‚ç‚¹ï¼ˆRootï¼‰å’Œä¸€ç³»åˆ—è¿æ¥çš„èŠ‚ç‚¹ç»„æˆã€‚</p><p>â€‹        æ ‘æ˜¯ä¸€ç§éçº¿æ€§çš„æ•°æ®ç»“æ„ï¼Œç”±èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œè¿æ¥èŠ‚ç‚¹çš„è¾¹ï¼ˆEdgeï¼‰ç»„æˆã€‚æ ‘çš„å®šä¹‰å’Œç‰¹ç‚¹å¦‚ä¸‹ï¼š</p><ol><li><p>å®šä¹‰ï¼šæ ‘æ˜¯ä¸€ä¸ªé›†åˆï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç§°ä¸ºæ ¹èŠ‚ç‚¹ï¼ˆRootï¼‰çš„ç‰¹æ®ŠèŠ‚ç‚¹ï¼Œä»¥åŠæ ¹èŠ‚ç‚¹çš„é›¶ä¸ªæˆ–å¤šä¸ªå­æ ‘ï¼Œæ¯ä¸ªå­æ ‘ä¹Ÿæ˜¯ä¸€æ£µæ ‘ï¼Œå­æ ‘ä¹‹é—´äº’ç›¸ç‹¬ç«‹ä¸”æ²¡æœ‰å¾ªç¯ã€‚</p><span id="more"></span></li><li><p>æ ¹èŠ‚ç‚¹ï¼šæ ‘çš„é¡¶å±‚èŠ‚ç‚¹ï¼Œå®ƒæ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”æ²¡æœ‰çˆ¶èŠ‚ç‚¹ã€‚</p></li><li><p>èŠ‚ç‚¹å…³ç³»ï¼šæ ‘ä¸­çš„èŠ‚ç‚¹å¯ä»¥é€šè¿‡è¾¹è¿æ¥ï¼Œä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰é›¶ä¸ªæˆ–å¤šä¸ªå­èŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªå­èŠ‚ç‚¹åˆå¯ä»¥æœ‰è‡ªå·±çš„å­èŠ‚ç‚¹ï¼Œå½¢æˆå±‚çº§å…³ç³»ã€‚</p></li><li><p>èŠ‚ç‚¹åº¦ï¼ˆDegreeï¼‰ï¼šèŠ‚ç‚¹çš„åº¦æ˜¯æŒ‡èŠ‚ç‚¹æ‰€æ‹¥æœ‰çš„å­èŠ‚ç‚¹æ•°é‡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„åº¦ä¸º0è¡¨ç¤ºå®ƒæ˜¯å¶èŠ‚ç‚¹ï¼ˆLeafï¼‰ï¼Œåº¦å¤§äº0è¡¨ç¤ºå®ƒæœ‰å­èŠ‚ç‚¹ã€‚</p></li><li><p>çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹ï¼šæ¯ä¸ªèŠ‚ç‚¹é™¤äº†æ ¹èŠ‚ç‚¹å¤–ï¼Œéƒ½æœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹è¿æ¥ç€å®ƒçš„å­èŠ‚ç‚¹ã€‚ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œå­èŠ‚ç‚¹ä¹‹é—´æ²¡æœ‰é¡ºåºå…³ç³»ã€‚</p></li><li><p>å…„å¼ŸèŠ‚ç‚¹ï¼šæ‹¥æœ‰åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ç§°ä¸ºå…„å¼ŸèŠ‚ç‚¹ã€‚</p></li><li><p>å¶èŠ‚ç‚¹ï¼šæ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ç§°ä¸ºå¶èŠ‚ç‚¹ï¼Œä¹Ÿç§°ä¸ºç»ˆç«¯èŠ‚ç‚¹ã€‚å¶èŠ‚ç‚¹ä½äºæ ‘çš„æœ«ç«¯ã€‚</p></li><li><p>æ·±åº¦ï¼ˆDepthï¼‰ï¼šèŠ‚ç‚¹çš„æ·±åº¦æ˜¯æŒ‡ä»æ ¹èŠ‚ç‚¹åˆ°è¯¥èŠ‚ç‚¹æ‰€ç»è¿‡çš„è¾¹çš„æ•°é‡ã€‚æ ¹èŠ‚ç‚¹çš„æ·±åº¦ä¸º0ï¼Œå®ƒçš„å­èŠ‚ç‚¹çš„æ·±åº¦ä¸º1ï¼Œä¾æ­¤ç±»æ¨ã€‚</p></li><li><p>é«˜åº¦ï¼ˆHeightï¼‰ï¼šèŠ‚ç‚¹çš„é«˜åº¦æ˜¯æŒ‡ä»è¯¥èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹çš„æœ€é•¿è·¯å¾„ä¸Šæ‰€ç»è¿‡çš„è¾¹çš„æ•°é‡ã€‚å¶èŠ‚ç‚¹çš„é«˜åº¦ä¸º0ï¼Œæ ¹èŠ‚ç‚¹çš„é«˜åº¦ä¸ºæ•´æ£µæ ‘çš„æœ€å¤§é«˜åº¦ã€‚</p></li><li><p>å­æ ‘ï¼ˆSubtreeï¼‰ï¼šä¸€ä¸ªèŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹ä»¥åŠä¸å®ƒä»¬ä¹‹é—´çš„è¿æ¥æ„æˆäº†ä¸€ä¸ªå­æ ‘ã€‚</p></li><li><p>æœ‰å‘æ ‘å’Œæ— å‘æ ‘ï¼šæ ‘çš„è¾¹å¯ä»¥æ˜¯æœ‰å‘çš„æˆ–æ— å‘çš„ã€‚æœ‰å‘æ ‘ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥æœ‰æ–¹å‘æ€§ï¼Œè€Œæ— å‘æ ‘ä¸­ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥æ²¡æœ‰æ–¹å‘æ€§ã€‚</p></li></ol><p>æ ‘çš„ç‰¹ç‚¹åŒ…æ‹¬å±‚æ¬¡æ€§ã€åˆ†æ”¯æ€§ã€å±‚çº§å…³ç³»ã€æ— ç¯ã€å”¯ä¸€æ ¹èŠ‚ç‚¹ç­‰ï¼Œä½¿å¾—æ ‘åœ¨ç»„ç»‡å’Œå­˜å‚¨æ•°æ®æ–¹é¢å…·æœ‰å¾ˆé«˜çš„çµæ´»æ€§å’Œé€‚ç”¨æ€§ã€‚æ ‘ç»“æ„åœ¨ç®—æ³•å’Œæ•°æ®å¤„ç†ä¸­æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œä¾‹å¦‚æœç´¢ã€æ’åºã€å›¾ç®—æ³•ç­‰ã€‚ä¸åŒç±»å‹çš„æ ‘ç»“æ„åœ¨å…·ä½“åº”ç”¨ä¸­æœ‰ä¸åŒçš„ç‰¹ç‚¹å’Œæ€§èƒ½ç‰¹å¾ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ ‘ç»“æ„æ¥è§£å†³é—®é¢˜ã€‚</p><h3 id="äºŒå‰æ ‘"><a href="#äºŒå‰æ ‘" class="headerlink" title="äºŒå‰æ ‘"></a>äºŒå‰æ ‘</h3><p>â€‹                </p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h3&gt;&lt;p&gt;åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œæ ‘ï¼ˆTreeï¼‰æ˜¯ä¸€ç§é‡è¦çš„æ•°æ®ç»“æ„ï¼Œç”¨äºç»„ç»‡å’Œå­˜å‚¨æ•°æ®ã€‚æ ‘çš„ç»“æ„ç±»ä¼¼äºè‡ªç„¶ç•Œä¸­çš„æ ‘ï¼Œç”±æ ¹èŠ‚ç‚¹ï¼ˆRootï¼‰å’Œä¸€ç³»åˆ—è¿æ¥çš„èŠ‚ç‚¹ç»„æˆã€‚&lt;/p&gt;
&lt;p&gt;â€‹        æ ‘æ˜¯ä¸€ç§éçº¿æ€§çš„æ•°æ®ç»“æ„ï¼Œç”±èŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œè¿æ¥èŠ‚ç‚¹çš„è¾¹ï¼ˆEdgeï¼‰ç»„æˆã€‚æ ‘çš„å®šä¹‰å’Œç‰¹ç‚¹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;å®šä¹‰ï¼šæ ‘æ˜¯ä¸€ä¸ªé›†åˆï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç§°ä¸ºæ ¹èŠ‚ç‚¹ï¼ˆRootï¼‰çš„ç‰¹æ®ŠèŠ‚ç‚¹ï¼Œä»¥åŠæ ¹èŠ‚ç‚¹çš„é›¶ä¸ªæˆ–å¤šä¸ªå­æ ‘ï¼Œæ¯ä¸ªå­æ ‘ä¹Ÿæ˜¯ä¸€æ£µæ ‘ï¼Œå­æ ‘ä¹‹é—´äº’ç›¸ç‹¬ç«‹ä¸”æ²¡æœ‰å¾ªç¯ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="Tree" scheme="http://pjpjsocute.github.io/tags/Tree/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®ç»“æ„â€”â€”é“¾è¡¨ã€æ ˆã€é˜Ÿåˆ—</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/æ•°æ®ç»“æ„/æ•°æ®ç»“æ„â€”â€”é“¾è¡¨ã€æ ˆã€é˜Ÿåˆ—/</id>
    <published>2023-05-12T05:15:17.000Z</published>
    <updated>2023-05-13T05:57:32.468Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>â€‹    é“¾è¡¨ã€é˜Ÿåˆ—ã€æ ˆï¼Œæ˜¯æ•°æ®ç»“æ„ä¸­æœ€åŸºç¡€çš„å‡ ä¸ªç»“æ„ï¼Œè€Œé“¾è¡¨æ˜¯æœ€åŸºç¡€çš„ã€‚ä¹‹åçš„å¤æ‚æ•°æ®ç»“æ„å¤§éƒ½æ˜¯åœ¨å…¶åŸºç¡€ä¸Šæ¼”åŒ–å‡ºæ¥çš„ã€‚</p><h3 id="é“¾è¡¨"><a href="#é“¾è¡¨" class="headerlink" title="é“¾è¡¨"></a>é“¾è¡¨</h3><p>â€‹    ä¸€ç§çº¿ç¨‹æ•°æ®ç»“æ„ï¼Œä¸æ•°ç»„ä¸åŒçš„æ˜¯ï¼Œå®ƒåœ¨å†…å­˜ç©ºé—´ä¸­ä¸ä¸€å®šæ˜¯é¡ºåºå­˜å‚¨çš„ï¼Œä¸ºäº†ä¿è¯é“¾è¡¨ä¸­å…ƒç´ çš„è¿ç»­æ€§ï¼Œä¸€èˆ¬ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæ¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚</p><p><img src="/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/WX20230512-133517@2x.png" alt="linkedlist"></p><span id="more"></span><p>ä½¿ç”¨javaå®ç°ä¸€ä¸ªé“¾è¡¨é“¾è¡¨ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line">        T       value;</span><br><span class="line">        Node&lt;T&gt; next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(T value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¯¹äºé“¾è¡¨æ¥è¯´ï¼Œå¦‚æœæƒ³è¦æ ¹æ®ç´¢å¼•æŸ¥æ‰¾å…ƒç´ ï¼Œåªèƒ½ä»å¤´å¼€å§‹ï¼Œæ—¶é—´å¤æ‚åº¦O(N).</p><p>å¦‚æœåœ¨Nodeä¸­å¢åŠ äº†å‰é©±èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±ä¼šæˆä¸ºåŒå‘é“¾è¡¨ã€‚</p><p><img src="/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/WX20230512-134440@2x.png" alt="doublelinkedlist"></p><p>Javaä¸­çš„LinkedListå°±æ˜¯å…¸å‹çš„åŒå‘é“¾è¡¨ã€‚</p><p>å¦‚æœåœ¨LinkedListä¸Šç»“åˆHashMap(Set)å°±æ˜¯<strong>LinkedHashMap</strong>(Set),æ—¢ä¿è¯äº†å…ƒç´ çš„æœ‰åºæ€§ï¼Œæœ‰å¯ä»¥O1è·å–å…ƒç´ ã€‚</p><p>ä¸€ä¸ªç®€å•çš„é“¾è¡¨å®ç°å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> table;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="comment">//å•å‘é“¾è¡¨</span></span><br><span class="line"><span class="comment">//å¤´ç»“ç‚¹ä¸å­˜å…ƒç´ </span></span><br><span class="line"><span class="comment">//éœ€è¦ä¸€ä¸ªè®°å½•é¦–èŠ‚ç‚¹,å†…å®¹ä¸ºnullï¼›ä¸€ä¸ªè®°å½•é“¾è¡¨é•¿åº¦</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkList</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;T&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span> Node head;<span class="comment">//å¤´ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> N;<span class="comment">//é“¾è¡¨é•¿åº¦</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt; &#123;</span><br><span class="line">        T item;                                     <span class="comment">//å­˜å‚¨å…ƒç´ </span></span><br><span class="line">        Node next;                                      <span class="comment">//æŒ‡å‘ä¸‹ä¸€èŠ‚ç‚¹ ä¸€ä¸ªNodeå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(T item, Node next)</span>&#123;             <span class="comment">//æœ‰å‚æ„é€ </span></span><br><span class="line">            <span class="built_in">this</span>.item = item;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LinkList</span><span class="params">()</span>&#123;<span class="comment">//æ— å‚åˆå§‹åŒ–</span></span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.N = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span>&#123;<span class="comment">//æ¸…ç©ºé“¾è¡¨ï¼šå¤´ç»“ç‚¹ä¸æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        N=<span class="number">0</span>;</span><br><span class="line">        head.next = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span>&#123;<span class="comment">//åˆ¤æ–­ç©º</span></span><br><span class="line">        <span class="keyword">return</span> N==<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">length</span><span class="params">()</span>&#123;<span class="comment">//æ±‚é•¿åº¦</span></span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">(<span class="type">int</span> i)</span>&#123; <span class="comment">//è·å–ç¬¬iä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="comment">//åˆ©ç”¨å¾ªç¯ï¼Œä»å¤´ç»“ç‚¹å‘åéå†ï¼Œæ‰¾iæ¬¡</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">n</span> <span class="operator">=</span> head.next;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span><span class="number">0</span>;index &lt;i;index++)&#123;</span><br><span class="line">            n = n.next; <span class="comment">//å¾ªç¯æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) n.item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(T t)</span>&#123;                                        <span class="comment">//æ·»åŠ æ•°æ®</span></span><br><span class="line">                                                                    <span class="comment">//æ·»åŠ å…ƒç´ åªéœ€è¦å°†æœ€åä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">n</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">while</span>(n.next!=<span class="literal">null</span>)&#123;</span><br><span class="line">            n = n.next;                                             <span class="comment">//å°¾èŠ‚ç‚¹ä¸ä¸ºnullä¸èƒ½æ¢</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">newNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(t,<span class="literal">null</span>);</span><br><span class="line">        n.next =newNode;</span><br><span class="line">        N++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(<span class="type">int</span> i,T t)</span>&#123;                      <span class="comment">//iä¹‹å‰æ·»åŠ æ•°æ®</span></span><br><span class="line">                                                        <span class="comment">//æ‰¾åˆ°iå‰çš„ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">pre</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;index&lt;=i-<span class="number">1</span>;index++)&#123;                             <span class="comment">///å› ä¸ºå¤´ç»“ç‚¹å®é™…å¾ªç¯i-1æ¬¡</span></span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line">                                                 <span class="comment">//æ‰¾åˆ°ièŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">curr</span> <span class="operator">=</span> pre.next;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ–°èŠ‚ç‚¹å¹¶æŒ‡å‘i</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">newNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(t,curr);</span><br><span class="line">        <span class="comment">//iä¹‹å‰çš„èŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">        pre.next = newNode;</span><br><span class="line">        <span class="comment">//åŠ 1</span></span><br><span class="line">        N++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">remove</span> <span class="params">(<span class="type">int</span> i)</span>&#123;<span class="comment">//åˆ é™¤ç¬¬iä¸ªå…ƒç´ å¹¶è¿”å›</span></span><br><span class="line">        <span class="comment">//è·å¾—iä¹‹å‰çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">pre</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;index&lt;=i-<span class="number">1</span>;index++)&#123;</span><br><span class="line">            pre = pre.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°i</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">curr</span> <span class="operator">=</span> pre.next;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°iåçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">fur</span> <span class="operator">=</span> curr.next;</span><br><span class="line">        <span class="comment">//å°†2è€…è¿æ¥å-1</span></span><br><span class="line">        pre.next = fur;</span><br><span class="line">        N--;</span><br><span class="line">        <span class="keyword">return</span> (T) curr.item;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">indexOf</span><span class="params">(T t)</span>&#123;<span class="comment">//è¿”å›é¦–æ¬¡å‡ºç°å…ƒç´ çš„åºåˆ—</span></span><br><span class="line">        <span class="comment">//å¤´ç»“ç‚¹å¼€å§‹éå†ï¼Œæ‰¾åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„å…ƒç´ ï¼Œå–å‡ºitemä¸Tæ¯”è¾ƒ</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">n</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;n.next!=<span class="literal">null</span>;i++)&#123;<span class="comment">//ä¸‹ä¸€ä¸ªå…ƒç´ ä¸æ˜¯nullå°±ä¸€ç›´æ‰¾</span></span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">if</span> (n.item.equals(t))&#123;</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">            &#125;<span class="comment">//æ²¡æœ‰è®¾ç½®å¯¹ä¸å­˜åœ¨çš„è¿™ä¸€å…ƒç´ çš„æé†’</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reverse</span><span class="params">()</span>&#123;  <span class="comment">//ç¿»è½¬å•é“¾è¡¨  é€’å½’ç¿»è½¬</span></span><br><span class="line">        <span class="keyword">if</span> (isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            reverse(head.next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Node <span class="title function_">reverse</span><span class="params">(Node curr)</span>&#123;  <span class="comment">//ç¿»è½¬å•é“¾è¡¨cur,å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span>(curr.next==<span class="literal">null</span>)&#123;</span><br><span class="line">            head.next = curr;</span><br><span class="line">            <span class="keyword">return</span> curr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é€’å½’ç¿»è½¬å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">per</span> <span class="operator">=</span> reverse(curr.next); <span class="comment">//æ–°èŠ‚ç‚¹ä¸ºç¿»è½¬åçš„ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line">        per.next = curr; <span class="comment">//æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºåè½¬å‰çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        curr.next = <span class="literal">null</span>; <span class="comment">//è¿™ä¸ªèŠ‚ç‚¹è®¾ä¸ºå°¾ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> curr;</span><br><span class="line">            <span class="comment">//ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹é‚£ä¹ˆåˆ™é€’å½’ç¿»è½¬æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">LIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Node n;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LIterator</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.n = head; <span class="comment">///åˆå§‹åŒ–</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123; <span class="comment">//æ»¡è¶³hasNextæ¡ä»¶åˆ™ä¸æ–­æ‰§è¡Œnext</span></span><br><span class="line">            <span class="keyword">return</span> n.next!=<span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">return</span> n.item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç®—æ³•é¢˜ä¸­ï¼Œé“¾è¡¨ç»å¸¸å‡ºç°ï¼Œæ¯”è¾ƒåŸºç¡€çš„é¢˜å‹åŒ…æ‹¬ï¼šé“¾è¡¨çš„ç¿»è½¬ï¼Œç¯åˆ¤æ–­ï¼Œç¯å…¥å£ï¼Œå¤šé“¾è¡¨æ±‚ç¬¬Kå¤§-å°å…ƒç´ ç­‰ã€‚é“¾è¡¨ä¹Ÿæ˜¯å®ç°è·³è¡¨çš„åŸºç¡€ã€‚"><a href="#ç®—æ³•é¢˜ä¸­ï¼Œé“¾è¡¨ç»å¸¸å‡ºç°ï¼Œæ¯”è¾ƒåŸºç¡€çš„é¢˜å‹åŒ…æ‹¬ï¼šé“¾è¡¨çš„ç¿»è½¬ï¼Œç¯åˆ¤æ–­ï¼Œç¯å…¥å£ï¼Œå¤šé“¾è¡¨æ±‚ç¬¬Kå¤§-å°å…ƒç´ ç­‰ã€‚é“¾è¡¨ä¹Ÿæ˜¯å®ç°è·³è¡¨çš„åŸºç¡€ã€‚" class="headerlink" title="ç®—æ³•é¢˜ä¸­ï¼Œé“¾è¡¨ç»å¸¸å‡ºç°ï¼Œæ¯”è¾ƒåŸºç¡€çš„é¢˜å‹åŒ…æ‹¬ï¼šé“¾è¡¨çš„ç¿»è½¬ï¼Œç¯åˆ¤æ–­ï¼Œç¯å…¥å£ï¼Œå¤šé“¾è¡¨æ±‚ç¬¬Kå¤§/å°å…ƒç´ ç­‰ã€‚é“¾è¡¨ä¹Ÿæ˜¯å®ç°è·³è¡¨çš„åŸºç¡€ã€‚"></a>ç®—æ³•é¢˜ä¸­ï¼Œé“¾è¡¨ç»å¸¸å‡ºç°ï¼Œæ¯”è¾ƒåŸºç¡€çš„é¢˜å‹åŒ…æ‹¬ï¼šé“¾è¡¨çš„ç¿»è½¬ï¼Œç¯åˆ¤æ–­ï¼Œç¯å…¥å£ï¼Œå¤šé“¾è¡¨æ±‚ç¬¬Kå¤§/å°å…ƒç´ ç­‰ã€‚é“¾è¡¨ä¹Ÿæ˜¯å®ç°è·³è¡¨çš„åŸºç¡€ã€‚</h4><h3 id="é˜Ÿåˆ—-æ ˆ"><a href="#é˜Ÿåˆ—-æ ˆ" class="headerlink" title="é˜Ÿåˆ—/æ ˆ"></a>é˜Ÿåˆ—/æ ˆ</h3><p>â€‹    é“¾è¡¨å’Œé˜Ÿåˆ—æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç‰¹æ®Šçš„å•é“¾è¡¨ï¼Œä¸åŒä¹‹å¤„åœ¨äºä»–ä»¬é™åˆ¶äº†å…ƒç´ çš„æ’å…¥/åˆ é™¤é¡ºåºã€‚</p><h4 id="é˜Ÿåˆ—ï¼š"><a href="#é˜Ÿåˆ—ï¼š" class="headerlink" title="é˜Ÿåˆ—ï¼š"></a>é˜Ÿåˆ—ï¼š</h4><p>â€‹    å¯¹äºé˜Ÿåˆ—æ¥è¯´ï¼Œå…ƒç´ ä»ä¸€ç«¯è¿›å…¥ï¼Œä»å¦ä¸€ç«¯å‡ºå»ï¼Œä¹Ÿå°±æ˜¯å…ˆå…¥çš„å…ƒç´ å…ˆè¢«åˆ é™¤ï¼Œè‹±æ–‡å«åšï¼šFirst Inï¼ŒFirst Outï¼Œç®€å†™FIFOã€‚</p><p><img src="/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/WX20230512-135224@2x.png" alt="queue"></p><p>â€‹    é˜Ÿåˆ—æ¯”è¾ƒç»å…¸çš„ä½¿ç”¨æ˜¯åœ¨å¹¿åº¦ä¼˜å…ˆæœç´¢å½“ä¸­(æ ‘çš„å±‚åºéå†å…¶å®ä¹Ÿæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢)ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥æ‹¥æœ‰é¡ºåºï¼Œç§°ä¹‹ä¸ºä¼˜å…ˆé˜Ÿåˆ—ï¼Œåœ¨javaå·²ç»æœ‰å®ç°ï¼Œç§°ä¹‹ä¸º<strong>PriorityQueue</strong>ã€‚</p><h4 id="é˜Ÿåˆ—å®ç°"><a href="#é˜Ÿåˆ—å®ç°" class="headerlink" title="é˜Ÿåˆ—å®ç°:"></a>é˜Ÿåˆ—å®ç°:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> zhan;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…ˆè¿›å…ˆå‡º æ ˆç›¸æ¯”ï¼Œé˜Ÿåˆ—ä¸€ç«¯è¿›ä¸€ç«¯å‡ºã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Queue</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt;&#123;</span><br><span class="line">        <span class="keyword">public</span> T item;</span><br><span class="line">        <span class="keyword">public</span> Node next;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(T item,Node next)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.item = item;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Node head;  <span class="comment">//å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> N;</span><br><span class="line">    <span class="keyword">private</span> Node last;  <span class="comment">//å°¾</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Queue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.last = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.N = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N==<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(T t)</span>&#123;           <span class="comment">//ç”±lastæ’å…¥é“¾è¡¨,ä»é¦–èŠ‚ç‚¹ä¾æ¬¡æ’å…¥</span></span><br><span class="line">        <span class="keyword">if</span> (last == <span class="literal">null</span>)&#123;</span><br><span class="line">            last= <span class="keyword">new</span> <span class="title class_">Node</span>(t,<span class="literal">null</span>);</span><br><span class="line">            head.next = last;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">oldlast</span> <span class="operator">=</span> last;</span><br><span class="line">            last = <span class="keyword">new</span> <span class="title class_">Node</span>(t,<span class="literal">null</span>);</span><br><span class="line">            oldlast.next = last;</span><br><span class="line">        &#125;</span><br><span class="line">        N++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">dequeue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isEmpty())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;            <span class="comment">//å¤´ç»“ç‚¹å¼€å§‹åˆ é™¤</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">oldeFirst</span> <span class="operator">=</span> head.next;</span><br><span class="line">        head.next = oldeFirst.next;</span><br><span class="line">        N--;</span><br><span class="line">        <span class="comment">//åˆ é˜Ÿåˆ—åœ¨åˆ é™¤å…ƒç´ ï¼Œæ‰€ä»¥éœ€è¦é‡ç½®last</span></span><br><span class="line">        <span class="keyword">if</span> (isEmpty())&#123;</span><br><span class="line">            last = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T)oldeFirst.item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">iterator</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">QIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">QIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Node n;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">QIterator</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.n = head;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n.next!=<span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">return</span> (T)n.item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ ˆï¼š"><a href="#æ ˆï¼š" class="headerlink" title="æ ˆï¼š"></a>æ ˆï¼š</h4><p>â€‹    æ ˆåˆ™ç›¸åï¼Œå…ƒç´ ä»ä¸€ç«¯è¿›ï¼Œå°±è¦ä»ä¸€ç«¯å‡ºã€‚ä¹Ÿå°±æ˜¯å…ˆè¿›åå‡ºï¼Œè‹±æ–‡å«åšï¼šFirst Inï¼ŒLast Outï¼Œç®€ç§°FILOã€‚</p><p><img src="/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/WX20230512-135651@2x.png" alt="stack"></p><p>â€‹    æ ˆåœ¨ç®—æ³•ä¸­ç»å¸¸ä½¿ç”¨åˆ°ï¼Œè¯¸å¦‚æ‹¬å·æ ‡ç‚¹åŒ¹é…é—®é¢˜ï¼Œå•è°ƒæ ˆé—®é¢˜ç­‰ï¼Œé€’å½’ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹æ ˆçš„ä½¿ç”¨ã€‚</p><h4 id="stackå®ç°ï¼š"><a href="#stackå®ç°ï¼š" class="headerlink" title="stackå®ç°ï¼š"></a>stackå®ç°ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> zhan;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é“¾è¡¨æ ˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Stack</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterable</span>&lt;T&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;T&gt;&#123;      <span class="comment">//é“¾è¡¨ç±»</span></span><br><span class="line">        <span class="keyword">public</span> T item;</span><br><span class="line">        <span class="keyword">public</span> Node next;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Node</span><span class="params">(T item,Node next)</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.item =item;</span><br><span class="line">            <span class="built_in">this</span>.next = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> N;          <span class="comment">//æ ˆå…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">private</span> Node head;      <span class="comment">//è®°å½•å¤´å…ƒç´ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Stack</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.N = N;</span><br><span class="line">        <span class="built_in">this</span>.head = <span class="keyword">new</span> <span class="title class_">Node</span>(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N==<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> N;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å†™å‹æ ˆ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(T t)</span>&#123;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°é¦–èŠ‚ç‚¹æŒ‡å‘çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">oldNode</span> <span class="operator">=</span> head.next;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">newNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(t,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//é¦–èŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">        head.next = newNode;</span><br><span class="line">        <span class="comment">//æ–°èŠ‚ç‚¹æŒ‡å‘åŸæ¥çš„ç¬¬ä¸€èŠ‚ç‚¹</span></span><br><span class="line">        newNode.next = oldNode;</span><br><span class="line">        N++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">pop</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//é¦–èŠ‚ç‚¹æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">oldFirst</span> <span class="operator">=</span> head.next;</span><br><span class="line">        <span class="comment">//head.next = oldFirst.nextä¸å®‰å…¨ï¼Œéœ€è¦æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (oldFirst==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        head.next = oldFirst.next;</span><br><span class="line">        N--;</span><br><span class="line">        <span class="keyword">return</span> (T)oldFirst.item;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LIterator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">LIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Node n;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LIterator</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.n = head;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n.next!=<span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            n = n.next;</span><br><span class="line">            <span class="keyword">return</span> n.item;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;â€‹    é“¾è¡¨ã€é˜Ÿåˆ—ã€æ ˆï¼Œæ˜¯æ•°æ®ç»“æ„ä¸­æœ€åŸºç¡€çš„å‡ ä¸ªç»“æ„ï¼Œè€Œé“¾è¡¨æ˜¯æœ€åŸºç¡€çš„ã€‚ä¹‹åçš„å¤æ‚æ•°æ®ç»“æ„å¤§éƒ½æ˜¯åœ¨å…¶åŸºç¡€ä¸Šæ¼”åŒ–å‡ºæ¥çš„ã€‚&lt;/p&gt;
&lt;h3 id=&quot;é“¾è¡¨&quot;&gt;&lt;a href=&quot;#é“¾è¡¨&quot; class=&quot;headerlink&quot; title=&quot;é“¾è¡¨&quot;&gt;&lt;/a&gt;é“¾è¡¨&lt;/h3&gt;&lt;p&gt;â€‹    ä¸€ç§çº¿ç¨‹æ•°æ®ç»“æ„ï¼Œä¸æ•°ç»„ä¸åŒçš„æ˜¯ï¼Œå®ƒåœ¨å†…å­˜ç©ºé—´ä¸­ä¸ä¸€å®šæ˜¯é¡ºåºå­˜å‚¨çš„ï¼Œä¸ºäº†ä¿è¯é“¾è¡¨ä¸­å…ƒç´ çš„è¿ç»­æ€§ï¼Œä¸€èˆ¬ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæ¥æ‰¾åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E2%80%94%E2%80%94%E9%93%BE%E8%A1%A8%E3%80%81%E6%A0%88%E3%80%81%E9%98%9F%E5%88%97/WX20230512-133517@2x.png&quot; alt=&quot;linkedlist&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="LinkedList" scheme="http://pjpjsocute.github.io/tags/LinkedList/"/>
    
  </entry>
  
  <entry>
    <title>æ ‘â€”â€”å †ã€ä¼˜å…ˆé˜Ÿåˆ—</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E2%80%94%E2%80%94%E5%A0%86%E3%80%81%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/æ•°æ®ç»“æ„/æ ‘â€”â€”å †ã€ä¼˜å…ˆé˜Ÿåˆ—/</id>
    <published>2023-05-12T05:15:17.000Z</published>
    <updated>2023-05-13T05:58:57.860Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="Tree" scheme="http://pjpjsocute.github.io/tags/Tree/"/>
    
  </entry>
  
  <entry>
    <title>æ ‘â€”â€”å¹¶æŸ¥é›†</title>
    <link href="http://pjpjsocute.github.io/2023/05/12/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E2%80%94%E2%80%94%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
    <id>http://pjpjsocute.github.io/2023/05/12/æ•°æ®ç»“æ„/æ ‘â€”â€”å¹¶æŸ¥é›†/</id>
    <published>2023-05-12T05:15:17.000Z</published>
    <updated>2023-05-13T05:59:09.560Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="æŠ€æœ¯" scheme="http://pjpjsocute.github.io/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="java" scheme="http://pjpjsocute.github.io/tags/java/"/>
    
      <category term="æ•°æ®ç»“æ„" scheme="http://pjpjsocute.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="Union Find" scheme="http://pjpjsocute.github.io/tags/Union-Find/"/>
    
  </entry>
  
</feed>
