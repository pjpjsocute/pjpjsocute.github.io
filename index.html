<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pjpjsocute.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="My bolg">
<meta property="og:type" content="website">
<meta property="og:title" content="Rayâ€˜s Blog">
<meta property="og:url" content="http://pjpjsocute.github.io/index.html">
<meta property="og:site_name" content="Rayâ€˜s Blog">
<meta property="og:description" content="My bolg">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ray zhou">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://pjpjsocute.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Rayâ€˜s Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Rayâ€˜s Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>å…³äº</a>

  </li>
        <li class="menu-item menu-item-english">

    <a href="https://pjpjsocute.github.io/en/" rel="section"><i class="English fa-fw"></i>English</a>

  </li>
        <li class="menu-item menu-item-guestbook">

    <a href="/guestbook/" rel="section"><i class="ç•™è¨€æ¿ fa-fw"></i>ç•™è¨€æ¿</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2025/08/18/java_guide/java_guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/18/java_guide/java_guide/" class="post-title-link" itemprop="url">Java Backend Interview Guide</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2025-08-18 00:00:00" itemprop="dateCreated datePublished" datetime="2025-08-18T00:00:00+02:00">2025-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2025-08-20 00:00:00" itemprop="dateModified" datetime="2025-08-20T00:00:00+02:00">2025-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2025/08/18/java_guide/java_guide/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/08/18/java_guide/java_guide/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Java-Interview-Guide"><a href="#Java-Interview-Guide" class="headerlink" title="Java Interview Guide"></a>Java Interview Guide</h1><blockquote>
<p>è‡ªå·±åœ¨å‡†å¤‡æ¬§æ´²çš„é¢è¯•è¿‡ç¨‹å‘ç°ï¼Œå°½ç®¡æ¬§æ´²çš„é¢è¯•ç›¸å¯¹æ›´ç®€å•ï¼Œä½†æ˜¯ä»ç„¶ä¼šè¯¢é—®ä¸€äº›åŸºç¡€çš„å…«è‚¡æ–‡ï¼Œè€Œå›½å†…çš„é¢ç»è™½ç„¶æ›´å…¨é¢ï¼Œå¹¶ä¸”å¾€å¾€æ›´æ·±å±‚ï¼Œä½†æ˜¯å› ä¸ºæ˜¯ä¸­æ–‡çš„ï¼Œæ‰€ä»¥åœ¨è‡ªå·±å‡†å¤‡çš„æ—¶å€™è¿˜æ˜¯å¾ˆä¸æ–¹ä¾¿ï¼Œå¹¶ä¸”2è¾¹çš„é—®é¢˜ä¾§é‡ç‚¹è¿˜æ˜¯æœ‰æ‰€ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘å°è¯•å¯¹è‡ªå·±è¿‡å»å­¦ä¹ åˆ°çš„ä»¥åŠé¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜è¿›è¡Œæ•´ç†å’Œå½’çº³ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°å„ä½åœ¨å‡†å¤‡è¿›è¡Œè‹±æ–‡é¢è¯•çš„æœ‹å‹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶åœ¨é˜…è¯»è¿‡ç¨‹ä¸­ç»™å‡ºè‡ªå·±çš„é—®é¢˜æˆ–è€…ä¹Ÿæä¾›ä¸€äº›è‡ªå·±æ›¾ç»é‡åˆ°çš„é—®é¢˜ï¼Œç¥å¤§å®¶é¢è¯•å¥½è¿ã€‚</p>
</blockquote>
<hr>
<h2 id="ğŸ“š-Table-of-Contents"><a href="#ğŸ“š-Table-of-Contents" class="headerlink" title="ğŸ“š Table of Contents"></a>ğŸ“š Table of Contents</h2><ul>
<li><strong>Java (Basic, Collection, Multi-thread, JVM)</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/java.html">Read Â»</a></li>
<li><strong>Spring &amp; Spring Cloud</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE//spring.html">Read Â»</a></li>
<li><strong>Databases</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/database.html">Read Â»</a></li>
<li><strong>Computer Networks</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/etwork.html">Read Â»</a></li>
<li><strong>Operating System</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/os.html">Read Â»</a></li>
<li><strong>Redis</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/redis.html">Read Â»</a></li>
<li><strong>Message Queue</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/mq.html">Read Â»</a></li>
<li><strong>Distributed System</strong> â†’ <a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/ds.html">Read Â»</a></li>
</ul>
<hr>
<h2 id="ğŸŒ-Online-Reading"><a href="#ğŸŒ-Online-Reading" class="headerlink" title="ğŸŒ Online Reading"></a>ğŸŒ Online Reading</h2><p>This repository is published as a GitHub Pages site:<br><strong><a href="https://pjpjsocute.github.io/JAVA_INTERVIEW_GUIDE/">ğŸ“– Open Online Version</a></strong></p>
<ul>
<li>Best for mobile/tablet reading</li>
</ul>
<hr>
<h2 id="ğŸ“…-Future-Plans"><a href="#ğŸ“…-Future-Plans" class="headerlink" title="ğŸ“… Future Plans"></a>ğŸ“… Future Plans</h2><ul>
<li>Add <strong>Design Patterns</strong> section</li>
<li>Add <strong>Elasticsearch</strong> and related tools</li>
<li>Continuous content updates  </li>
<li>Feedback and suggestions are welcome! ğŸ™Œ</li>
</ul>
<hr>
<h2 id="ğŸ“„-License"><a href="#ğŸ“„-License" class="headerlink" title="ğŸ“„ License"></a>ğŸ“„ License</h2><p><a href="LICENSE">Apache-2.0 License</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/30/rpc/spring_rpc_III/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/30/rpc/spring_rpc_III/" class="post-title-link" itemprop="url">åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-30 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-30T00:00:00+02:00">2023-05-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/30/rpc/spring_rpc_III/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/30/rpc/spring_rpc_III/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸‰" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸‰)</h1><p><img src="/2023/05/30/rpc/spring_rpc_III/image-20230522163034434.png" alt="image-20230522163034434"></p>
<p>ç»§ç»­ä¸Šä¸€ç« ï¼Œåœ¨å®ç°äº†æœåŠ¡ç«¯æ³¨å†Œå’Œè°ƒç”¨ä¹‹åï¼Œéœ€è¦æ¥å®ç°å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼Œå…¶ä¸­ä¸»è¦åŒ…æ‹¬è´Ÿè½½å‡è¡¡ï¼Œé™æµï¼Œè¯·æ±‚å‘é€å’ŒæœåŠ¡å‘ç°ä¸Šã€‚æ¥ä¸‹æ¥å°†ä»ä¸€ä¸ªRPCè°ƒç”¨æµç¨‹çš„é¡ºåºæ¥å®ç°æ¥ä¸‹æ¥çš„åŠŸèƒ½</p>
<h3 id="ä¸€æ¬¡è¯·æ±‚ï¼š"><a href="#ä¸€æ¬¡è¯·æ±‚ï¼š" class="headerlink" title="ä¸€æ¬¡è¯·æ±‚ï¼š"></a>ä¸€æ¬¡è¯·æ±‚ï¼š</h3><p>â€‹            å®ç°å®¢æˆ·ç«¯ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦æƒ³æ¸…æ¥šä¸€æ¬¡è¯·æ±‚éœ€è¦å‘é€äº›ä»€ä¹ˆã€‚</p>
<p>â€‹             é¦–å…ˆï¼Œéœ€è¦å½“å‰çš„æœåŠ¡åæ–¹æ³•åï¼Œä»¥åŠå¯¹åº”çš„å‚æ•°å’Œå‚æ•°ç±»å‹ï¼Œå¦åˆ™æœåŠ¡ç«¯æ— æ³•æ ¹æ®è¯·æ±‚æ¥è¿›è¡Œå¯¹åº”çš„åå°„è°ƒç”¨ã€‚</p>
<p>â€‹            å…¶æ¬¡ï¼Œè¯·æ±‚ä¸­åº”è¯¥è¦å¸¦ä¸Š@RpcConsumerå†…çš„å‚æ•°ï¼Œè®©æœåŠ¡ç«¯èƒ½å¤Ÿæ‰¾åˆ°æ­£ç¡®çš„æœåŠ¡ã€‚</p>
<p>â€‹            æœ€åï¼Œè¯·æ±‚ä¸­åº”è¯¥å¸¦ä¸Šæœ¬æ¬¡è¯·æ±‚çš„ä¸€ä¸ªå”¯ä¸€å€¼ï¼Œä»¥æ–¹ä¾¿é“¾è·¯è¿½è¸ªã€‚</p>
<p>â€‹            è‡³æ­¤ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦çš„åŸºæœ¬å‚æ•°å·²ç»å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8509587559718339795L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * traceId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            traceId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * interface name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            serviceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            methodName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[]          parameters;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameter types</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[]        paramTypes;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            project;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String            group;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be</span></span><br><span class="line"><span class="comment">     * split to get the service name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getGroup() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getServiceName() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æœåŠ¡ä»£ç†"><a href="#æœåŠ¡ä»£ç†" class="headerlink" title="æœåŠ¡ä»£ç†"></a>æœåŠ¡ä»£ç†</h3><p>â€‹        ç¬¬ä¸€æ­¥ï¼Œåœ¨springå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œæ‰«ææ‰€æœ‰å¸¦æœ‰@RpcConsumer ä¸ºå…¶ç”Ÿæˆä»£ç†ï¼Œåç»­è°ƒç”¨åˆ°è¯¥ç±»æ–¹æ³•çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ä»£ç†çš„æ–¹æ³•ï¼Œå‘èµ·è¯·æ±‚ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter  sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = ExtensionLoader.getExtensionLoader(RpcSendingServiceAdapter.class)</span><br><span class="line">            .getExtension(RpcRequestSendingEnum.NETTY.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start process register service: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">        <span class="comment">// register service</span></span><br><span class="line">        <span class="keyword">if</span> (bean.getClass().isAnnotationPresent(RpcProvider.class)) &#123;</span><br><span class="line">            <span class="type">RpcProvider</span> <span class="variable">annotation</span> <span class="operator">=</span> bean.getClass().getAnnotation(RpcProvider.class);</span><br><span class="line">            <span class="comment">// build rpc service config</span></span><br><span class="line">            <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                .service(bean)</span><br><span class="line">                .project(annotation.project())</span><br><span class="line">                .version(annotation.version())</span><br><span class="line">                .group(annotation.group())</span><br><span class="line">                .build();</span><br><span class="line">            LogUtil.info(<span class="string">&quot;register service: &#123;&#125;&quot;</span>, serviceConfig);</span><br><span class="line">            adapter.registryService(serviceConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * proxy and injection of consumers</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        Class&lt;?&gt; toBeProcessedBean = bean.getClass();</span><br><span class="line">        Field[] declaredFields = toBeProcessedBean.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field declaredField : declaredFields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredField.isAnnotationPresent(RpcConsumer.class)) &#123;</span><br><span class="line">                <span class="type">RpcConsumer</span> <span class="variable">annotation</span> <span class="operator">=</span> declaredField.getAnnotation(RpcConsumer.class);</span><br><span class="line">                <span class="comment">// build rpc service config</span></span><br><span class="line">                <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                    .project(annotation.project())</span><br><span class="line">                    .version(annotation.version())</span><br><span class="line">                    .group(annotation.group())</span><br><span class="line">                    .build();</span><br><span class="line">                <span class="comment">// create the proxy bean Factory and the proxy bean</span></span><br><span class="line">                <span class="type">RpcServiceProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcServiceProxy</span>(sendingServiceAdapter, serviceConfig);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">rpcProxy</span> <span class="operator">=</span> proxy.getProxy(declaredField.getType());</span><br><span class="line">                declaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    LogUtil.info(<span class="string">&quot;create service proxy: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">                    declaredField.set(bean, rpcProxy);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å°±æ˜¯åœ¨ä»£ç†ç±»çš„invokeæ–¹æ³•ä¸­å®ç°å¯¹requestçš„æ‹¼è£…å’Œè°ƒç”¨ã€‚åŒæ—¶è·å–Futureä¸­çš„å“åº”å€¼è¿”å›ç»™è°ƒç”¨è€…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceProxy</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceConfig         config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcServiceProxy</span><span class="params">(RpcSendingServiceAdapter sendingServiceAdapter, RpcServiceConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = sendingServiceAdapter;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;invoked method: [&#123;&#125;]&quot;</span>, method.getName());</span><br><span class="line">        <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> buildRequest(method,args);</span><br><span class="line"></span><br><span class="line">        RpcResponse&lt;Object&gt; rpcResponse = <span class="literal">null</span>;</span><br><span class="line">        CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; completableFuture =</span><br><span class="line">            (CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt;)sendingServiceAdapter.sendRpcRequest(rpcRequest);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rpcResponse = completableFuture.get();</span><br><span class="line">            <span class="keyword">return</span> rpcResponse.getData();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the proxy object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getProxy</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T)Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123;clazz&#125;, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> RpcRequest <span class="title function_">buildRequest</span><span class="params">(Method method,Object[] args)</span>&#123;</span><br><span class="line">         <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> RpcRequest.builder()</span><br><span class="line">                 .methodName(method.getName())</span><br><span class="line">                 .parameters(args)</span><br><span class="line">                 .serviceName(method.getDeclaringClass().getName())</span><br><span class="line">                 .paramTypes(method.getParameterTypes())</span><br><span class="line">                 .traceId(UUID.randomUUID().toString())</span><br><span class="line">                 .project(config.getProject())</span><br><span class="line">                 .version(config.getVersion())</span><br><span class="line">                 .group(config.getGroup())</span><br><span class="line">                 .build();</span><br><span class="line">        <span class="keyword">return</span> rpcRequest;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å‘é€è¯·æ±‚ï¼š"><a href="#å‘é€è¯·æ±‚ï¼š" class="headerlink" title="å‘é€è¯·æ±‚ï¼š"></a>å‘é€è¯·æ±‚ï¼š</h3><p>â€‹        å®¢æˆ·ç«¯çš„æ ¸å¿ƒæ–¹æ³•ä¸ºå‘é€è¯·æ±‚ï¼Œè¯·æ±‚çš„å‘é€æœ‰å¤šç§æ–¹æ³•ï¼Œè¿™é‡Œä»…åŸºäºnettyçš„Nioè¿›è¡Œäº†å®ç°ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ—¶åºã€‚</p>
<p><img src="/2023/05/30/rpc/spring_rpc_III/WX20230530-145829@2x.png" alt="WX20230530-145829@2x"></p>
<p>â€‹        é¦–å…ˆå®ç°å‘é€æ–¹æ³•ï¼Œé‡Œé¢åº”è¯¥åŒ…å«å¯»æ‰¾åœ°å€ï¼Œå‘é€è¯·æ±‚çš„åŠŸèƒ½ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcSendingServiceAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcSendingServiceAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EventLoopGroup is a multithreaded event loop that handles I/O operation.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup             eventLoopGroup;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bootstrap helt setting and start netty client</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Bootstrap                  bootstrap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service discovery</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceFindingAdapter   findingAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Channel manager,mapping channel and address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AddressChannelManager      addressChannelManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Waiting process request queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitingProcessRequestQueue waitingProcessRequestQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcSendingServiceAdapterImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.findingAdapter = ExtensionLoader.getExtensionLoader(RpcServiceFindingAdapter.class)</span><br><span class="line">            .getExtension(ServiceDiscoveryEnum.ZK.getName());</span><br><span class="line">        <span class="built_in">this</span>.addressChannelManager = SingletonFactory.getInstance(AddressChannelManager.class);</span><br><span class="line">        <span class="built_in">this</span>.waitingProcessRequestQueue = SingletonFactory.getInstance(WaitingProcessRequestQueue.class);</span><br><span class="line">        <span class="comment">// initialize</span></span><br><span class="line">        eventLoopGroup = <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        bootstrap = <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">        bootstrap.group(eventLoopGroup)</span><br><span class="line">            .channel(NioSocketChannel.class)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">            <span class="comment">// The timeout period for the connection.</span></span><br><span class="line">            <span class="comment">// If this time is exceeded or if the connection cannot be</span></span><br><span class="line">            <span class="comment">// established, the connection fails.</span></span><br><span class="line">            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">5000</span>)</span><br><span class="line">            .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                    <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                    <span class="comment">// If no data is sent to the server within 15 seconds, a</span></span><br><span class="line">                    <span class="comment">// heartbeat request is sent</span></span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, TimeUnit.SECONDS));</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageEncoder</span>());</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageDecoder</span>());</span><br><span class="line">                    p.addLast(<span class="keyword">new</span> <span class="title class_">NettyRpcClientHandler</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">sendRpcRequest</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> findServiceAddress(rpcRequest);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> fetchAndConnectChannel(address);</span><br><span class="line">        <span class="keyword">if</span> (channel.isActive()) &#123;</span><br><span class="line">            addToProcessQueue(rpcRequest.getTraceId(), result);</span><br><span class="line">            <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> prepareRpcData(rpcRequest);</span><br><span class="line">            sendRpcData(channel, rpcData, result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Send request[&#123;&#125;] failed&quot;</span>, rpcRequest);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> InetSocketAddress <span class="title function_">findServiceAddress</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> findingAdapter.findServiceAddress(rpcRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToProcessQueue</span><span class="params">(String traceId, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">        waitingProcessRequestQueue.put(traceId, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">prepareRpcData</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">                .data(rpcRequest)</span><br><span class="line">                .serializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode())</span><br><span class="line">                .compressType(CompressTypeEnum.GZIP.getCode())</span><br><span class="line">                .messageType(RpcConstants.REQUEST_TYPE)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRpcData</span><span class="params">(Channel channel, RpcData rpcData, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">        channel.writeAndFlush(rpcData).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;client send message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                future.channel().close();</span><br><span class="line">                result.completeExceptionally(future.cause());</span><br><span class="line">                LogUtil.error(<span class="string">&quot;Send failed:&quot;</span>, future.cause());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel <span class="title function_">fetchAndConnectChannel</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(address);</span><br><span class="line">        <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// connect to service to get new address and rebuild the channel</span></span><br><span class="line">            channel = connect(address);</span><br><span class="line">            addressChannelManager.set(address, channel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Channel <span class="title function_">connect</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">        CompletableFuture&lt;Channel&gt; completableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">        bootstrap.connect(address).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                <span class="comment">// set channel to future</span></span><br><span class="line">                LogUtil.info(<span class="string">&quot;The client has connected [&#123;&#125;] successful!&quot;</span>, address.toString());</span><br><span class="line">                completableFuture.complete(future.channel());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LogUtil.error(<span class="string">&quot;The client failed to connect to the server [&#123;&#125;],future&quot;</span>, address.toString(), future);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel = completableFuture.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when connect to server:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Channel <span class="title function_">getChannel</span><span class="params">(InetSocketAddress inetSocketAddress)</span> &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(inetSocketAddress);</span><br><span class="line">        <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">            channel = connect(inetSocketAddress);</span><br><span class="line">            addressChannelManager.set(inetSocketAddress, channel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> channel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â€‹        åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ ¸å¿ƒçš„æ–¹æ³•æ˜¯sendRpcRequest,ä»–è´Ÿè´£è·å–æœåŠ¡ï¼Œåˆ›å»ºé“¾æ¥ï¼Œåˆ›å»ºä¸€ä¸ªFutureä»»åŠ¡ï¼Œå¹¶ä¸”å‘é€è¯·æ±‚ã€‚</p>
<h4 id="å‘ç°æœåŠ¡"><a href="#å‘ç°æœåŠ¡" class="headerlink" title="å‘ç°æœåŠ¡"></a>å‘ç°æœåŠ¡</h4><p>å‘ç°æœåŠ¡çš„æµç¨‹å¯ä»¥åŒ…æ‹¬ï¼š</p>
<p>1.ä»æ³¨å†Œä¸­å¿ƒä¸­æ‹‰å–æœåŠ¡åœ°å€åˆ—è¡¨</p>
<p>2.é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•è·å–æœåŠ¡å…·ä½“ç±»å‹ã€‚</p>
<h5 id="è·å–åœ°å€"><a href="#è·å–åœ°å€" class="headerlink" title="è·å–åœ°å€"></a>è·å–åœ°å€</h5><p>ä¸‹é¢å…ˆå®ç°ç¬¬ä¸€æ­¥ï¼ˆæ­¤å¤„å¯ä»¥ä½¿ç”¨ç¼“å­˜è¿›è¡Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œæœ¬é¡¹ç›®ä¸­çš„zkä½¿ç”¨äº†ä¸€ä¸ªConcurrentHashMapæ¥ä»£æ›¿ç¼“å­˜ï¼Œè¯¦ç»†ä»£ç å¯ä»¥è§CuratorClientï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceFindingAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcServiceFindingAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadBalanceService loadBalanceService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcServiceFindingAdapterImpl</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loadBalanceService = ExtensionLoader.getExtensionLoader(LoadBalanceService.class).getExtension(LOAD_BALANCE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InetSocketAddress <span class="title function_">findServiceAddress</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> rpcRequest.fetchRpcServiceName();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">zkClient</span> <span class="operator">=</span> CuratorClient.getZkClient();</span><br><span class="line">        List&lt;String&gt; serviceAddresseList = CuratorClient.getChildrenNodes(zkClient, serviceName);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(serviceAddresseList)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;no service available, serviceName: &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">service</span> <span class="operator">=</span> loadBalanceService.selectServiceAddress(serviceAddresseList, rpcRequest);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(service)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;no service available, serviceName: &quot;</span> + serviceName);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] socketAddressArray = service.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> socketAddressArray[<span class="number">0</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(socketAddressArray[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>è´Ÿè½½å‡è¡¡â€”â€”ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h5><h6 id="å®šä¹‰ï¼š"><a href="#å®šä¹‰ï¼š" class="headerlink" title="å®šä¹‰ï¼š"></a>å®šä¹‰ï¼š</h6><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯ä¸€ç§ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®åˆ†ç‰‡å’Œè´Ÿè½½å‡è¡¡çš„ç®—æ³•ã€‚å®ƒé€šè¿‡å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹å’Œå“ˆå¸Œç¯çš„æ¦‚å¿µï¼Œå®ç°äº†èŠ‚ç‚¹çš„åŠ¨æ€æ‰©ç¼©å®¹æ—¶æœ€å°åŒ–æ•°æ®è¿ç§»çš„éœ€æ±‚ï¼Œæé«˜äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚å®ƒåœ¨åˆ†å¸ƒå¼ç¼“å­˜ã€è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ä¸­è¢«å¹¿æ³›åº”ç”¨ã€‚</p>
<h6 id="å®ç°ï¼š"><a href="#å®ç°ï¼š" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h6><p>å“ˆå¸Œå€¼è®¡ç®—</p>
<p>é¦–å…ˆï¼Œæ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æˆ‘ä»¬éœ€è¦æœ‰æ ¹æ®å¯¹åº”çš„æœåŠ¡ç”Ÿæˆå“ˆå¸Œå€¼ã€‚åœ¨ä»¥ä¸‹å®ç°ä¸­ï¼Œé¦–å…ˆå°†è¾“å…¥é€šè¿‡SHA-256ç®—æ³•äº§ç”Ÿä¸€ä¸ª32å­—èŠ‚ï¼ˆ256ä½ï¼‰çš„å“ˆå¸Œå€¼</p>
<p>ä½†æ˜¯è¿™æ ·çš„å“ˆå¸Œå€¼è¿‡é•¿ï¼Œå¹¶ä¸æ–¹ä¾¿å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»–è¿›è¡Œç¼©çŸ­ã€‚åŒæ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ˜ å°„å¤šä¸ªå“ˆå¸Œå¯ä»¥æé«˜ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„åˆ†å¸ƒå‡åŒ€æ€§ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šåœ¨å“ˆå¸Œç©ºé—´ä¸­æ‹¥æœ‰å¤šä¸ªå“ˆå¸Œå€¼ï¼Œè¿™å¯ä»¥å¸®åŠ©å‡å°‘å› èŠ‚ç‚¹å¢åŠ æˆ–å‡å°‘è€Œå¯¼è‡´çš„å“ˆå¸Œç©ºé—´é‡åˆ†å¸ƒçš„å½±å“ã€‚</p>
<p>calculateHash ä¼šå¯¹å·²ç»å¾—åˆ°çš„256ä¸ºå“ˆå¸Œå€¼ä»èµ·ç‚¹jå¼€å§‹å‘åå–8å­—èŠ‚ç”Ÿæˆä¸€ä¸ªæ–°çš„Longç±»å‹çš„å“ˆå¸Œå€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">byte</span>[] md5Hash(String input) &#123;</span><br><span class="line">    <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        messageDigest = MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] hashBytes = messageDigest.digest(input.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        messageDigest.update(hashBytes);</span><br><span class="line">        <span class="keyword">return</span> messageDigest.digest();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;No such algorithm exception: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> Long <span class="title function_">calculateHash</span><span class="params">(<span class="type">byte</span>[] digest, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (digest.length &lt; (idx + <span class="number">1</span>) * <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Insufficient length of digest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 8 bytes digest,a byte is 8 bits like :1321 2432</span></span><br><span class="line">    <span class="comment">// each loop choose a byte to calculate hash,and shift i*8 bits</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        hash |= (<span class="number">255L</span> &amp; (<span class="type">long</span>)digest[i + idx * <span class="number">8</span>]) &lt;&lt; (<span class="number">8</span> * i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹é€‰æ‹©å™¨ã€‚</p>
<p>æ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„å®šä¹‰ï¼Œä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹é€‰æ‹©å™¨éœ€è¦å°†æœåŠ¡ç”Ÿæˆå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†æ¯ä¸ªèŠ‚ç‚¹æ˜ å°„ä¸ºå¤šä¸ªå“ˆå¸Œå€¼ï¼Œæœ€åæ ¹æ®ä¼ å…¥çš„å“ˆå¸Œå€¼è·å–æœ€è¿‘çš„èŠ‚ç‚¹è¿”å›ç»™è°ƒç”¨è€…ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span> &#123;</span><br><span class="line">        <span class="comment">// hash to virtual node list</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, String&gt; virtualInvokers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ConsistentHashLoadBalanceSelector</span><span class="params">(List&lt;String&gt; serviceUrlList, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.virtualInvokers = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// generate service address virtual node]</span></span><br><span class="line">            <span class="comment">// one address may map to multiple virtual nodes</span></span><br><span class="line">            <span class="comment">// use the md5 hash algorithm to generate the hash value of the</span></span><br><span class="line">            <span class="comment">// virtual node</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;init add serviceUrlList:&#123;&#125;&quot;</span>, serviceUrlList);</span><br><span class="line">            <span class="keyword">for</span> (String serviceNode : serviceUrlList) &#123;</span><br><span class="line">                addVirtualNode(serviceNode, virtualNodeNumber);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addVirtualNode</span><span class="params">(String serviceNode, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodeNumber / <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> serviceNode + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">byte</span>[] md5Hash = md5Hash(virtualNodeName);</span><br><span class="line">                <span class="comment">// md5Hash have 32 bytes</span></span><br><span class="line">                <span class="comment">// use 8 byte for each virtual node</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">hash</span> <span class="operator">=</span> calculateHash(md5Hash, j);</span><br><span class="line">                    virtualInvokers.put(hash, serviceNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">select</span><span class="params">(String rpcServiceKey)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] digest = md5Hash(rpcServiceKey);</span><br><span class="line">            <span class="comment">// use first 8 byte to get hash</span></span><br><span class="line">            <span class="keyword">return</span> selectForKey(calculateHash(digest, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">selectForKey</span><span class="params">(<span class="type">long</span> hashCode)</span> &#123;</span><br><span class="line">            Map.Entry&lt;Long, String&gt; entry = virtualInvokers.tailMap(hashCode, <span class="literal">true</span>).firstEntry();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">                entry = virtualInvokers.firstEntry();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°å®Œæ•´è´Ÿè½½å‡è¡¡æ–¹æ³•</p>
<p>å°†æ¥å£åå’Œå¯ç”¨æœåŠ¡åˆ—è¡¨çš„å“ˆå¸Œä½œä¸ºkeyï¼Œç¼“å­˜å¯¹åº”çš„ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©å™¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥ä»å·²æœ‰çš„å“ˆå¸Œé€‰æ‹©å™¨ä¸­è·å¾—ä¸€ä¸ªè´Ÿè½½èŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceService</span> <span class="keyword">implements</span> <span class="title class_">LoadBalanceService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ConsistentHashLoadBalanceSelector&gt; serviceToSelectorMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span> &#123;</span><br><span class="line">        <span class="comment">// hash to virtual node list</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> TreeMap&lt;Long, String&gt; virtualInvokers;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ConsistentHashLoadBalanceSelector</span><span class="params">(List&lt;String&gt; serviceUrlList, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.virtualInvokers = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// generate service address virtual node]</span></span><br><span class="line">            <span class="comment">// one address may map to multiple virtual nodes</span></span><br><span class="line">            <span class="comment">// use the md5 hash algorithm to generate the hash value of the</span></span><br><span class="line">            <span class="comment">// virtual node</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;init add serviceUrlList:&#123;&#125;&quot;</span>, serviceUrlList);</span><br><span class="line">            <span class="keyword">for</span> (String serviceNode : serviceUrlList) &#123;</span><br><span class="line">                addVirtualNode(serviceNode, virtualNodeNumber);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addVirtualNode</span><span class="params">(String serviceNode, <span class="type">int</span> virtualNodeNumber)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; virtualNodeNumber / <span class="number">8</span>; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">virtualNodeName</span> <span class="operator">=</span> serviceNode + <span class="string">&quot;#&quot;</span> + i;</span><br><span class="line">                <span class="type">byte</span>[] md5Hash = md5Hash(virtualNodeName);</span><br><span class="line">                <span class="comment">// md5Hash have 32 bytes</span></span><br><span class="line">                <span class="comment">// use 8 byte for each virtual node</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">4</span>; j++) &#123;</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">hash</span> <span class="operator">=</span> calculateHash(md5Hash, j);</span><br><span class="line">                    virtualInvokers.put(hash, serviceNode);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">select</span><span class="params">(String rpcServiceKey)</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] digest = md5Hash(rpcServiceKey);</span><br><span class="line">            <span class="comment">// use first 8 byte to get hash</span></span><br><span class="line">            <span class="keyword">return</span> selectForKey(calculateHash(digest, <span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">selectForKey</span><span class="params">(<span class="type">long</span> hashCode)</span> &#123;</span><br><span class="line">            Map.Entry&lt;Long, String&gt; entry = virtualInvokers.tailMap(hashCode, <span class="literal">true</span>).firstEntry();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (entry == <span class="literal">null</span>) &#123;</span><br><span class="line">                entry = virtualInvokers.firstEntry();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> entry.getValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="type">byte</span>[] md5Hash(String input) &#123;</span><br><span class="line">        <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            messageDigest = MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] hashBytes = messageDigest.digest(input.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            messageDigest.update(hashBytes);</span><br><span class="line">            <span class="keyword">return</span> messageDigest.digest();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;No such algorithm exception: &#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> Long <span class="title function_">calculateHash</span><span class="params">(<span class="type">byte</span>[] digest, <span class="type">int</span> idx)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (digest.length &lt; (idx + <span class="number">1</span>) * <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Insufficient length of digest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 8 bytes digest,a byte is 8 bits like :1321 2432</span></span><br><span class="line">        <span class="comment">// each loop choose a byte to calculate hash,and shift i*8 bits</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            hash |= (<span class="number">255L</span> &amp; (<span class="type">long</span>)digest[i + idx * <span class="number">8</span>]) &lt;&lt; (<span class="number">8</span> * i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Choose one from the list of existing service addresses list</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceUrlList Service address list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcRequest</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectServiceAddress</span><span class="params">(List&lt;String&gt; serviceUrlList, RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">serviceListHash</span> <span class="operator">=</span> System.identityHashCode(serviceUrlList);</span><br><span class="line">        <span class="type">String</span> <span class="variable">interfaceName</span> <span class="operator">=</span> rpcRequest.getServiceName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">selectorKey</span> <span class="operator">=</span> interfaceName + serviceListHash;</span><br><span class="line"></span><br><span class="line">        <span class="type">ConsistentHashLoadBalanceSelector</span> <span class="variable">consistentHashLoadBalanceSelector</span> <span class="operator">=</span> serviceToSelectorMap</span><br><span class="line">            .computeIfAbsent(selectorKey, key -&gt; <span class="keyword">new</span> <span class="title class_">ConsistentHashLoadBalanceSelector</span>(serviceUrlList, VIRTUAL_NODES));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> consistentHashLoadBalanceSelector.select(interfaceName + Arrays.stream(rpcRequest.getParameters()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å‘é€è¯·æ±‚"><a href="#å‘é€è¯·æ±‚" class="headerlink" title="å‘é€è¯·æ±‚"></a>å‘é€è¯·æ±‚</h4><h5 id="å‘é€è¯·æ±‚-1"><a href="#å‘é€è¯·æ±‚-1" class="headerlink" title="å‘é€è¯·æ±‚"></a>å‘é€è¯·æ±‚</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">sendRpcRequest</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">      CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">      <span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> findServiceAddress(rpcRequest);</span><br><span class="line">      <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> fetchAndConnectChannel(address);</span><br><span class="line">      <span class="keyword">if</span> (channel.isActive()) &#123;</span><br><span class="line">          addToProcessQueue(rpcRequest.getTraceId(), result);</span><br><span class="line">          <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> prepareRpcData(rpcRequest);</span><br><span class="line">          sendRpcData(channel, rpcData, result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.error(<span class="string">&quot;Send request[&#123;&#125;] failed&quot;</span>, rpcRequest);</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addToProcessQueue</span><span class="params">(String traceId, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">          waitingProcessRequestQueue.put(traceId, result);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> RpcData <span class="title function_">prepareRpcData</span><span class="params">(RpcRequest rpcRequest)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">              .data(rpcRequest)</span><br><span class="line">              .serializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode())</span><br><span class="line">              .compressType(CompressTypeEnum.GZIP.getCode())</span><br><span class="line">              .messageType(RpcConstants.REQUEST_TYPE)</span><br><span class="line">              .build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendRpcData</span><span class="params">(Channel channel, RpcData rpcData, CompletableFuture&lt;RpcResponse&lt;Object&gt;&gt; result)</span> &#123;</span><br><span class="line">      channel.writeAndFlush(rpcData).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">              LogUtil.info(<span class="string">&quot;client send message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              future.channel().close();</span><br><span class="line">              result.completeExceptionally(future.cause());</span><br><span class="line">              LogUtil.error(<span class="string">&quot;Send failed:&quot;</span>, future.cause());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h5 id="ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨"><a href="#ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨"></a>ä½¿ç”¨channelé“¾æ¥æœåŠ¡å™¨</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Channel <span class="title function_">fetchAndConnectChannel</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> addressChannelManager.get(address);</span><br><span class="line">    <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// connect to service to get new address and rebuild the channel</span></span><br><span class="line">        channel = connect(address);</span><br><span class="line">        addressChannelManager.set(address, channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Channel <span class="title function_">connect</span><span class="params">(InetSocketAddress address)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;Channel&gt; completableFuture = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>&lt;&gt;();</span><br><span class="line">    bootstrap.connect(address).addListener((ChannelFutureListener)future -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">            <span class="comment">// set channel to future</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;The client has connected [&#123;&#125;] successful!&quot;</span>, address.toString());</span><br><span class="line">            completableFuture.complete(future.channel());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;The client failed to connect to the server [&#123;&#125;],future&quot;</span>, address.toString(), future);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        channel = completableFuture.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;occur exception when connect to server:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> channel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†"><a href="#Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†" class="headerlink" title="Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†"></a>Consumerè¿›è¡Œè¿”å›å€¼å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapterImpl adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WaitingProcessRequestQueue   waitingProcessRequestQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyRpcClientHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcSendingServiceAdapterImpl.class);</span><br><span class="line">        <span class="built_in">this</span>.waitingProcessRequestQueue = SingletonFactory.getInstance(WaitingProcessRequestQueue.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * heart beat handle</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// if the channel is freeï¼Œclose it</span></span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="type">IdleState</span> <span class="variable">state</span> <span class="operator">=</span> ((IdleStateEvent)evt).state();</span><br><span class="line">            <span class="keyword">if</span> (state == IdleState.WRITER_IDLE) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;write idle happen [&#123;&#125;]&quot;</span>, ctx.channel().remoteAddress());</span><br><span class="line">                <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> adapter.getChannel((InetSocketAddress)ctx.channel().remoteAddress());</span><br><span class="line">                <span class="type">RpcData</span> <span class="variable">rpcData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">                rpcData.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">                rpcData.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">                rpcData.setMessageType(RpcConstants.HEARTBEAT_REQUEST_TYPE);</span><br><span class="line">                rpcData.setData(RpcConstants.PING);</span><br><span class="line">                channel.writeAndFlush(rpcData).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when an exception occurs in processing a client message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;server exceptionCaught&quot;</span>);</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Client receive message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">        setupRpcMessage(rpcMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcData.isHeartBeatResponse()) &#123;</span><br><span class="line">            LogUtil.info(<span class="string">&quot;heart [&#123;&#125;]&quot;</span>, rpcMessage.getData());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rpcData.isResponse()) &#123;</span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = (RpcResponse&lt;Object&gt;)rpcData.getData();</span><br><span class="line">            waitingProcessRequestQueue.complete(rpcResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupRpcMessage</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">        rpcMessage.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/22/rpc/spi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/22/rpc/spi/" class="post-title-link" itemprop="url">java spi åº”ç”¨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-22 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-22T00:00:00+02:00">2023-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-07-10 00:00:00" itemprop="dateModified" datetime="2023-07-10T00:00:00+02:00">2023-07-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/22/rpc/spi/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/22/rpc/spi/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="java-spi-åº”ç”¨"><a href="#java-spi-åº”ç”¨" class="headerlink" title="java spi åº”ç”¨"></a>java spi åº”ç”¨</h1><h2 id="Spi-å®šä¹‰"><a href="#Spi-å®šä¹‰" class="headerlink" title="Spi å®šä¹‰"></a>Spi å®šä¹‰</h2><p>åœ¨Javaä¸­ï¼ŒSPIä»£è¡¨Service Provider Interfaceï¼ˆæœåŠ¡æä¾›è€…æ¥å£ï¼‰ã€‚SPIæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå…è®¸åº”ç”¨ç¨‹åºé€šè¿‡åœ¨ç±»è·¯å¾„ä¸­å‘ç°å’ŒåŠ è½½å¯æ’æ‹”çš„ç»„ä»¶æˆ–æœåŠ¡æä¾›è€…æ¥æ‰©å±•å…¶åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€ç§æ¾è€¦åˆçš„æ–¹å¼ï¼Œå…è®¸å¼€å‘äººå‘˜ç¼–å†™å¯ä»¥ä¸å¤šä¸ªå®ç°è¿›è¡Œäº¤äº’çš„ä»£ç ï¼Œè€Œæ— éœ€æ˜¾å¼åœ°å¼•ç”¨ç‰¹å®šçš„å®ç°ç±»ã€‚</p>
<h2 id="Apiä¸SpiåŒºåˆ«"><a href="#Apiä¸SpiåŒºåˆ«" class="headerlink" title="Apiä¸SpiåŒºåˆ«"></a>Apiä¸SpiåŒºåˆ«</h2><p>APIæ˜¯ç”¨äºå®šä¹‰è½¯ä»¶ç»„ä»¶ä¹‹é—´çš„äº¤äº’è§„åˆ™å’Œçº¦å®šï¼Œè€ŒSPIæ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå®ç°å¯æ’æ‹”çš„ç»„ä»¶æˆ–æœåŠ¡çš„æ‰©å±•æ€§ã€‚</p>
<p>APIç”¨äºæš´éœ²åŠŸèƒ½å’ŒåŠŸèƒ½ï¼Œä¾›å…¶ä»–å¼€å‘äººå‘˜ä½¿ç”¨å’Œé›†æˆï¼Œè€ŒSPIç”¨äºåŠ¨æ€åŠ è½½å’Œä½¿ç”¨å¯æ›¿æ¢çš„ç»„ä»¶å®ç°ã€‚</p>
<p>APIæ˜¯é¢å‘å¼€å‘äººå‘˜çš„ï¼Œæä¾›äº†ç¼–ç¨‹æ¥å£å’Œæ–‡æ¡£ï¼Œä»¥ä¾¿æ­£ç¡®ä½¿ç”¨å’Œé›†æˆè½¯ä»¶ç»„ä»¶ã€‚SPIæ˜¯é¢å‘å¼€å‘äººå‘˜å’Œæ¡†æ¶/åº”ç”¨ç¨‹åºçš„ï¼Œç”¨äºæ‰©å±•æ¡†æ¶æˆ–åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚</p>
<p>APIæ˜¯è¢«è°ƒç”¨æ–¹å®šä¹‰çš„ï¼Œå®ƒè§„å®šäº†è°ƒç”¨æ–¹å¼å’Œå‚æ•°ã€‚SPIæ˜¯è°ƒç”¨æ–¹å®šä¹‰çš„ï¼Œå®ƒå…è®¸è¢«è°ƒç”¨æ–¹æä¾›å®ç°ã€‚</p>
<h2 id="Spiæœºåˆ¶"><a href="#Spiæœºåˆ¶" class="headerlink" title="Spiæœºåˆ¶"></a>Spiæœºåˆ¶</h2><p><img src="/2023/05/22/rpc/spi/WX20230605-150555@2x.png" alt="WX20230605-150555@2x"></p>
<h2 id="å®ç°è¿‡ç¨‹"><a href="#å®ç°è¿‡ç¨‹" class="headerlink" title="å®ç°è¿‡ç¨‹"></a>å®ç°è¿‡ç¨‹</h2><p><img src="/2023/05/22/rpc/spi/WX20230605-151041@2x.png" alt="WX20230605-151041@2x"></p>
<h2 id="åœ¨Rpcä¸­çš„å®ç°"><a href="#åœ¨Rpcä¸­çš„å®ç°" class="headerlink" title="åœ¨Rpcä¸­çš„å®ç°"></a>åœ¨Rpcä¸­çš„å®ç°</h2><p>â€‹    åœ¨<a target="_blank" rel="noopener" href="https://github.com/pjpjsocute/rpc-service">ç®€å•çš„RPCæ¡†æ¶å®ç°</a>ä¸­åŸºäºDubboå®ç°äº†ä¸€ä¸ªåŸºäºæ³¨è§£çš„SPIæœºåˆ¶ï¼Œè¿™é‡Œå°†ç®€å•ä»‹ç»ä¸‹åŸç†ã€‚</p>
<h3 id="å®ç°ï¼š"><a href="#å®ç°ï¼š" class="headerlink" title="å®ç°ï¼š"></a>å®ç°ï¼š</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>å®šä¹‰ä¸€ä¸ªSPIæ³¨è§£ï¼Œç”¨äºæ ‡æ³¨æ‰€æœ‰éœ€è¦è¿›è¡ŒSPIæ³¨å†Œçš„æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶æ¬¡ï¼Œç”±äºä¸ºäº†é˜²æ­¢å¹¶å‘å†²çªé—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨åŒ…è£…ç±»å¯¹å®ä¾‹æ¥å£è¿›è¡ŒåŒ…è£…ï¼Œç”¨äºä¿è¯å¤šçº¿ç¨‹è¿‡ç¨‹ä¸­çš„æ•°æ®å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Holder</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> T value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>holderå¯ä»¥ä½œä¸ºä¸€ä¸ªé”å¯¹è±¡ä¿è¯å®‰å…¨ã€‚</p>
<p>å‚è€ƒspring spi ,extensionçš„é…ç½®æ–‡ä»¶å®šä¹‰ä¸ºä»¥ä¸‹æ ¼å¼key = â€˜full pathâ€™,å¦‚zk=org.example.ray.infrastructure.adapter.impl.RpcServiceFindingAdapterImpl</p>
<p>è¿™æ ·å¯ä»¥æ–¹ä¾¿åœ¨ç³»ç»Ÿå†…é€šè¿‡keyåˆ›å»ºè·å–å’Œè°ƒç”¨</p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>ä¸ºäº†èƒ½å¤Ÿé¿å…é‡å¤åŠ è½½åˆ›å»ºçš„é—®é¢˜ï¼Œä½¿ç”¨mapä½œä¸ºç¼“å­˜ã€‚åŒæ—¶ä¸ºäº†æé«˜è·å–çš„æ•ˆç‡ï¼Œé’ˆå¯¹ä¸åŒæœåŠ¡çš„æœåŠ¡ï¼Œä¼šæœ‰ä¸åŒçš„æ‹“å±•å®ä¾‹ï¼Œç¼“å­˜ä¸åŒæœåŠ¡ä¸‹çš„å®ä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ExtensionLoader</span>&lt;T&gt; &#123;</span><br><span class="line">		<span class="comment">//extention path</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span>                            <span class="variable">SERVICE_DIRECTORY</span>   <span class="operator">=</span> <span class="string">&quot;META-INF/extension/&quot;</span>;</span><br><span class="line">  	<span class="comment">//save extentionloader for load different class</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS   = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  	<span class="comment">//save all instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt;             EXTENSION_INSTANCES = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt;                                 type;</span><br><span class="line">  	<span class="comment">//save different service hold instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Holder&lt;Object&gt;&gt;              cachedInstances     = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">  	<span class="comment">//save different instance</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;            cachedClasses       = <span class="keyword">new</span> <span class="title class_">Holder</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p>å®ç°è·å–classloaderå’ŒgetExtensionæ–¹æ³•</p>
<p><img src="/2023/05/22/rpc/spi/WX20230605-170936@2x.png" alt="WX20230605-170936@2x"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_II/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/22/rpc/spring_rpc_II/" class="post-title-link" itemprop="url">åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-22 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-22T00:00:00+02:00">2023-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-05-30 00:00:00" itemprop="dateModified" datetime="2023-05-30T00:00:00+02:00">2023-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/22/rpc/spring_rpc_II/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/22/rpc/spring_rpc_II/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-äºŒ" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(äºŒ)</h1><p><img src="/2023/05/22/rpc/spring_rpc_II/image-20230522163034434.png" alt="image-20230522163034434"></p>
<p>ç»§ç»­ä¸Šä¸€ç« ï¼Œå®ç°äº†æœåŠ¡æ³¨å†Œåéœ€è¦å®ç°æœåŠ¡è°ƒç”¨ã€‚</p>
<h3 id="æœåŠ¡æ‰§è¡Œ"><a href="#æœåŠ¡æ‰§è¡Œ" class="headerlink" title="æœåŠ¡æ‰§è¡Œ"></a>æœåŠ¡æ‰§è¡Œ</h3><p>ä¸€ä¸ªRPCçš„æœåŠ¡è°ƒç”¨åº”è¯¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<p>è¯·æ±‚ç›‘å¬ï¼›</p>
<p>è§£ç è¯·æ±‚ï¼›</p>
<p>æ–¹æ³•è°ƒç”¨ï¼›</p>
<p>è¿”å›ç»“æœï¼›</p>
<p>æ¥ä¸‹æ¥å°†ä¾æ¬¡å®ç°ä»¥ä¸ŠåŠŸèƒ½ï¼›</p>
<h4 id="è¯·æ±‚ç›‘å¬"><a href="#è¯·æ±‚ç›‘å¬" class="headerlink" title="è¯·æ±‚ç›‘å¬"></a>è¯·æ±‚ç›‘å¬</h4><p>éœ€è¦å®šä¹‰ä¸€ä¸ªRpcRequestè¯·æ±‚ç±»ï¼Œç”±äºåç»­å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8509587559718339795L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * traceId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String traceId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * interface name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String serviceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * method name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameters</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[] parameters;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * parameter types</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt;[] paramTypes;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String project;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be split to get the service name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() +<span class="string">&quot;*&quot;</span>+<span class="built_in">this</span>.getGroup()+<span class="string">&quot;*&quot;</span>+ <span class="built_in">this</span>.getServiceName() +<span class="string">&quot;*&quot;</span>+ <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›‘å¬è¯·æ±‚éœ€è¦å¯åŠ¨ä¸€ä¸ªnetty serverï¼Œç”¨äºç›‘å¬è¯·æ±‚serviceçš„æœåŠ¡ã€‚</p>
<p>å¯åŠ¨æ—¶é¦–å…ˆéœ€è¦å…³é—­ä¹‹å‰æ³¨å†Œçš„æœåŠ¡ç­‰èµ„æºã€‚</p>
<p>éšåå¯¹nettyéœ€è¦çš„èµ„æºè¿›è¡Œä¾æ¬¡åˆå§‹åŒ–ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€æ®µnettyçš„å¯åŠ¨ä»£ç ï¼Œå…¶ä¸­éœ€è¦åŠ å…¥ç¼–ç å’Œè§£ç å™¨ç”¨äºåè®®è§£æï¼Œæ¢æ´»ã€‚</p>
<p>åŒæ—¶ï¼Œéœ€è¦åŠ å…¥é™æµå’Œè§£ç åçš„è¯·æ±‚å¤„ç†hanlder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyServer</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server init&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ServerShutdownHook.getInstance().registerShutdownHook();</span><br><span class="line"></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">listenerGroup</span> <span class="operator">=</span> initListenerGroup();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> initWorkerGroup();</span><br><span class="line">        <span class="type">DefaultEventExecutorGroup</span> <span class="variable">businessGroup</span> <span class="operator">=</span> initBusinessGroup();</span><br><span class="line"></span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server start&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> configureServerBootstrap(listenerGroup, workerGroup, businessGroup);</span><br><span class="line">            bindAndListen(serverBootstrap);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when start server:&quot;</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            shutdown(listenerGroup, workerGroup, businessGroup);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup <span class="title function_">initListenerGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EventLoopGroup <span class="title function_">initWorkerGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultEventExecutorGroup <span class="title function_">initBusinessGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultEventExecutorGroup</span>(</span><br><span class="line">                Runtime.getRuntime().availableProcessors() * <span class="number">2</span>,</span><br><span class="line">                ThreadPoolFactoryUtil.createThreadFactory(<span class="string">&quot;netty-server-business-group&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerBootstrap <span class="title function_">configureServerBootstrap</span><span class="params">(EventLoopGroup listenerGroup, EventLoopGroup workerGroup, DefaultEventExecutorGroup businessGroup)</span> &#123;</span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        serverBootstrap.group(listenerGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="literal">true</span>)</span><br><span class="line">                .childOption(ChannelOption.TCP_NODELAY, <span class="literal">true</span>)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">IdleStateHandler</span>(<span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, TimeUnit.SECONDS));</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageEncoder</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">RpcMessageDecoder</span>());</span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">DefaultTrafficBlockHandler</span>());</span><br><span class="line">                        pipeline.addLast(businessGroup, <span class="keyword">new</span> <span class="title class_">NettyRpcServerHandler</span>());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> serverBootstrap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindAndListen</span><span class="params">(ServerBootstrap serverBootstrap)</span> <span class="keyword">throws</span> UnknownHostException, InterruptedException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;netty server bind port:&#123;&#125; &quot;</span> , PropertiesFileUtil.readPortFromProperties());</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> serverBootstrap.bind(host, PropertiesFileUtil.readPortFromProperties()).sync();</span><br><span class="line">        f.channel().closeFuture().sync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">(EventLoopGroup listenerGroup, EventLoopGroup workerGroup, DefaultEventExecutorGroup businessGroup)</span> &#123;</span><br><span class="line">        listenerGroup.shutdownGracefully();</span><br><span class="line">        workerGroup.shutdownGracefully();</span><br><span class="line">        businessGroup.shutdownGracefully();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor(access = AccessLevel.PRIVATE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerShutdownHook</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ServerShutdownHook</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerShutdownHook</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServerShutdownHook <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register shut down hook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerShutdownHook</span><span class="params">()</span> &#123;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œæ¸…ç†æ“ä½œ</span></span><br><span class="line">            clearAll();</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">clearAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ¸…ç†æ³¨å†Œè¡¨</span></span><br><span class="line">            <span class="type">InetSocketAddress</span> <span class="variable">inetSocketAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(InetAddress.getLocalHost().getHostAddress(), PropertiesFileUtil.readPortFromProperties());</span><br><span class="line">            CuratorClient.clearRegistry(CuratorClient.getZkClient(), inetSocketAddress);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        ThreadPoolFactoryUtil.shutDownAllThreadPool();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“åˆApplicationRunnerï¼Œå®ç°serverçš„è‡ªåŠ¨å¯åŠ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServerRunner</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NettyServer nettyServer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyServerRunner</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        nettyServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h4><p>æœ¬é¡¹ç›®é»˜è®¤åªæ˜¯å®ç°äº†hessençš„åºåˆ—åŒ–å’ŒgzipåŠ è§£å‹ï¼Œè¿™éƒ¨åˆ†æœ‰è®¸å¤šçš„æ•™ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä»‹ç»ã€‚å…·ä½“çš„ä»£ç å¯ä»¥åœ¨æºç çš„org.example.ray.infrastructure.serializeåŒ…å’Œorg.example.ray.infrastructure.compressåŒ…ä¸­æ‰¾åˆ°</p>
<h4 id="ç¼–ç ä¸åè®®"><a href="#ç¼–ç ä¸åè®®" class="headerlink" title="ç¼–ç ä¸åè®®"></a>ç¼–ç ä¸åè®®</h4><p>å®ç°äº†æœåŠ¡åï¼Œæˆ‘ä»¬éœ€è¦ä¾æ¬¡ä¸ºä»–è¡¥å……ç¼–ç å’Œå¤„ç†ç±»ã€‚</p>
<p>åœ¨å®ç°ç¼–ç çš„æœåŠ¡ä¹‹å‰ï¼Œé¦–å…ˆåº”è¯¥ç¡®å®šåº•å±‚çš„ç¼–ç åè®®ã€‚</p>
<h5 id="åè®®"><a href="#åè®®" class="headerlink" title="åè®®"></a>åè®®</h5><p>æœ¬é¡¹ç›®å‚è€ƒä¸€äº›å·²æœ‰çš„åè®®è®¾è®¡ï¼Œé€‰æ‹©äº†ä¸€ç§æ¯”è¾ƒç®€å•çš„åè®®è®¾è®¡æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="/2023/05/22/rpc/spring_rpc_II/image-20230522174913202.png" alt="image-20230522174913202"></p>
<p>åè®®ç”±ä¸€ä¸ª16byteçš„headerå’Œbodyç»„æˆã€‚</p>
<p>å…¶ä¸­0-4æ˜¯magic codeï¼Œç”¨äºæ ¡éªŒ</p>
<p>4-5ä¸ºè‡ªå®šä¹‰çš„åè®®ç‰ˆæœ¬</p>
<p>5-8æ˜¯æ•´ä¸ªmessageçš„é•¿åº¦ï¼Œç”¨äºè§£ç </p>
<p>8-9å®šä¹‰äº†æ¶ˆæ¯ç±»å‹ï¼ŒåŒ…æ‹¬è¯·æ±‚ï¼Œå“åº”ï¼Œå¿ƒè·³è¯·æ±‚ï¼Œå¿ƒè·³å“åº”ã€‚</p>
<p>10ä¸ºç¼–ç æ–¹å¼</p>
<p>11ä¸ºå‹ç¼©æ–¹å¼</p>
<p>12-16ä¸ºä¸€ä¸ªæ•´å‹ï¼Œä¸ºè¯·æ±‚çš„ç¼–å·</p>
<p>Java pojoå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcData</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rpc message type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   messageType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * serialization type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   serializeMethodCodec;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * compress type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>   compressType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>    requestId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHeatBeatRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.HEARTBEAT_REQUEST_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canSendRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType != RpcConstants.HEARTBEAT_REQUEST_TYPE</span><br><span class="line">            &amp;&amp; messageType != RpcConstants.HEARTBEAT_RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHeartBeatResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.HEARTBEAT_RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType == RpcConstants.RESPONSE_TYPE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨äº†è§£äº†åè®®ä¹‹åï¼Œå®ç°è§£ç </p>
<h5 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h5><p>LengthFieldBasedFrameDecoderè§£ç å™¨å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« </p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://zhuanlan.zhihu.com/p/95621344&quot;</span><br></pre></td></tr></table></figure>
<p>åœ¨äº†è§£LengthFieldBasedFrameDecoderè§£ç å™¨çš„åŸºç¡€ä¸Šï¼Œè§£ç çš„è¿‡ç¨‹å…¶å®å¹¶ä¸å¤æ‚ã€‚ä¸»è¦æ˜¯è§£ç headerï¼Œæ ¡éªŒï¼Œå’Œè§£ç body3éƒ¨åˆ†ï¼Œå…·ä½“å®ç°å¯ä»¥å‚è€ƒä»£ç å’Œæ³¨é‡Šã€‚</p>
<p>è§£ç éƒ¨åˆ†ä½¿ç”¨java spiï¼Œå¯ä»¥å®šåˆ¶é€‰æ‹©ååºåˆ—åŒ–å’Œè§£å‹æ–¹æ³•ï¼Œæ­¤éƒ¨åˆ†å¯ä»¥å‚è€ƒgithubä¸­çš„ä»£ç ï¼Œæˆ–è€…å¯ä»¥åªä½¿ç”¨å›ºå®šåºåˆ—åŒ–å’Œè§£å‹æ–¹æ³•æ›¿ä»£spiéƒ¨åˆ†ã€‚</p>
<p>æœ¬é¡¹ç›®é»˜è®¤åªæ˜¯å®ç°äº†hessençš„åºåˆ—åŒ–å’ŒgzipåŠ è§£å‹ï¼Œè¿™éƒ¨åˆ†æœ‰è®¸å¤šçš„æ•™ç¨‹ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä»‹ç»ã€‚å…·ä½“çš„ä»£ç å¯ä»¥åœ¨æºç çš„org.example.ray.infrastructure.serializeåŒ…å’Œorg.example.ray.infrastructure.compressåŒ…ä¸­æ‰¾åˆ°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcMessageDecoder</span> <span class="keyword">extends</span> <span class="title class_">LengthFieldBasedFrameDecoder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcMessageDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// lengthFieldOffset: magic code is 4B, and version is 1B, and then full</span></span><br><span class="line">        <span class="comment">// length. so value is 5</span></span><br><span class="line">        <span class="comment">// lengthFieldLength: full length is 4B. so value is 4</span></span><br><span class="line">        <span class="comment">// lengthAdjustment: full length include all data and read 9 bytes</span></span><br><span class="line">        <span class="comment">// before, so the left length is (fullLength-9). so values is -9</span></span><br><span class="line">        <span class="comment">// initialBytesToStrip: we will check magic code and version manually,</span></span><br><span class="line">        <span class="comment">// so do not strip any bytes. so values is 0</span></span><br><span class="line">        <span class="built_in">this</span>(<span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">5</span>, <span class="number">4</span>, -<span class="number">9</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcMessageDecoder</span><span class="params">(<span class="type">int</span> maxFrameLength, <span class="type">int</span> lengthFieldOffset, <span class="type">int</span> lengthFieldLength, <span class="type">int</span> lengthAdjustment,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> initialBytesToStrip)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(maxFrameLength, lengthFieldOffset, lengthFieldLength, lengthAdjustment, initialBytesToStrip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// get the bytebuf which contains the frame</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">decode</span> <span class="operator">=</span> <span class="built_in">super</span>.decode(ctx, in);</span><br><span class="line">        <span class="keyword">if</span> (decode <span class="keyword">instanceof</span> ByteBuf) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> (ByteBuf)decode;</span><br><span class="line">            <span class="comment">// if data not empty, decode it</span></span><br><span class="line">            <span class="keyword">if</span> (byteBuf.readableBytes() &gt;= RpcConstants.HEAD_LENGTH) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> decode(byteBuf);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LogUtil.error(<span class="string">&quot;Decode error:&#123;&#125; ,input:&#123;&#125;&quot;</span>, e, byteBuf);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    byteBuf.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * read byte array from byteBuf</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteBuf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">decode</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode&quot;</span>);</span><br><span class="line">        checkMagicCode(byteBuf);</span><br><span class="line">        checkVersion(byteBuf);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> byteBuf.readInt();</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> decodeRpcMessage(byteBuf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.isHeatBeatRequest()) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleHeatBeatRequest(rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.isHeartBeatResponse()) &#123;</span><br><span class="line">            <span class="keyword">return</span> handleHeartBeatResponse(rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handleNormalRequest(rpcMessage, byteBuf, fullLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">decodeRpcMessage</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode RpcMessage data&quot;</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">messageType</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">codec</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">compress</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">traceId</span> <span class="operator">=</span> byteBuf.readInt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RpcData.builder()</span><br><span class="line">                .serializeMethodCodec(codec)</span><br><span class="line">                .traceId(traceId)</span><br><span class="line">                .compressType(compress)</span><br><span class="line">                .messageType(messageType)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">handleHeatBeatRequest</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setData(RpcConstants.PING);</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">handleHeartBeatResponse</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setData(RpcConstants.PONG);</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">handleNormalRequest</span><span class="params">(RpcData rpcMessage, ByteBuf byteBuf, <span class="type">int</span> fullLength)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bodyLength</span> <span class="operator">=</span> fullLength - RpcConstants.HEAD_LENGTH;</span><br><span class="line">        <span class="keyword">if</span> (bodyLength &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> rpcMessage;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> decodeBody(rpcMessage, byteBuf, bodyLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RpcData <span class="title function_">decodeBody</span><span class="params">(RpcData rpcMessage, ByteBuf byteBuf, Integer bodyLength)</span> &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start decode body&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bodyBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[bodyLength];</span><br><span class="line">        byteBuf.readBytes(bodyBytes);</span><br><span class="line">        <span class="comment">// decompose</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">compressName</span> <span class="operator">=</span> CompressTypeEnum.getName(rpcMessage.getCompressType());</span><br><span class="line">        <span class="type">CompressService</span> <span class="variable">extension</span> <span class="operator">=</span></span><br><span class="line">            ExtensionLoader.getExtensionLoader(CompressService.class).getExtension(compressName);</span><br><span class="line">        bodyBytes = extension.decompress(bodyBytes);</span><br><span class="line">        <span class="comment">// deserialize</span></span><br><span class="line">        <span class="keyword">if</span> (rpcMessage.getMessageType() == RpcConstants.REQUEST_TYPE) &#123;</span><br><span class="line">            <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                .getExtension(SerializationTypeEnum.getName(rpcMessage.getSerializeMethodCodec()))</span><br><span class="line">                .deserialize(bodyBytes, RpcRequest.class);</span><br><span class="line">            rpcMessage.setData(rpcRequest);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">RpcResponse</span> <span class="variable">rpcResponse</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                .getExtension(SerializationTypeEnum.getName(rpcMessage.getSerializeMethodCodec()))</span><br><span class="line">                .deserialize(bodyBytes, RpcResponse.class);</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rpcMessage;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkVersion</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">version</span> <span class="operator">=</span> byteBuf.readByte();</span><br><span class="line">        <span class="keyword">if</span> (version != RpcConstants.VERSION) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;version is not compatible: &quot;</span> + version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkMagicCode</span><span class="params">(ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> RpcConstants.MAGIC_NUMBER.length;</span><br><span class="line">        <span class="type">byte</span>[] magicNumber = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        byteBuf.readBytes(magicNumber);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (magicNumber[i] != RpcConstants.MAGIC_NUMBER[i]) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unknown magic code: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(magicNumber));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h5><p>ç¼–ç çš„è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯æ ¹æ®åè®®ï¼Œä¾æ¬¡å°†å¯¹åº”ä½çš„æ•°æ®å†™å…¥å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcMessageEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;RpcData&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ATOMIC_INTEGER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, RpcData rpcData, ByteBuf byteBuf)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//encode head,marked full length index</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">fullLengthIndex</span> <span class="operator">=</span> encodeHead(rpcData,byteBuf);</span><br><span class="line">            <span class="comment">// encode body</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> encodeBody(rpcData, byteBuf);</span><br><span class="line">            <span class="comment">// back fill full length</span></span><br><span class="line">            encodeLength(fullLengthIndex,fullLength,byteBuf);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;Encode request error:&#123;&#125;,data:&#123;&#125;&quot;</span>, e, rpcData);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.REQUEST_ENCODE_FAIL.getCode(),</span><br><span class="line">                RpcErrorMessageEnum.REQUEST_ENCODE_FAIL.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">encodeHead</span><span class="params">(RpcData rpcData,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="comment">// write magic code and version 0-5</span></span><br><span class="line">        byteBuf.writeBytes(RpcConstants.MAGIC_NUMBER);</span><br><span class="line">        byteBuf.writeByte(RpcConstants.VERSION);</span><br><span class="line">        <span class="comment">// marked full length index.</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLengthIndex</span> <span class="operator">=</span> byteBuf.writerIndex();</span><br><span class="line">        <span class="comment">// write placeholder for full length 9+</span></span><br><span class="line">        byteBuf.writerIndex(byteBuf.writerIndex() + <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// write message type</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getMessageType());</span><br><span class="line">        <span class="comment">// write codec</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getSerializeMethodCodec());</span><br><span class="line">        <span class="comment">// write compress</span></span><br><span class="line">        byteBuf.writeByte(rpcData.getCompressType());</span><br><span class="line">        <span class="comment">// write requestId</span></span><br><span class="line">        byteBuf.writeInt(ATOMIC_INTEGER.getAndIncrement());</span><br><span class="line">        <span class="keyword">return</span> fullLengthIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">encodeBody</span><span class="params">(RpcData rpcData,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] bodyBytes = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">fullLength</span> <span class="operator">=</span> RpcConstants.HEAD_LENGTH;</span><br><span class="line">        <span class="keyword">if</span> (rpcData.canSendRequest()) &#123;</span><br><span class="line">            LogUtil.info(<span class="string">&quot;serialize request start&quot;</span>);</span><br><span class="line">            bodyBytes = ExtensionLoader.getExtensionLoader(SerializationService.class)</span><br><span class="line">                    .getExtension(SerializationTypeEnum.getName(rpcData.getSerializeMethodCodec()))</span><br><span class="line">                    .serialize(rpcData.getData());</span><br><span class="line">            LogUtil.info(<span class="string">&quot;serialize request end&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">compressName</span> <span class="operator">=</span> CompressTypeEnum.getName(rpcData.getCompressType());</span><br><span class="line">            <span class="type">CompressService</span> <span class="variable">extension</span> <span class="operator">=</span></span><br><span class="line">                    ExtensionLoader.getExtensionLoader(CompressService.class).getExtension(compressName);</span><br><span class="line">            bodyBytes = extension.compress(bodyBytes);</span><br><span class="line">            fullLength += bodyBytes.length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bodyBytes != <span class="literal">null</span>) &#123;</span><br><span class="line">            byteBuf.writeBytes(bodyBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fullLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">encodeLength</span><span class="params">(<span class="type">int</span> fullLengthIndex,<span class="type">int</span> fullLength,ByteBuf byteBuf)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">writeIndex</span> <span class="operator">=</span> byteBuf.writerIndex();</span><br><span class="line">        byteBuf.writerIndex(fullLengthIndex);</span><br><span class="line">        byteBuf.writeInt(fullLength);</span><br><span class="line">        byteBuf.writerIndex(writeIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¯·æ±‚å¤„ç†å’Œè°ƒç”¨"><a href="#è¯·æ±‚å¤„ç†å’Œè°ƒç”¨" class="headerlink" title="è¯·æ±‚å¤„ç†å’Œè°ƒç”¨"></a>è¯·æ±‚å¤„ç†å’Œè°ƒç”¨</h4><p>è¿™é‡Œå®ç”¨nettyçš„SimpleChannelInboundHandlerï¼Œå¯ä»¥é¿å…èµ„æºé‡Šæ”¾çš„é—®é¢˜</p>
<p>ç”±äºå‰é¢å·²ç»å®ç°äº†è§£ç ï¼Œæ‰€ä»¥åªéœ€è¦é’ˆå¯¹ä¸åŒçš„è¯·æ±‚ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†å³å¯ã€‚</p>
<p>å¦‚æœæ˜¯å¿ƒè·³è¯·æ±‚ï¼Œåˆ™è¿”å›å¿ƒè·³å“åº”</p>
<p>å¦‚æœæ˜¯æœåŠ¡è¯·æ±‚ï¼Œåˆ™é€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨æœåŠ¡ï¼Œå¹¶å†™å…¥ç»“æœè¿”å›ç»™æ¶ˆè´¹è€…ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªå“åº”ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcResponse</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">347966260947189201L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * request id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            requestId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer           code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String            message;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * response body</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T                 data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * success</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RpcResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T data, String requestId)</span> &#123;</span><br><span class="line">        RpcResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RpcResponse</span>&lt;&gt;();</span><br><span class="line">        response.setCode(RpcResponseCodeEnum.SUCCESS.getCode());</span><br><span class="line">        response.setMessage(RpcResponseCodeEnum.SUCCESS.getMessage());</span><br><span class="line">        response.setRequestId(requestId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != data) &#123;</span><br><span class="line">            response.setData(data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fail</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RpcResponse&lt;T&gt; <span class="title function_">fail</span><span class="params">()</span> &#123;</span><br><span class="line">        RpcResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RpcResponse</span>&lt;&gt;();</span><br><span class="line">        response.setCode(RpcResponseCodeEnum.FAIL.getCode());</span><br><span class="line">        response.setMessage(RpcResponseCodeEnum.FAIL.getMessage());</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>serverhandlerçš„æ ¸å¿ƒæ–¹æ³•ä¸ºchannelRead0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyRpcServerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;RpcData&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Read the message transmitted by the server</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcRequestHandler rpcRequestHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NettyRpcServerHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rpcRequestHandler = SingletonFactory.getInstance(RpcRequestHandler.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * heart beat handle</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// if the channel is freeï¼Œclose it</span></span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="type">IdleState</span> <span class="variable">state</span> <span class="operator">=</span> ((IdleStateEvent)evt).state();</span><br><span class="line">            <span class="keyword">if</span> (state == IdleState.READER_IDLE) &#123;</span><br><span class="line">                LogUtil.info(<span class="string">&quot;idle check happen, so close the connection&quot;</span>);</span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called when an exception occurs in processing a client message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        LogUtil.error(<span class="string">&quot;server exceptionCaught&quot;</span>);</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Server receive message: [&#123;&#125;]&quot;</span>, rpcData);</span><br><span class="line">        <span class="type">RpcData</span> <span class="variable">rpcMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcData</span>();</span><br><span class="line">        setupRpcMessage(rpcMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rpcData.isHeatBeatRequest()) &#123;</span><br><span class="line">            handleHeartbeat(rpcMessage);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleRpcRequest(ctx, rpcData, rpcMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.writeAndFlush(rpcMessage).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupRpcMessage</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setSerializeMethodCodec(SerializationTypeEnum.HESSIAN.getCode());</span><br><span class="line">        rpcMessage.setCompressType(CompressTypeEnum.GZIP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleHeartbeat</span><span class="params">(RpcData rpcMessage)</span> &#123;</span><br><span class="line">        rpcMessage.setMessageType(RpcConstants.HEARTBEAT_RESPONSE_TYPE);</span><br><span class="line">        rpcMessage.setData(RpcConstants.PONG);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRpcRequest</span><span class="params">(ChannelHandlerContext ctx, RpcData rpcData, RpcData rpcMessage)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RpcRequest</span> <span class="variable">rpcRequest</span> <span class="operator">=</span> (RpcRequest)rpcData.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// invoke target method</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> rpcRequestHandler.handle(rpcRequest);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;Server get result: &#123;&#125;&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">        rpcMessage.setMessageType(RpcConstants.RESPONSE_TYPE);</span><br><span class="line">        buildAndSetRpcResponse(ctx, rpcRequest, rpcMessage, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span></span><br><span class="line">        <span class="title function_">buildAndSetRpcResponse</span><span class="params">(ChannelHandlerContext ctx, RpcRequest rpcRequest, RpcData rpcMessage, Object result)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (canBuildResponse(ctx)) &#123;</span><br><span class="line">            <span class="comment">// If the channel is active and writable, a successful RPC response is constructed</span></span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = RpcResponse.success(result, rpcRequest.getTraceId());</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Construct a failed RPC response if the channel is not writable</span></span><br><span class="line">            RpcResponse&lt;Object&gt; rpcResponse = RpcResponse.fail();</span><br><span class="line">            rpcMessage.setData(rpcResponse);</span><br><span class="line">            LogUtil.error(<span class="string">&quot;Not writable now, message dropped,message:&#123;&#125;&quot;</span>, rpcRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canBuildResponse</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.channel().isActive() &amp;&amp; ctx.channel().isWritable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tipp:  æ³¨å†Œåˆ°zkåç¼“å­˜çš„æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥åŸºäºåŠ¨æ€ä»£ç†è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcRequestHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcRequestHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Processing rpcRequest: call the corresponding method, and then return the</span></span><br><span class="line"><span class="comment">     * method</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">handle</span><span class="params">(RpcRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">service</span> <span class="operator">=</span> adapter.getService(request.fetchRpcServiceName());</span><br><span class="line">        <span class="keyword">return</span> invoke(request, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get method execution results</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcRequest client request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> service service object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the result of the target method execution</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">invoke</span><span class="params">(RpcRequest rpcRequest, Object service)</span> &#123;</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> service.getClass().getMethod(rpcRequest.getMethodName(), rpcRequest.getParamTypes());</span><br><span class="line">            result = method.invoke(service, rpcRequest.getParameters());</span><br><span class="line">            LogUtil.info(<span class="string">&quot;service:[&#123;&#125;] successful invoke method:[&#123;&#125;]&quot;</span>, rpcRequest.getServiceName(),</span><br><span class="line">                rpcRequest.getMethodName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalArgumentException | InvocationTargetException</span><br><span class="line">            | IllegalAccessException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when invoke target method,error:&#123;&#125;,RpcRequest:&#123;&#125;&quot;</span>, e, rpcRequest);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.SERVICE_INVOCATION_FAILURE.getCode(), RpcErrorMessageEnum.SERVICE_INVOCATION_FAILURE.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œä¸€ä¸ªæœåŠ¡ç«¯çš„ä»£ç å°±å®Œæˆäº†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/22/rpc/spring_rpc_I/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/22/rpc/spring_rpc_I/" class="post-title-link" itemprop="url">åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-22 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-22T00:00:00+02:00">2023-05-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/22/rpc/spring_rpc_I/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/22/rpc/spring_rpc_I/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€"><a href="#åŸºäºspringBoot-æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶-ä¸€" class="headerlink" title="åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)"></a>åŸºäºspringBoot,æ‰‹å†™ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶(ä¸€)</h1><hr>
<p> Code:pjpjsocute/rpc-service: personal rcp attempt (github.com)<br> æŠ€æœ¯æ ˆä½¿ç”¨åŒ…æ‹¬ï¼šspringboot,Zookeeper,netty,java spi</p>
<hr>
<h2 id="RPCå®šä¹‰"><a href="#RPCå®šä¹‰" class="headerlink" title="RPCå®šä¹‰"></a>RPCå®šä¹‰</h2><p>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRemote Procedure Callï¼‰æ˜¯ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œå…è®¸ä¸åŒçš„æœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡å’Œäº¤äº’ã€‚</p>
<p>é€šè¿‡RPCï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥å‘å¦ä¸€ä¸ªæœåŠ¡å‘èµ·è¯·æ±‚å¹¶è·å–å“åº”ï¼Œå°±åƒæœ¬åœ°è°ƒç”¨ä¸€æ ·ï¼Œè€Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨å¤„ç†åº•å±‚çš„ç½‘ç»œé€šä¿¡ç»†èŠ‚ã€‚RPCæ¡†æ¶ä¼šå°è£…åº•å±‚çš„ç½‘ç»œä¼ è¾“ï¼Œå¹¶æä¾›äº†è¿œç¨‹æœåŠ¡æ¥å£çš„å®šä¹‰ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ•°æ®ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="rpcä¸httpè¾¨æï¼š"><a href="#rpcä¸httpè¾¨æï¼š" class="headerlink" title="rpcä¸httpè¾¨æï¼š"></a>rpcä¸httpè¾¨æï¼š</h3><p>â€‹    HTTPæ˜¯ä¸€ç§ç”¨äºä¼ è¾“è¶…æ–‡æœ¬çš„åº”ç”¨å±‚åè®®ï¼Œå®ƒåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚å®ƒåŸºäºè¯·æ±‚-å“åº”æ¨¡å‹ï¼Œå®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›ç›¸åº”çš„HTTPå“åº”ã€‚RPCæ›´ç±»ä¼¼ä¸€ç§æ¶æ„æ€æƒ³ï¼ŒRPCå¯ä»¥ç”¨HTTPå®ç°ï¼ŒTCPå®ç°ã€‚</p>
<h2 id="RPCæµç¨‹"><a href="#RPCæµç¨‹" class="headerlink" title="RPCæµç¨‹"></a>RPCæµç¨‹</h2><p>ä¸€ä¸ªç®€å•çš„RPCæ¶æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/2023/05/22/rpc/spring_rpc_I/image-20230522161808172.png" alt="image-20230522161808172"></p>
<h2 id="å¦‚ä½•å®ç°ï¼š"><a href="#å¦‚ä½•å®ç°ï¼š" class="headerlink" title="å¦‚ä½•å®ç°ï¼š"></a>å¦‚ä½•å®ç°ï¼š</h2><h3 id="ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š"><a href="#ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š" class="headerlink" title="ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š"></a>ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨é“¾è·¯ï¼š</h3><p><img src="/2023/05/22/rpc/spring_rpc_I/image-20230522163034434.png" alt="image-20230522163034434"></p>
<h2 id="åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°"><a href="#åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°" class="headerlink" title="åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°"></a>åŸºäºnettyå’ŒZKçš„æœåŠ¡ç«¯å®ç°</h2><p>æ ¹æ®ä¸Šå›¾ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å®ç°æœåŠ¡æ³¨å†Œã€‚</p>
<h3 id="æœåŠ¡æ³¨å†Œï¼š"><a href="#æœåŠ¡æ³¨å†Œï¼š" class="headerlink" title="æœåŠ¡æ³¨å†Œï¼š"></a>æœåŠ¡æ³¨å†Œï¼š</h3><p>ç›®å‰RPCæ¡†æ¶å¤§éƒ½æ”¯æŒæ³¨è§£çš„æ–¹å¼è¿›è¡Œæ³¨å†Œï¼Œè¿™é‡Œä¹Ÿä½¿ç”¨ç›¸åŒçš„æ–¹å¼ã€‚</p>
<h4 id="å®šä¹‰æ³¨å†Œæ³¨è§£"><a href="#å®šä¹‰æ³¨å†Œæ³¨è§£" class="headerlink" title="å®šä¹‰æ³¨å†Œæ³¨è§£"></a>å®šä¹‰æ³¨å†Œæ³¨è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RpcProvider &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">project</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service version, default value is 1.0</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">version</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">group</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RpcConsumer &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service project, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">project</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service version, default value is 1.0</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">version</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Service group, default value is empty string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">group</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomBeanScannerRegistrar.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SimpleRpcApplication &#123;</span><br><span class="line"></span><br><span class="line">    String[] basePackage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â€‹        è¯¥æ³¨è§£å°†å®šä¹‰æœåŠ¡ç‰ˆæœ¬ï¼Œgroup(åŒºåˆ†åŒååŒé¡¹ç›®çš„ä¸åŒæ¥å£)ï¼Œé¡¹ç›®åï¼Œç”¨äºæœåŠ¡æš´éœ²ã€‚</p>
<p>â€‹        åŒç†ï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ³¨è§£ç”¨äºæ¶ˆè´¹;ä¸€ä¸ªæ³¨è§£å®šä¹‰éœ€è¦æ‰«æçš„åŒ…</p>
<h4 id="åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡"><a href="#åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡" class="headerlink" title="åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡"></a>åœ¨å¯åŠ¨æ—¶æ³¨å†ŒæœåŠ¡</h4><h5 id="é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰-providerçš„æ³¨è§£æ³¨å†Œ"><a href="#é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰-providerçš„æ³¨è§£æ³¨å†Œ" class="headerlink" title="é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰@providerçš„æ³¨è§£æ³¨å†Œ"></a>é¦–å…ˆï¼Œéœ€è¦å°†å¸¦æœ‰@providerçš„æ³¨è§£æ³¨å†Œ</h5><p>è·å–éœ€è¦æ‰«æçš„åŒ…ï¼Œéšåå¸¦æœ‰æ³¨è§£çš„beanè¿›è¡Œæ³¨å†Œè¿›å…¥springå³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomBeanScannerRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_SCAN_PARAM</span> <span class="operator">=</span> <span class="string">&quot;basePackage&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_BEAN_BASE_PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;org.example.ray&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//get the scan annotation and the bean package to be scanned</span></span><br><span class="line">        String[] scanBasePackages = fetchScanBasePackage(importingClassMetadata);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;scanning packages: [&#123;&#125;]&quot;</span>, (Object) scanBasePackages);</span><br><span class="line">        </span><br><span class="line"><span class="comment">//        //scan the package and register the bean</span></span><br><span class="line"><span class="comment">//        RpcBeanScanner rpcConsumerBeanScanner = new RpcBeanScanner(registry, RpcConsumer.class);</span></span><br><span class="line">        <span class="type">RpcBeanScanner</span> <span class="variable">rpcProviderBeanScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcBeanScanner</span>(registry, RpcProvider.class);</span><br><span class="line">        <span class="type">RpcBeanScanner</span> <span class="variable">springBeanScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RpcBeanScanner</span>(registry, Component.class);</span><br><span class="line">        <span class="keyword">if</span> (resourceLoader != <span class="literal">null</span>) &#123;</span><br><span class="line">            springBeanScanner.setResourceLoader(resourceLoader);</span><br><span class="line">            rpcProviderBeanScanner.setResourceLoader(resourceLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rpcServiceCount</span> <span class="operator">=</span> rpcProviderBeanScanner.scan(scanBasePackages);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;rpcServiceScanneræ‰«æçš„æ•°é‡ [&#123;&#125;]&quot;</span>, rpcServiceCount);</span><br><span class="line">        LogUtil.info(<span class="string">&quot;scanning RpcConsumer annotated beans end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String[] fetchScanBasePackage(AnnotationMetadata importingClassMetadata)&#123;</span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">annotationAttributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(SimpleRpcApplication.class.getName()));</span><br><span class="line">        String[] scanBasePackages = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (annotationAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">            scanBasePackages = annotationAttributes.getStringArray(API_SCAN_PARAM);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//user doesn&#x27;t specify the package to scan,use the Application base package</span></span><br><span class="line">        <span class="keyword">if</span> (scanBasePackages.length == <span class="number">0</span>) &#123;</span><br><span class="line">            scanBasePackages = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;((org.springframework.core.type.StandardAnnotationMetadata) importingClassMetadata).getIntrospectedClass().getPackage().getName()&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scanBasePackages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ"><a href="#åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ" class="headerlink" title="åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ"></a>åœ¨beanåˆå§‹åŒ–ä¹‹å‰å°†æœåŠ¡å’Œç›¸å…³çš„é…ç½®è¿›è¡Œæ³¨å†Œï¼Œç¡®ä¿springå¯åŠ¨åæœåŠ¡å·²ç»æ³¨å†ŒæˆåŠŸ</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcServiceRegistryAdapter adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RpcSendingServiceAdapter  sendingServiceAdapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RpcBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.adapter = SingletonFactory.getInstance(RpcServiceRegistryAdapterImpl.class);;</span><br><span class="line">        <span class="built_in">this</span>.sendingServiceAdapter = ExtensionLoader.getExtensionLoader(RpcSendingServiceAdapter.class)</span><br><span class="line">            .getExtension(RpcRequestSendingEnum.NETTY.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * register service</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        LogUtil.info(<span class="string">&quot;start process register service: &#123;&#125;&quot;</span>, bean);</span><br><span class="line">        <span class="comment">// register service</span></span><br><span class="line">        <span class="keyword">if</span> (bean.getClass().isAnnotationPresent(RpcProvider.class)) &#123;</span><br><span class="line">            <span class="type">RpcProvider</span> <span class="variable">annotation</span> <span class="operator">=</span> bean.getClass().getAnnotation(RpcProvider.class);</span><br><span class="line">            <span class="comment">// build rpc service config</span></span><br><span class="line">            <span class="type">RpcServiceConfig</span> <span class="variable">serviceConfig</span> <span class="operator">=</span> RpcServiceConfig.builder()</span><br><span class="line">                .service(bean)</span><br><span class="line">                .project(annotation.project())</span><br><span class="line">                .version(annotation.version())</span><br><span class="line">                .group(annotation.group())</span><br><span class="line">                .build();</span><br><span class="line">            LogUtil.info(<span class="string">&quot;register service: &#123;&#125;&quot;</span>, serviceConfig);</span><br><span class="line">            adapter.registryService(serviceConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•"><a href="#å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•" class="headerlink" title="å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•"></a>å®ç°æœåŠ¡æ³¨å†Œçš„å…·ä½“æ–¹æ³•</h5><p>æ³¨å†Œä¸€ä¸ªæœåŠ¡ï¼Œè‡³å°‘åº”è¯¥å§åŒ…æ‹¬:æœåŠ¡æä¾›è€…(ip)ï¼ŒæœåŠ¡åï¼Œä»¥åŠ@RpcProvider ä¸­çš„å˜é‡ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ªRpcServiceConfig.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceConfig</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * service version</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * target service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * belong to which project</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">project</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * group</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span>   <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * generate service name,use to distinguish different service,and * can be split to get the service name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">fetchRpcServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getProject() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getGroup() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getServiceName() + <span class="string">&quot;*&quot;</span> + <span class="built_in">this</span>.getVersion();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * get the interface name</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServiceName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.service.getClass().getInterfaces()[<span class="number">0</span>].getCanonicalName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æä¾›2ä¸ªæ–¹æ³•ï¼Œæ³¨å†ŒæœåŠ¡ä¸æ ¹æ®æœåŠ¡åå¾—åˆ°å¯¹åº”çš„bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RpcServiceRegistryAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcServiceConfig rpc service related attributes</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">registryService</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcClassName rpc class name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> service object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getService</span><span class="params">(String rpcClassName)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨å†Œæµç¨‹å¯ä»¥åˆ†ä¸º3æ­¥ï¼Œç”Ÿæˆåœ°å€-&gt;æœåŠ¡æ³¨å†Œè¿›å…¥Zookeeper-&gt;æ³¨å†Œè¿›å…¥ç¼“å­˜ã€‚è¿™é‡Œä½¿ç”¨ä¸€ä¸ªConcurrentHashMapæ¥è¿›è¡Œç¼“å­˜æœåŠ¡(æ–¹æ³•ä¸­æœ€åè°ƒç”¨äº†zookeeperçš„apiè¿›è¡Œæ³¨å†Œï¼Œå› ä¸ºä¸RPCå…³è”ä¸å¤§ï¼Œæ‰€ä»¥ç•¥è¿‡ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒæºç )ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RpcServiceRegistryAdapterImpl</span> <span class="keyword">implements</span> <span class="title class_">RpcServiceRegistryAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cache map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; serviceMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registryService</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// first get address and service</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">hostAddress</span> <span class="operator">=</span> InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">            <span class="comment">// add service to zk</span></span><br><span class="line">            LogUtil.info(<span class="string">&quot;add service to zk,service name&#123;&#125;,host:&#123;&#125;&quot;</span>, rpcServiceConfig.fetchRpcServiceName(),hostAddress);</span><br><span class="line">            registerServiceToZk(rpcServiceConfig.fetchRpcServiceName(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(hostAddress, PropertiesFileUtil.readPortFromProperties()));</span><br><span class="line">            <span class="comment">// add service to map cache</span></span><br><span class="line">            registerServiceToMap(rpcServiceConfig);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">            LogUtil.error(<span class="string">&quot;occur exception when getHostAddress&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getService</span><span class="params">(String rpcServiceName)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">service</span> <span class="operator">=</span> serviceMap.get(rpcServiceName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == service) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RpcException</span>(RpcErrorMessageEnum.SERVICE_CAN_NOT_BE_FOUND.getCode(),<span class="string">&quot;service not found&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServiceToZk</span><span class="params">(String rpcServiceName, InetSocketAddress inetSocketAddress)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">servicePath</span> <span class="operator">=</span> CuratorClient.ZK_REGISTER_ROOT_PATH + <span class="string">&quot;/&quot;</span> + rpcServiceName + inetSocketAddress.toString();</span><br><span class="line">        <span class="type">CuratorFramework</span> <span class="variable">zkClient</span> <span class="operator">=</span> CuratorClient.getZkClient();</span><br><span class="line">        CuratorClient.createPersistentNode(zkClient, servicePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServiceToMap</span><span class="params">(RpcServiceConfig rpcServiceConfig)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">rpcServiceName</span> <span class="operator">=</span> rpcServiceConfig.fetchRpcServiceName();</span><br><span class="line">        <span class="keyword">if</span> (serviceMap.containsKey(rpcServiceName)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        serviceMap.put(rpcServiceName, rpcServiceConfig.getService());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â€‹    åˆ°è¿™é‡Œï¼Œä¸€ä¸ªæœåŠ¡çš„æ³¨å†Œæµç¨‹å·²ç»å®Œæˆã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/21/LeetCode/LeetCode-005/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/21/LeetCode/LeetCode-005/" class="post-title-link" itemprop="url">LeetCode-005,å¦‚ä½•ä¸€æ­¥æ­¥æ€è€ƒåˆ°åŠ¨æ€è§„åˆ’</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-21 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-21T00:00:00+02:00">2023-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-05-22 00:00:00" itemprop="dateModified" datetime="2023-05-22T00:00:00+02:00">2023-05-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/21/LeetCode/LeetCode-005/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/21/LeetCode/LeetCode-005/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸² <code>s</code>ï¼Œæ‰¾åˆ° <code>s</code> ä¸­æœ€é•¿çš„å›æ–‡å­ä¸²ã€‚</p>
<p>å¦‚æœå­—ç¬¦ä¸²çš„ååºä¸åŸå§‹å­—ç¬¦ä¸²ç›¸åŒï¼Œåˆ™è¯¥å­—ç¬¦ä¸²ç§°ä¸ºå›æ–‡å­—ç¬¦ä¸²ã€‚</p>
<h3 id="Input"><a href="#Input" class="headerlink" title="Input:"></a>Input:</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šs = &quot;babad&quot;</span><br><span class="line">è¾“å‡ºï¼š&quot;bab&quot;</span><br><span class="line">è§£é‡Šï¼š&quot;aba&quot; åŒæ ·æ˜¯ç¬¦åˆé¢˜æ„çš„ç­”æ¡ˆã€‚</span><br></pre></td></tr></table></figure>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution:"></a>Solution:</h3><p>å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åšç±»ä¼¼çš„é¢˜ç›®ï¼Œå…¶å®ä¸€ä¸‹å­æ˜¯å¹¶ä¸å®¹æ˜“æƒ³åˆ°å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’ã€‚</p>
<p>ä½†æ˜¯ï¼Œé€šè¿‡ä¸€æ­¥æ­¥çš„æ€è€ƒå’Œä¼˜åŒ–ï¼Œä½¿ç”¨åŠ¨æ€è§„åˆ’å…¶å®æ˜¯ä¸€ç§æ¯”è¾ƒè‡ªç„¶çš„æƒ³æ³•ã€‚</p>
<h5 id="é¦–å…ˆï¼š"><a href="#é¦–å…ˆï¼š" class="headerlink" title="é¦–å…ˆï¼š"></a>é¦–å…ˆï¼š</h5><h5 id="æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š"><a href="#æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š" class="headerlink" title="æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š"></a>æ ¹æ®é¢˜ç›®çš„è¦æ±‚ï¼Œä¸€ç§æœ€ç®€å•çš„åšæ³•åº”è¯¥æ˜¯ï¼š</h5><ol>
<li><p>è®¾è®¡ä¸€ä¸ªæ–¹æ³• <code>judgeIsPalindrome</code> ï¼ŒåŸºäºåŒæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ª O(n) çš„åˆ¤æ–­ <code>String(i,j)</code> æ˜¯å¦æ˜¯å›æ–‡ä¸²çš„æ–¹æ³•ã€‚</p>
</li>
<li><p>æšä¸¾æ‰€æœ‰çš„é•¿åº¦ <code>k</code>ï¼Œä»å¤§åˆ°å°åˆ¤æ–­æ‰€æœ‰çš„ <code>String(i, i+k-1)</code>ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å›æ–‡ä¸²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¾—åˆ°é¢˜ç›®è¦æ±‚ã€‚</p>
</li>
</ol>
<p>è¿™ä¸ªåšæ³•å¾ˆç®€å•ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œéœ€è¦æšä¸¾æ‰€æœ‰çš„ <code>k</code>ï¼Œæœ€åçš„æƒ…å†µéœ€è¦æšä¸¾ <code>N</code> ç§ï¼Œè€Œå¯¹æ¯ç§é•¿åº¦ï¼Œæœ€åéœ€è¦è®¡ç®— <code>N</code> æ¬¡æ‰èƒ½å¾—åˆ°ç»“æœã€‚æ‰€ä»¥æ•´ä½“å¤æ‚åº¦å¾ˆé«˜ï¼Œæ— æ³•é€šè¿‡ã€‚éœ€è¦å¯»æ‰¾ä¸€ç§æ›´ä¼˜çš„åšæ³•ã€‚</p>
<h5 id="æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª-kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„-kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º-log-Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚"><a href="#æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª-kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„-kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º-log-Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚" class="headerlink" title="æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª kï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„ kï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º log Nã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚"></a>æ ¹æ®ä»¥ä¸Šçš„æ€è·¯ï¼Œä¸€ç§æƒ³æ³•å°±æ˜¯å¹¶ä¸éœ€è¦æšä¸¾æ¯ä¸€ä¸ª <code>k</code>ï¼Œè€Œæ˜¯æ”¹ä¸ºä½¿ç”¨äºŒåˆ†æ³•æœç´¢æœ€å¤§çš„ <code>k</code>ï¼Œè¿™æ ·å¤æ‚åº¦ä¼šå˜ä¸º <code>log N</code>ã€‚æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±å°è¯•ä¸€ä¸‹è¿™ä¸ªæ€è·¯ã€‚</h5><h5 id="ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚"><a href="#ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚" class="headerlink" title="ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚"></a>ä¸Šé¢è¿™ä¸ªæ€è·¯æ˜¯æœ‰å¯èƒ½é€šè¿‡çš„ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥ä¼˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„åšæ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ¯æ¬¡éƒ½éœ€è¦é‡æ–°åˆ¤æ–­æ–°é•¿åº¦çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ï¼Œè€Œæ²¡æœ‰åˆ©ç”¨åˆ°ä¹‹å‰è®¡ç®—è¿‡çš„ç»“æœã€‚</h5><p>å‡è®¾æˆ‘ä»¬å¯¹ä¸€ä¸ªç‰¹å®šçš„é•¿åº¦ <code>k_i</code>ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† String ä¸­æ‰€æœ‰é•¿åº¦ä¸º <code>k_i</code> çš„å­ä¸²æ˜¯å¦æ˜¯å›æ–‡ä¸²ã€‚é‚£ä¹ˆå½“æˆ‘ä»¬çŸ¥é“ <code>String(i, i+k_i-1)</code> æ˜¯å¦æ˜¯å›æ–‡çš„æ—¶å€™ï¼Œå¯¹äº <code>String(i-1, i+k_i)</code> å…¶å®è¿™ä¸ªç»“æœä¹Ÿæ˜¯å¯ä»¥åœ¨ <code>O(1)</code> çš„æ—¶é—´å†…å¾—åˆ°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dp[i][j] = dp[i+1][j-1] ^ String[i] == String[j]</span><br></pre></td></tr></table></figure>
<p>å³åªæœ‰ <code>String(i, i+k_i-1)</code> æ˜¯å›æ–‡å¹¶ä¸” <code>String[i] == String[j]</code>ï¼Œé‚£ä¹ˆ <code>String(i-1, i+k_i)</code> æ‰èƒ½æ˜¯å›æ–‡ä¸²ã€‚</p>
<p>ä¸‹é¢å¯ä»¥å†™å‡º DP ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">longestPalindrome</span><span class="params">(String s)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">boolean</span>[][] dp = <span class="keyword">new</span> <span class="title class_">boolean</span>[len][len];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        dp[i][i] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">maxLen</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> j - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) == s.charAt(j)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j - i &lt; <span class="number">3</span>) &#123;</span><br><span class="line">                    dp[i][j] = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dp[i][j] = dp[i + <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dp[i][j]) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">curLen</span> <span class="operator">=</span> j - i + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (curLen &gt; maxLen) &#123;</span><br><span class="line">                    maxLen = curLen;</span><br><span class="line">                    start = i;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.substring(start, start + maxLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/" class="post-title-link" itemprop="url">æ ‘çŠ¶æ•°ç»„</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-15 11:30:14 / ä¿®æ”¹æ—¶é—´ï¼š17:42:56" itemprop="dateCreated datePublished" datetime="2023-05-15T11:30:14+02:00">2023-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨"><a href="#æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨" class="headerlink" title="æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨"></a>æ ‘çŠ¶æ•°ç»„ä¸åŠ›æ‰£ä¸­çš„åº”ç”¨</h2><h3 id="ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„"><a href="#ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„"></a>ä¸ºä»€ä¹ˆä¼šéœ€è¦æ ‘çŠ¶æ•°ç»„</h3><h4 id="æ€è€ƒä»¥ä¸‹é—®é¢˜"><a href="#æ€è€ƒä»¥ä¸‹é—®é¢˜" class="headerlink" title="æ€è€ƒä»¥ä¸‹é—®é¢˜"></a>æ€è€ƒä»¥ä¸‹é—®é¢˜</h4><p><strong>QA</strong>:<br>å‡è®¾å­˜åœ¨ä¸€ä¸ªæ•´æ•°åºåˆ— inputï¼Œä¾‹å¦‚ <code>intput = [1,2,7,4,3]</code>ï¼Œè¦æ±‚å‰ K ä¸ªæ•°çš„å’Œã€‚</p>
<p><strong>Solution</strong>:<br>ä¸€èˆ¬æˆ‘ä»¬ä¼šæ±‚ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ <code>preSumArray</code>ï¼Œå…¶ä¸­ <code>preSumArray[i]</code> ä»£è¡¨å‰ <code>i</code> ä¸ªæ•°çš„å’Œã€‚<br>è¿™æ ·æˆ‘ä»¬æ±‚å‰ N ä¸ªæ•°çš„å’Œåªéœ€è¦è¿”å› <code>preSumArray[N]</code>ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚å¦‚æœéœ€è¦æŸ¥è¯¢ K æ¬¡ï¼Œåˆ™å¤æ‚åº¦ä¸º O(K)ã€‚</p>
<h4 id="å‡çº§è¿™ä¸ªé—®é¢˜"><a href="#å‡çº§è¿™ä¸ªé—®é¢˜" class="headerlink" title="å‡çº§è¿™ä¸ªé—®é¢˜"></a>å‡çº§è¿™ä¸ªé—®é¢˜</h4><p><strong>QA</strong>:<br>å‡è®¾å­˜åœ¨ä¸€ä¸ªæ•´æ•°åºåˆ— inputï¼Œä¾‹å¦‚ <code>intput = [1,2,7,4,3]</code>ï¼Œç°åœ¨åœ¨æˆ‘ä»¬è·å–å‰ N ä¸ªæ•°çš„å’Œæ—¶ï¼Œå¯èƒ½ä¼šå…ˆå°† <code>i</code> ä½ç½®çš„æ•°å¢åŠ /å‡å°‘ <code>value</code>ã€‚</p>
<p><strong>Solution</strong>:<br>ä¸€èˆ¬æˆ‘ä»¬ä¼šæ±‚ä¸€ä¸ªå‰ç¼€å’Œæ•°ç»„ <code>preSumArray</code>ï¼Œå…¶ä¸­ <code>preSumArray[i]</code> ä»£è¡¨å‰ <code>i</code> ä¸ªæ•°çš„å’Œã€‚<br>ä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ç¬¬ <code>i</code> ä½ç½®æ’å…¥ä¸€ä¸ªæ•° <code>x</code>ï¼Œåœ¨è¿›è¡Œæ›´æ–°æ—¶éœ€è¦æ›´æ–° <code>i</code> ä¹‹åçš„æ‰€æœ‰ <code>preSumArray</code>ã€‚<br>æ­¤æ—¶å•æ¬¡çš„æ›´æ–°æ—¶é—´ä¸º O(N)ï¼ŒK æ¬¡æŸ¥è¯¢çš„å¤æ‚åº¦ä¸º O(KN)ã€‚<br>å¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ <code>preSumArray</code>ï¼Œé‚£ä¹ˆæ›´æ–°å¤æ‚åº¦ä¸º O(1)ï¼ŒæŸ¥è¯¢å¤æ‚åº¦ä¼šå˜ä¸º O(N)ã€‚</p>
<p><strong>è¿™æ—¶æ ‘çŠ¶æ•°ç»„å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè§£å†³è¿™ä¸ªé—®é¢˜</strong></p>
<hr>
<h4 id="å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨"><a href="#å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨" class="headerlink" title="å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨"></a>å‰ç½®çŸ¥è¯†â€”â€”äºŒè¿›åˆ¶çš„åº”ç”¨</h4><p>äºŒè¿›åˆ¶æœ‰å¾ˆå¤šæœ‰è¶£çš„åº”ç”¨ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸ªç”¨æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lowbit(x) = x &amp; (-x)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¼å­çš„ç›®çš„æ˜¯ <strong>æ±‚å‡ºèƒ½æ•´é™¤ x çš„æœ€å¤§ 2 æ¬¡å¹‚ï¼Œä¹Ÿå°±æ˜¯ x æœ€å³è¾¹çš„ 1</strong>ã€‚</p>
<p>ä¾‹å­ï¼š</p>
<ul>
<li><code>5 &amp; -5 = 1</code></li>
<li><code>10 &amp; -10 = 2</code></li>
<li><code>12 &amp; -12 = 4</code></li>
</ul>
<hr>
<h4 id="æ ‘çŠ¶æ•°ç»„ï¼ˆBinary-Indexed-Tree-BITï¼‰"><a href="#æ ‘çŠ¶æ•°ç»„ï¼ˆBinary-Indexed-Tree-BITï¼‰" class="headerlink" title="æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, BITï¼‰"></a>æ ‘çŠ¶æ•°ç»„ï¼ˆBinary Indexed Tree, BITï¼‰</h4><h5 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h5><p>æœ¬è´¨ä¸Šå®ƒä»æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸ <code>preSumArray</code> ç›¸ä¼¼ï¼Œå­˜çš„ä¾æ—§æ˜¯å’Œæ•°ç»„ï¼Œä½†æ˜¯å®ƒå­˜æ”¾çš„æ˜¯ <strong>i ä½ä¹‹å‰ (åŒ…æ‹¬ i)ï¼Œlowbit(i) ä¸ªæ•´æ•°çš„å’Œ</strong>ã€‚</p>
<p><img src="/2023/05/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/bit/WX20230515-152510@2x.png" alt="WX20230515-152510@2x"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">B(1) = A(1);</span><br><span class="line">B(2) = A(1)+A(2);</span><br><span class="line">B(3) = A(3);</span><br><span class="line">B(4) = A(1)+A(2)+A(3)+A(4);</span><br><span class="line">B(5) = A(5);</span><br><span class="line">B(6) = A(5)+A(6);</span><br><span class="line">B(7) = A(7);</span><br><span class="line">B(8) = A(1)+A(2)+A(3)+A(4)+A(5)+A(6)+A(7)+A(8);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>tip: æ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡å¿…é¡»ä» 1 å¼€å§‹</p>
</blockquote>
<hr>
<h5 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h5><p>æ ‘çŠ¶æ•°ç»„ä¸»è¦è§£å†³ä¸¤ä¸ªæ“ä½œï¼š<strong>æ±‚å’Œ</strong> ä¸ <strong>æ›´æ–°</strong>ã€‚</p>
<h6 id="æ±‚å’Œ"><a href="#æ±‚å’Œ" class="headerlink" title="æ±‚å’Œ"></a>æ±‚å’Œ</h6><p>ä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getSum(7) = A(1)+...+A(7) = B(4)+B(6)+B(7)</span><br><span class="line">getSum(6) = B(4)+B(6)</span><br></pre></td></tr></table></figure>
<p>å®ç°ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &gt; <span class="number">0</span>; i -= lowbit(i)) &#123;</span><br><span class="line">        res += bit[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€’å½’å½¢å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bit[x] + getSum(x - lowbit(x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤æ‚åº¦ï¼šO(logN)  </p>
<p>å¦‚æœè¦æ±‚ <code>sum(i,j)</code>ï¼Œåªéœ€è¦ <code>getSum(j) - getSum(i-1)</code>ã€‚</p>
<hr>
<h6 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h6><p>ä¾‹å­ï¼š<code>update(6,7)</code>ï¼Œå³åœ¨ä½ç½® 6 åŠ ä¸Š 7ï¼Œéœ€è¦æ›´æ–° <code>B(6)</code> å’Œ <code>B(8)</code>ã€‚</p>
<p>å®ç°ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &lt; bit.length; i += lowbit(i)) &#123;</span><br><span class="line">        bit[i] += value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="åŠ›æ‰£ä¸­çš„åº”ç”¨"><a href="#åŠ›æ‰£ä¸­çš„åº”ç”¨" class="headerlink" title="åŠ›æ‰£ä¸­çš„åº”ç”¨"></a>åŠ›æ‰£ä¸­çš„åº”ç”¨</h3><h4 id="LeetCode-493"><a href="#LeetCode-493" class="headerlink" title="LeetCode-493"></a>LeetCode-493</h4><p><strong>QA</strong>:<br>ç»™å®šä¸€ä¸ªæ•°ç»„ <code>nums</code> ï¼Œå¦‚æœ <code>i &lt; j</code> ä¸” <code>nums[i] &gt; 2*nums[j]</code> æˆ‘ä»¬å°±å°† <code>(i, j)</code> ç§°ä½œä¸€ä¸ª <strong>é‡è¦ç¿»è½¬å¯¹</strong>ã€‚<br>è¿”å›ç»™å®šæ•°ç»„ä¸­çš„é‡è¦ç¿»è½¬å¯¹çš„æ•°é‡ã€‚</p>
<p><strong>Input:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: [1,3,2,3,1]</span><br><span class="line">è¾“å‡º: 2</span><br></pre></td></tr></table></figure>
<p><strong>Solution</strong>:</p>
<p>é¢˜ç›®å¯ä»¥è½¬æ¢ä¸ºæ±‚ <strong>åœ¨ j å…ƒç´ å·¦è¾¹æ¯”å®ƒ 2 å€å¤§çš„å…ƒç´ æœ‰å‡ ä¸ª</strong>ï¼Œå¹¶æ±‚å’Œã€‚</p>
<ol>
<li>å°†æ•°ç»„æ’åºå¹¶ç¦»æ•£åŒ–æ˜ å°„ä¸º 1-n çš„æœ‰åºåºåˆ—ã€‚</li>
<li>ç»Ÿè®¡æ¯ä¸ªæ•°çš„å‡ºç°æ¬¡æ•°ã€‚</li>
<li>æ±‚å‰ç¼€å’Œï¼Œå¾—åˆ°æ˜ å°„åçš„ä¸ªæ•°ã€‚</li>
</ol>
<p><strong>Code</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">TrieArr</span> &#123;</span><br><span class="line">        <span class="type">long</span>[] arr;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TrieArr</span><span class="params">(<span class="type">int</span> n)</span> &#123; arr = <span class="keyword">new</span> <span class="title class_">long</span>[n]; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lowbit</span><span class="params">(<span class="type">int</span> x)</span> &#123; <span class="keyword">return</span> x &amp; -x; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSum</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(x &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">int</span>)(arr[x] + getSum(x - lowbit(x)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> c)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> x; i &lt; arr.length; i += lowbit(i)) arr[i] += c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">reversePairs</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        Map&lt;Long,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        TreeSet&lt;Long&gt; set = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i: nums) &#123;</span><br><span class="line">            set.add((<span class="type">long</span>)i);</span><br><span class="line">            set.add((<span class="type">long</span>)i * <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(!set.isEmpty()) &#123;</span><br><span class="line">            map.put(set.pollFirst(), index++);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TrieArr</span> <span class="variable">bit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrieArr</span>(map.size()+<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">target</span> <span class="operator">=</span> (<span class="type">long</span>)nums[i] * <span class="number">2</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> map.get(target);</span><br><span class="line">            ans += bit.getSum(map.size()) - bit.getSum(l);</span><br><span class="line">            bit.update(map.get((<span class="type">long</span>)nums[i]), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ç±»ä¼¼é—®é¢˜"><a href="#ç±»ä¼¼é—®é¢˜" class="headerlink" title="ç±»ä¼¼é—®é¢˜"></a>ç±»ä¼¼é—®é¢˜</h4><ul>
<li>LeetCode-307 ç­‰</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/13/LeetCode/LeetCode-813/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/13/LeetCode/LeetCode-813/" class="post-title-link" itemprop="url">ä»¥LeetCode_813ä¸ºä¾‹,ä»é€’å½’åˆ°è®°å¿†åŒ–é€’å½’åˆ°DP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-13 10:14:10" itemprop="dateCreated datePublished" datetime="2023-05-13T10:14:10+02:00">2023-05-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-05-12 18:34:45" itemprop="dateModified" datetime="2023-05-12T18:34:45+02:00">2023-05-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/13/LeetCode/LeetCode-813/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/13/LeetCode/LeetCode-813/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™å®šæ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ã€‚æˆ‘ä»¬å°†ç»™å®šçš„æ•°ç»„ <code>nums</code> åˆ†æˆ <strong>æœ€å¤š</strong> <code>k</code> ä¸ªç›¸é‚»çš„éç©ºå­æ•°ç»„ ã€‚ <strong>åˆ†æ•°</strong> ç”±æ¯ä¸ªå­æ•°ç»„å†…çš„å¹³å‡å€¼çš„æ€»å’Œæ„æˆã€‚</p>
<p>æ³¨æ„æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>nums</code> æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”åˆ†æ•°ä¸ä¸€å®šéœ€è¦æ˜¯æ•´æ•°ã€‚</p>
<p>è¿”å›æˆ‘ä»¬æ‰€èƒ½å¾—åˆ°çš„æœ€å¤§ <strong>åˆ†æ•°</strong> æ˜¯å¤šå°‘ã€‚ç­”æ¡ˆè¯¯å·®åœ¨ <code>10-6</code> å†…è¢«è§†ä¸ºæ˜¯æ­£ç¡®çš„ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/05/13/LeetCode/LeetCode-813/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-381/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/12/LeetCode/LeetCode-381/" class="post-title-link" itemprop="url">LeetCode-862</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-12 11:14:10 / ä¿®æ”¹æ—¶é—´ï¼š18:30:33" itemprop="dateCreated datePublished" datetime="2023-05-12T11:14:10+02:00">2023-05-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/12/LeetCode/LeetCode-381/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/12/LeetCode/LeetCode-381/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p><code>RandomizedCollection</code> æ˜¯ä¸€ç§åŒ…å«æ•°å­—é›†åˆ(å¯èƒ½æ˜¯é‡å¤çš„)çš„æ•°æ®ç»“æ„ã€‚å®ƒåº”è¯¥æ”¯æŒæ’å…¥å’Œåˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä»¥åŠåˆ é™¤éšæœºå…ƒç´ ã€‚</p>
<p>å®ç° <code>RandomizedCollection</code> ç±»:</p>
<ul>
<li><code>RandomizedCollection()</code>åˆå§‹åŒ–ç©ºçš„ <code>RandomizedCollection</code> å¯¹è±¡ã€‚</li>
<li><code>bool insert(int val)</code> å°†ä¸€ä¸ª <code>val</code> é¡¹æ’å…¥åˆ°é›†åˆä¸­ï¼Œå³ä½¿è¯¥é¡¹å·²ç»å­˜åœ¨ã€‚å¦‚æœè¯¥é¡¹ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code>true</code> ï¼Œå¦åˆ™è¿”å› <code>false</code> ã€‚</li>
<li><code>bool remove(int val)</code> å¦‚æœå­˜åœ¨ï¼Œä»é›†åˆä¸­ç§»é™¤ä¸€ä¸ª <code>val</code> é¡¹ã€‚å¦‚æœè¯¥é¡¹å­˜åœ¨ï¼Œåˆ™è¿”å› <code>true</code> ï¼Œå¦åˆ™è¿”å› <code>false</code> ã€‚æ³¨æ„ï¼Œå¦‚æœ <code>val</code> åœ¨é›†åˆä¸­å‡ºç°å¤šæ¬¡ï¼Œæˆ‘ä»¬åªåˆ é™¤å…¶ä¸­ä¸€ä¸ªã€‚</li>
<li><code>int getRandom()</code> ä»å½“å‰çš„å¤šä¸ªå…ƒç´ é›†åˆä¸­è¿”å›ä¸€ä¸ªéšæœºå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´ è¢«è¿”å›çš„æ¦‚ç‡ä¸é›†åˆä¸­åŒ…å«çš„ç›¸åŒå€¼çš„æ•°é‡ <strong>çº¿æ€§ç›¸å…³</strong> ã€‚</li>
</ul>
<p>æ‚¨å¿…é¡»å®ç°ç±»çš„å‡½æ•°ï¼Œä½¿æ¯ä¸ªå‡½æ•°çš„ <strong>å¹³å‡</strong> æ—¶é—´å¤æ‚åº¦ä¸º <code>O(1)</code> ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong>ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œåªæœ‰åœ¨ <code>RandomizedCollection</code> ä¸­ <strong>è‡³å°‘æœ‰ä¸€é¡¹</strong> æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ <code>getRandom</code> ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/05/12/LeetCode/LeetCode-381/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://pjpjsocute.github.io/2023/05/12/LeetCode/LeetCode-862/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ray zhou">
      <meta itemprop="description" content="My bolg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rayâ€˜s Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/12/LeetCode/LeetCode-862/" class="post-title-link" itemprop="url">LeetCode-862</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2023-05-12 10:14:10 / ä¿®æ”¹æ—¶é—´ï¼š10:26:38" itemprop="dateCreated datePublished" datetime="2023-05-12T10:14:10+02:00">2023-05-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/2023/05/12/LeetCode/LeetCode-862/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/05/12/LeetCode/LeetCode-862/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Q"><a href="#Q" class="headerlink" title="Q:"></a>Q:</h3><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code> å’Œä¸€ä¸ªæ•´æ•° <code>k</code> ï¼Œæ‰¾å‡º <code>nums</code> ä¸­å’Œè‡³å°‘ä¸º <code>k</code> çš„ <strong>æœ€çŸ­éç©ºå­æ•°ç»„</strong> ï¼Œå¹¶è¿”å›è¯¥å­æ•°ç»„çš„é•¿åº¦ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„ <strong>å­æ•°ç»„</strong> ï¼Œè¿”å› <code>-1</code> ã€‚</p>
<p><strong>å­æ•°ç»„</strong> æ˜¯æ•°ç»„ä¸­ <strong>è¿ç»­</strong> çš„ä¸€éƒ¨åˆ†ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/05/12/LeetCode/LeetCode-862/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ray zhou</p>
  <div class="site-description" itemprop="description">My bolg</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ray zhou</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'tHsqv8rp8m3NFxGeqNYcSMkI-MdYXbMMI',
      appKey     : 'Ly0JgGKm82bkdfXMxPbisC2p',
      placeholder: "è¾“å…¥ä½ çš„è¯„è®º\\næ˜µç§°ä¸ºå¿…å¡«é¡¹ç›®",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : 'https://thsqv8rp.api.lncldglobal.com'
    });
  }, window.Valine);
});
</script>

</body>
</html>
